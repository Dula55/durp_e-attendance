<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f1b3d" />
  <title>NSUK URP — E-Attendance</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <!-- Firebase (compat) - optional, only used if you provide FIREBASE_CONFIG below -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root { color-scheme: light; }
    html { scroll-behavior: smooth; }
    .shimmer {
      background: linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.18), rgba(255,255,255,0.05));
      background-size: 200% 100%;
      animation: shimmer 2.2s ease-in-out infinite;
    }
    @keyframes shimmer { 0% { background-position: 0% 0; } 100% { background-position: 200% 0; } }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    @media print { .no-print { display: none !important; } body { background: #fff !important; } }
    .small-muted { font-size: .78rem; color: #6b7280; }
    .note-box { font-size: .82rem; color: #374151; background: #f8fafc; border: 1px solid #e6eef6; padding: .6rem; border-radius: .75rem; }
    .word-break-all { word-break: break-all; }
    .sync-badge { display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px; }
    .cross-device-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
  </style>
</head>

<body class="min-h-screen bg-slate-50 text-slate-900">
  <!-- Header -->
  <header class="no-print">
    <div class="bg-[#0f1b3d] text-white">
      <div class="mx-auto max-w-6xl px-4 py-5 sm:py-6">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div class="flex items-start gap-3">
            <div class="shimmer mt-0.5 h-10 w-10 rounded-xl bg-white/10 ring-1 ring-white/15 flex items-center justify-center">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 2l9 4.5-9 4.5L3 6.5 12 2Z" stroke="rgba(255,255,255,0.95)" stroke-width="1.6" stroke-linejoin="round"/><path d="M6.5 9.2V14c0 2.2 2.5 4 5.5 4s5.5-1.8 5.5-4V9.2" stroke="rgba(255,255,255,0.95)" stroke-width="1.6" stroke-linecap="round"/><path d="M21 6.5v6" stroke="rgba(255,255,255,0.95)" stroke-width="1.6" stroke-linecap="round"/><circle cx="21" cy="13.5" r="1" fill="rgba(255,255,255,0.95)"/></svg>
            </div>
            <div>
              <h1 class="text-base sm:text-lg font-semibold tracking-tight">Department of Urban and Regional Planning</h1>
              <p class="text-sm text-white/80">Nasarawa State University, Keffi (NSUK) — E-Attendance</p>
            </div>
          </div>
          <div class="flex flex-wrap items-center gap-2 sm:gap-3">
            <div id="syncStatus" class="rounded-xl bg-white/10 ring-1 ring-white/15 px-3 py-2">
              <p class="text-xs text-white/70">Sync</p>
              <p id="syncSummary" class="text-sm font-medium">Local</p>
            </div>
            <button id="btnOpenHelp" class="rounded-xl bg-white text-[#0f1b3d] px-3 py-2 text-sm font-semibold hover:bg-white/95">Instructions</button>
            <button id="btnShareAll" class="rounded-xl bg-emerald-500 text-white px-3 py-2 text-sm font-semibold hover:bg-emerald-600">Share All Data</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <nav class="border-b border-slate-200 bg-white">
      <div class="mx-auto max-w-6xl px-4">
        <div class="flex gap-2 py-3" role="tablist">
          <button id="tabStudent" class="rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-slate-900 text-white" role="tab" aria-selected="true">Student Attendance</button>
          <button id="tabLecturer" class="rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-white text-slate-800 hover:bg-slate-50" role="tab" aria-selected="false">Lecturer Dashboard</button>
          <button id="tabAdminLogin" class="rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-white text-slate-800 hover:bg-slate-50 ml-auto">Admin Login</button>
        </div>
      </div>
    </nav>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-6 sm:py-8">
    <!-- Cross-Device Notice -->
    <div class="mb-6 rounded-2xl cross-device-box p-4 shadow-sm">
      <div class="flex items-center gap-3">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
        </svg>
        <div>
          <h3 class="font-semibold">Cross-Device Support Enabled</h3>
          <p class="text-sm text-white/90">PINs and user accounts can be used across devices. Use "Share All Data" button to export/import everything.</p>
        </div>
      </div>
    </div>

    <!-- Student Panel -->
    <section id="panelStudent" role="tabpanel">
      <div class="grid gap-4 lg:grid-cols-12">
        <div class="lg:col-span-8">
          <!-- Student Login/Signup Section -->
          <div id="studentLoginSection" class="rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm mb-4">
            <div class="border-b border-slate-200 px-5 py-4 sm:px-6">
              <h2 class="text-lg font-semibold">Student Login / Signup</h2>
              <p class="mt-1 text-sm text-slate-600">Login or create an account to submit attendance. Accounts work across devices when shared.</p>
            </div>
            <div class="p-5">
              <div class="grid gap-4 sm:grid-cols-2">
                <!-- Login Form -->
                <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
                  <h3 class="text-base font-semibold mb-3">Login</h3>
                  <div class="space-y-3">
                    <div>
                      <label class="block text-sm font-semibold text-slate-800">Matric Number</label>
                      <input id="studentLoginMatric" type="text" class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm" placeholder="e.g., FT26URP1234" />
                    </div>
                    <div>
                      <label class="block text-sm font-semibold text-slate-800">Password</label>
                      <input id="studentLoginPassword" type="password" class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm" />
                    </div>
                    <button id="btnStudentLogin" class="w-full rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">Login</button>
                    <p id="studentLoginMsg" class="text-xs text-center mt-2"></p>
                  </div>
                </div>

                <!-- Signup Form -->
                <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
                  <h3 class="text-base font-semibold mb-3">Signup (First Time)</h3>
                  <div class="space-y-3">
                    <div>
                      <label class="block text-sm font-semibold text-slate-800">Full Name</label>
                      <input id="studentSignupName" type="text" class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm" placeholder="e.g., Abdullahi Suleiman" />
                    </div>
                    <div>
                      <label class="block text-sm font-semibold text-slate-800">Matric Number</label>
                      <input id="studentSignupMatric" type="text" class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm" placeholder="e.g., FT26URP1234" />
                    </div>
                    <div>
                      <label class="block text-sm font-semibold text-slate-800">Password</label>
                      <input id="studentSignupPassword" type="password" class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm" />
                    </div>
                    <button id="btnStudentSignup" class="w-full rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700">Create Account</button>
                    <p id="studentSignupMsg" class="text-xs text-center mt-2"></p>
                  </div>
                </div>
              </div>

              <div class="mt-4 rounded-xl border border-amber-200 bg-amber-50 p-3 text-sm">
                <p><strong>Cross-Device Note:</strong> Student accounts created on one device can be used on another device by exporting/importing all data using the "Share All Data" button in the header.</p>
              </div>

              <!-- Student Accounts Transfer -->
              <div class="mt-4 rounded-2xl border border-slate-200 bg-white p-4">
                <h4 class="text-sm font-semibold mb-2">Transfer Student Accounts to Another Device</h4>
                <div class="flex gap-2">
                  <button id="btnExportStudents" class="rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50">Export Student Accounts</button>
                  <button id="btnImportStudents" class="rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50">Import Student Accounts</button>
                  <button id="btnShareStudentsQr" class="rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50">Share as QR</button>
                </div>
                <input id="importStudentsFile" type="file" accept="application/json" class="hidden" />
              </div>
            </div>
          </div>

          <!-- Student Dashboard (hidden until login) -->
          <div id="studentDashboard" class="hidden">
            <div class="rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm">
              <div class="border-b border-slate-200 px-5 py-4 sm:px-6">
                <div class="flex items-center justify-between">
                  <div>
                    <h2 class="text-lg font-semibold">Student Attendance</h2>
                    <p class="mt-1 text-sm text-slate-600">
                      Welcome, <span id="loggedInStudentName" class="font-semibold"></span> (<span id="loggedInStudentMatric" class="font-semibold"></span>)
                    </p>
                  </div>
                  <button id="btnStudentLogout" class="rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50">Logout</button>
                </div>
              </div>

              <div class="px-5 py-5 sm:px-6">
                <!-- Step 1: Location -->
                <div class="rounded-2xl border border-slate-200 bg-slate-50/70 p-4">
                  <div class="flex items-start justify-between gap-3">
                    <div class="min-w-0">
                      <div class="flex items-center gap-2">
                        <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-[#0f1b3d] text-white text-sm font-bold">1</span>
                        <h3 class="text-base font-semibold">Enable Location</h3>
                      </div>
                      <p class="mt-1 text-sm text-slate-600">We capture latitude and longitude for verification.</p>
                    </div>
                    <div class="flex gap-2 items-center">
                      <button id="btnGetLocation" class="shrink-0 rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">
                        Capture Location
                      </button>
                      <button id="btnToggleManualCoords" class="shrink-0 rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50">
                        Manual coords
                      </button>
                    </div>
                  </div>

                  <div id="manualCoordsPanel" class="mt-3 hidden grid gap-2 sm:grid-cols-3">
                    <div>
                      <label class="text-xs text-slate-500">Latitude (manual)</label>
                      <input id="manualLat" type="text" inputmode="decimal" class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm tabular-nums" placeholder="e.g., 8.524139" />
                    </div>
                    <div>
                      <label class="text-xs text-slate-500">Longitude (manual)</label>
                      <input id="manualLon" type="text" inputmode="decimal" class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm tabular-nums" placeholder="e.g., 7.123456" />
                    </div>
                    <div class="flex items-end">
                      <button id="btnApplyManualCoords" class="w-full rounded-xl bg-emerald-600 px-3 py-2 text-sm font-semibold text-white hover:bg-emerald-700">Apply</button>
                    </div>
                  </div>

                  <div class="mt-3 grid gap-2 sm:grid-cols-3">
                    <div class="rounded-xl bg-white p-3 ring-1 ring-slate-200">
                      <p class="text-xs text-slate-500">Location Status</p>
                      <p id="locStatus" class="mt-1 text-sm font-semibold text-slate-800">Not captured</p>
                    </div>
                    <div class="rounded-xl bg-white p-3 ring-1 ring-slate-200">
                      <p class="text-xs text-slate-500">Latitude</p>
                      <p id="latText" class="mt-1 text-sm font-semibold tabular-nums">—</p>
                    </div>
                    <div class="rounded-xl bg-white p-3 ring-1 ring-slate-200">
                      <p class="text-xs text-slate-500">Longitude</p>
                      <p id="lonText" class="mt-1 text-sm font-semibold tabular-nums">—</p>
                    </div>
                  </div>

                  <div id="locError" class="mt-3 hidden rounded-xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-800"></div>
                  <div class="mt-3 small-muted">If geolocation is not available, use manual coords or Export/Import JSON to move the draft.</div>
                </div>

                <!-- Step 2: Face Capture -->
                <div class="mt-4 rounded-2xl border border-slate-200 bg-slate-50/70 p-4">
                  <div class="flex items-start justify-between gap-3">
                    <div class="min-w-0">
                      <div class="flex items-center gap-2">
                        <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-[#0f1b3d] text-white text-sm font-bold">2</span>
                        <h3 class="text-base font-semibold">Capture Face</h3>
                      </div>
                      <p class="mt-1 text-sm text-slate-600">Use your front camera and capture a clear image. If camera isn't present you may upload a file.</p>
                    </div>
                    <div class="flex gap-2">
                      <button id="btnStartCamera" class="rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50">
                        Start Camera
                      </button>
                      <button id="btnCaptureFace" class="rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Capture
                      </button>
                      <label for="faceFile" class="rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50 cursor-pointer">Upload</label>
                      <input id="faceFile" type="file" accept="image/*" class="hidden" />
                    </div>
                  </div>

                  <div class="mt-4 grid gap-3 sm:grid-cols-2">
                    <div class="rounded-2xl bg-white ring-1 ring-slate-200 overflow-hidden">
                      <div class="border-b border-slate-200 px-3 py-2">
                        <p class="text-xs font-semibold text-slate-600">Live Camera</p>
                      </div>
                      <div class="p-3">
                        <video id="video" class="w-full rounded-xl bg-slate-900/5" autoplay muted playsinline></video>
                        <p id="camHint" class="mt-2 text-xs text-slate-500">Tip: Ensure your face is well-lit and centered.</p>
                        <div id="camError" class="mt-2 hidden rounded-xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-800"></div>
                      </div>
                    </div>

                    <div class="rounded-2xl bg-white ring-1 ring-slate-200 overflow-hidden">
                      <div class="border-b border-slate-200 px-3 py-2 flex items-center justify-between">
                        <p class="text-xs font-semibold text-slate-600">Captured Image</p>
                        <button id="btnRetake" class="text-xs font-semibold text-slate-700 hover:text-slate-900 disabled:opacity-50" disabled>Retake</button>
                      </div>
                      <div class="p-3">
                        <div class="aspect-video w-full rounded-xl bg-slate-900/5 flex items-center justify-center overflow-hidden">
                          <img id="facePreview" alt="Captured face preview" class="hidden h-full w-full object-cover" />
                          <div id="faceEmpty" class="text-sm text-slate-500">No image captured yet</div>
                        </div>
                        <div class="mt-2 grid gap-2 sm:grid-cols-2">
                          <div class="rounded-xl bg-slate-50 ring-1 ring-slate-200 p-3">
                            <p class="text-xs text-slate-500">Face Status</p>
                            <p id="faceStatus" class="mt-1 text-sm font-semibold">Not captured</p>
                          </div>
                          <div class="rounded-xl bg-slate-50 ring-1 ring-slate-200 p-3">
                            <p class="text-xs text-slate-500">Image Quality</p>
                            <p id="faceQuality" class="mt-1 text-sm font-semibold">—</p>
                          </div>
                        </div>
                        <div class="mt-3 small-muted">You may upload an image or import a draft from another device to complete and submit.</div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Step 3: Attendance Form -->
                <div class="mt-4 rounded-2xl border border-slate-200 bg-slate-50/70 p-4">
                  <div class="flex items-start gap-3">
                    <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-[#0f1b3d] text-white text-sm font-bold">3</span>
                    <div>
                      <h3 class="text-base font-semibold">Attendance Form</h3>
                      <p class="mt-1 text-sm text-slate-600">The form unlocks after face capture. Submission requires location + face + course code.</p>
                    </div>
                  </div>

                  <form id="attendanceForm" class="mt-4" autocomplete="on" novalidate>
                    <fieldset id="formFieldset" disabled class="opacity-60">
                      <div class="grid gap-3 sm:grid-cols-2">
                        <div>
                          <label class="block text-sm font-semibold text-slate-800">Name</label>
                          <input id="studentName" name="name" type="text" readonly class="mt-1 w-full rounded-xl border border-slate-300 bg-slate-50 px-3 py-2 text-sm" />
                        </div>
                        <div>
                          <label class="block text-sm font-semibold text-slate-800">Matric Number</label>
                          <input id="matricNo" name="matric" type="text" readonly class="mt-1 w-full rounded-xl border border-slate-300 bg-slate-50 px-3 py-2 text-sm" />
                        </div>
                        <div class="sm:col-span-2">
                          <label for="courseCode" class="block text-sm font-semibold text-slate-800">Course Code <span class="text-rose-600">*</span></label>
                          <input id="courseCode" name="course" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm" placeholder="e.g., URP 111" />
                        </div>
                      </div>

                      <div class="mt-4 grid gap-2 sm:grid-cols-3">
                        <div class="rounded-xl bg-white p-3 ring-1 ring-slate-200">
                          <p class="text-xs text-slate-500">Date</p>
                          <p id="dateText" class="mt-1 text-sm font-semibold">—</p>
                        </div>
                        <div class="rounded-xl bg-white p-3 ring-1 ring-slate-200">
                          <p class="text-xs text-slate-500">Time</p>
                          <p id="timeText" class="mt-1 text-sm font-semibold">—</p>
                        </div>
                        <div class="rounded-xl bg-white p-3 ring-1 ring-slate-200">
                          <p class="text-xs text-slate-500">Verification</p>
                          <p id="verifyText" class="mt-1 text-sm font-semibold">Pending</p>
                        </div>
                      </div>

                      <div class="mt-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                        <div class="text-xs text-slate-600">
                          <span class="font-semibold">Auto-captured:</span> Date/Time, Latitude/Longitude, Face image.
                        </div>
                        <div class="flex gap-2">
                          <button id="btnExportDraft" type="button" class="rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50">Export Draft (JSON)</button>
                          <button id="btnGenerateQr" type="button" class="rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50">Generate QR</button>
                          <button id="btnShareDraft" type="button" class="rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50">Share Draft</button>
                          <button id="btnSubmit" type="submit" class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Submit Attendance
                          </button>
                        </div>
                      </div>
                    </fieldset>

                    <div id="formLockedNote" class="mt-3 rounded-xl border border-slate-200 bg-white p-3 text-sm text-slate-700">
                      <span class="font-semibold">Locked:</span> Start camera and capture face to unlock attendance form.
                    </div>

                    <div class="mt-3 flex gap-2 items-center">
                      <label class="small-muted">Import draft (JSON):</label>
                      <input id="importDraftFile" type="file" accept="application/json" class="ml-2" />
                    </div>

                    <div id="qrPanel" class="mt-3 hidden">
                      <div class="flex gap-3 items-start">
                        <div>
                          <img id="qrImage" alt="QR code" class="rounded-lg ring-1 ring-slate-200" />
                        </div>
                        <div class="flex-1">
                          <p class="text-sm font-semibold">Scan this QR from another device to prefill the attendance form.</p>
                          <p class="small-muted mt-1">If QR fails use JSON export instead.</p>
                          <div id="qrLinkBox" class="mt-2 word-break-all"></div>
                        </div>
                      </div>
                    </div>

                  </form>
                </div>
              </div>
            </div>

            <!-- Student attendance table (local view) -->
            <div class="mt-4 rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm">
              <div class="border-b border-slate-200 px-5 py-4 sm:px-6">
                <h3 class="text-base font-semibold">Your Attendance Records</h3>
                <p class="mt-1 text-sm text-slate-600">This table shows your attendance records stored on this device (and synced ones if Firebase is enabled).</p>
              </div>
              <div class="p-4 overflow-x-auto">
                <table class="min-w-full bg-white">
                  <thead class="bg-slate-50"><tr class="text-left text-xs font-semibold text-slate-600">
                    <th class="px-4 py-3">Course</th>
                    <th class="px-4 py-3">Date & Time</th><th class="px-4 py-3">Lat</th><th class="px-4 py-3">Lon</th>
                  </tr></thead>
                  <tbody id="localRecordsTbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Quick Info -->
        <aside class="lg:col-span-4">
          <div class="rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm">
            <div class="border-b border-slate-200 px-5 py-4 sm:px-6">
              <h3 class="text-base font-semibold">Quick Checklist</h3>
              <p class="mt-1 text-sm text-slate-600">Ensure all items are completed before submitting.</p>
            </div>
            <div class="px-5 py-5 sm:px-6">
              <ul class="space-y-3">
                <li class="flex items-start gap-3">
                  <span id="checkLogin" class="mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg bg-slate-100 text-slate-700 ring-1 ring-slate-200" aria-hidden="true">—</span>
                  <div>
                    <p class="text-sm font-semibold">Logged In</p>
                    <p class="text-xs text-slate-600">Login or create an account first.</p>
                  </div>
                </li>
                <li class="flex items-start gap-3">
                  <span id="checkLoc" class="mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg bg-slate-100 text-slate-700 ring-1 ring-slate-200" aria-hidden="true">—</span>
                  <div>
                    <p class="text-sm font-semibold">Location captured</p>
                    <p class="text-xs text-slate-600">Allow location access when prompted or use manual coords.</p>
                  </div>
                </li>
                <li class="flex items-start gap-3">
                  <span id="checkFace" class="mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg bg-slate-100 text-slate-700 ring-1 ring-slate-200" aria-hidden="true">—</span>
                  <div>
                    <p class="text-sm font-semibold">Face captured</p>
                    <p class="text-xs text-slate-600">Use the front camera; ensure clarity, or upload image file.</p>
                  </div>
                </li>
                <li class="flex items-start gap-3">
                  <span id="checkFields" class="mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg bg-slate-100 text-slate-700 ring-1 ring-slate-200" aria-hidden="true">—</span>
                  <div>
                    <p class="text-sm font-semibold">Course code filled</p>
                    <p class="text-xs text-slate-600">Enter the course code for the attendance.</p>
                  </div>
                </li>
              </ul>

              <div class="mt-5 rounded-2xl border border-slate-200 bg-slate-50 p-4">
                <p class="text-xs font-semibold text-slate-700">Cross-Device Support</p>
                <p class="mt-1 text-xs text-slate-600">Use "Share All Data" to export PIN, admin credentials, student accounts, and attendance records for use on another device.</p>
              </div>

              <div class="mt-4 rounded-2xl border border-slate-200 bg-white p-4">
                <p class="text-xs font-semibold text-slate-700">Support</p>
                <p class="mt-1 text-xs text-slate-600">If location/camera fails, confirm you are on HTTPS and permissions are allowed in your browser.</p>
              </div>
            </div>
          </div>
        </aside>

      </div>
    </section>

    <!-- Lecturer Panel -->
    <section id="panelLecturer" role="tabpanel" class="hidden">
      <div class="grid gap-6 lg:grid-cols-12">
        <div class="lg:col-span-4">
          <div class="rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm">
            <div class="border-b border-slate-200 px-5 py-4 sm:px-6">
              <h2 class="text-lg font-semibold">Lecturer Access</h2>
              <p class="mt-1 text-sm text-slate-600">Enter the PIN shared by Admin. PIN works across devices when shared.</p>
            </div>
            <div class="p-5 space-y-4">
              <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
                <label class="block text-sm font-semibold text-slate-800">Lecturer PIN</label>
                <input id="lecturerPinInput" type="text" inputmode="numeric" class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-lg tracking-widest text-center" placeholder="••••••" maxlength="6" />
                <button id="btnLecturerUnlock" class="mt-3 w-full rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">Unlock Dashboard</button>
                <p id="lecturerPinMsg" class="mt-2 text-xs text-center"></p>
                <div class="mt-3 grid grid-cols-2 gap-2">
                  <label for="importPinFile" class="rounded-xl bg-white px-3 py-2 text-sm text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50 cursor-pointer text-center">Import PIN (file)</label>
                  <button id="btnPastePin" class="rounded-xl bg-white px-3 py-2 text-sm text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50">Paste PIN</button>
                  <input id="importPinFile" type="file" accept="application/json" class="hidden" />
                </div>
                <div class="mt-3 text-center">
                  <button id="btnScanPinQr" class="rounded-xl bg-white px-3 py-2 text-sm text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50">Scan PIN QR</button>
                </div>
              </div>

              <!-- QR Scanner for PIN -->
              <div id="qrScannerPanel" class="hidden rounded-2xl border border-slate-200 bg-slate-50 p-4">
                <h4 class="text-sm font-semibold mb-2">Scan PIN QR Code</h4>
                <video id="qrScanner" class="w-full rounded-xl" autoplay playsinline></video>
                <div class="mt-2 flex gap-2">
                  <button id="btnStartScanner" class="rounded-xl bg-slate-900 px-3 py-2 text-sm font-semibold text-white">Start Scanner</button>
                  <button id="btnStopScanner" class="rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200">Stop</button>
                </div>
                <p id="qrScanResult" class="mt-2 text-xs"></p>
              </div>
            </div>
          </div>
        </div>

        <div class="lg:col-span-8">
          <div id="lecturerLocked" class="rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm p-10 text-center">
            <div class="mx-auto w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mb-4">
              <svg class="w-10 h-10 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
            </div>
            <h3 class="text-lg font-semibold">Dashboard Locked</h3>
            <p class="text-sm text-slate-600 mt-1">Enter the 6-digit PIN to view attendance records.</p>
            <div class="mt-4 text-sm text-slate-500">
              <p>Need the PIN? Ask the Admin to share it via QR code or export file.</p>
            </div>
          </div>

          <div id="lecturerDashboard" class="hidden rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm">
            <div class="border-b border-slate-200 px-5 py-4 sm:px-6">
              <div class="flex items-center justify-between">
                <div>
                  <h2 class="text-lg font-semibold">Attendance Dashboard</h2>
                  <p class="text-sm text-slate-600">View and export records. Records work across devices when shared.</p>
                </div>
                <div class="flex gap-2">
                  <button id="btnDownloadPdf" class="rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white">Download PDF</button>
                  <button id="btnExportRecords" class="rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200">Export Records (JSON)</button>
                  <label for="importRecordsFile" class="rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50 cursor-pointer">Import Records</label>
                  <button id="btnClearData" class="rounded-xl bg-rose-600 px-4 py-2 text-sm font-semibold text-white hover:bg-rose-700">Clear Data</button>
                  <button id="btnLecturerLock" class="rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200">Lock</button>
                  <input id="importRecordsFile" type="file" accept="application/json" class="hidden" />
                </div>
              </div>
            </div>
            <div class="p-5">
              <div class="overflow-x-auto rounded-2xl ring-1 ring-slate-200">
                <table class="min-w-full bg-white">
                  <thead class="bg-slate-50"><tr class="text-left text-xs font-semibold text-slate-600">
                    <th class="px-4 py-3">Name</th><th class="px-4 py-3">Matric</th><th class="px-4 py-3">Course</th>
                    <th class="px-4 py-3">Date & Time</th><th class="px-4 py-3">Lat</th><th class="px-4 py-3">Lon</th><th class="px-4 py-3">Face</th>
                  </tr></thead>
                  <tbody id="recordsTbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Admin Panel -->
    <section id="panelAdmin" role="tabpanel" class="hidden">
      <div class="max-w-md mx-auto">
        <div class="rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm">
          <div class="border-b border-slate-200 px-6 py-5">
            <h2 class="text-lg font-semibold" id="adminTitle">Admin Login</h2>
          </div>
          <div class="p-6 space-y-5">
            <div id="adminLoginForm">
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-semibold text-slate-800">Username</label>
                  <input id="adminUsername" type="text" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="admin" />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-slate-800">Password</label>
                  <input id="adminPassword" type="password" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2" />
                </div>
                <button id="btnAdminLogin" class="w-full rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">Login</button>
                <button id="btnAdminSignup" class="w-full rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50">Create Admin Account (First Time)</button>
              </div>
            </div>

            <div id="adminDashboardSection" class="hidden space-y-5">
              <div class="text-center">
                <p class="text-sm text-emerald-700 font-semibold">Admin logged in</p>
                <button id="btnAdminLogout" class="mt-2 text-xs text-slate-600 underline">Logout</button>
              </div>

              <div class="rounded-2xl border border-amber-200 bg-amber-50 p-4 text-sm">
                <p><strong>Cross-Device Admin Tools:</strong> Generate and share PIN/credentials that work across all devices. Export everything using "Share All Data" button.</p>
              </div>

              <div class="space-y-3">
                <div class="rounded-xl bg-slate-50 ring-1 ring-slate-200 p-4 text-center">
                  <p class="text-xs text-slate-600">Current Lecturer PIN (Works on all devices)</p>
                  <p id="adminPinDisplay" class="text-3xl font-bold tracking-widest mt-2">••••••</p>
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <button id="btnCopyAdminPin" class="rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white">Copy PIN</button>
                  <button id="btnResetAdminPin" class="rounded-xl bg-rose-600 px-4 py-2 text-sm font-semibold text-white">Reset PIN</button>
                </div>

                <div class="grid grid-cols-2 gap-3 mt-2">
                  <button id="btnExportPin" class="rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200">Export PIN (JSON)</button>
                  <button id="btnGeneratePinQr" class="rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200">Generate PIN QR</button>
                </div>

                <div class="mt-2 grid grid-cols-2 gap-3">
                  <label for="importPinAdminFile" class="rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50 cursor-pointer text-center">Import PIN (file)</label>
                  <button id="btnShareAdminCreds" class="rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200">Share Admin Creds</button>
                  <input id="importPinAdminFile" type="file" accept="application/json" class="hidden" />
                </div>

                <div id="adminPinQrPanel" class="mt-3 hidden">
                  <img id="adminPinQrImage" alt="PIN QR" class="rounded-lg ring-1 ring-slate-200" />
                  <div id="adminPinQrLink" class="mt-2 word-break-all small-muted"></div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Footer -->
  <footer class="no-print border-t border-slate-200 bg-white">
    <div class="mx-auto max-w-6xl px-4 py-6">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <p class="text-xs text-slate-600">© <span id="year"></span> NSUK — Department of Urban and Regional Planning.</p>
        <p class="text-xs text-slate-500">Developed by A. Suleiman and Powered by Ramsulone Innovation & Services Ltd.</p>
      </div>
    </div>
  </footer>

  <!-- Toast -->
  <div id="toast" class="pointer-events-none fixed bottom-4 left-1/2 -translate-x-1/2 z-50 hidden">
    <div class="rounded-2xl bg-slate-900 text-white px-4 py-3 shadow-lg ring-1 ring-white/10">
      <p id="toastText" class="text-sm font-semibold">—</p>
    </div>
  </div>

  <canvas id="captureCanvas" class="hidden"></canvas>

  <script>
    /************************************************************************
     * CROSS-DEVICE SUPPORT ENABLED
     * This version allows PINs and user credentials to work across devices
     * through export/import functionality and QR code sharing.
     ************************************************************************/
    const FIREBASE_CONFIG = null; // <-- Set to null for cross-device without Firebase

    const $ = id => document.getElementById(id);

    const STORAGE_KEY_RECORDS = 'nsuk_urp_attendance_records_v1';
    const STORAGE_KEY_PIN = 'nsuk_urp_lecturer_pin_v1';
    const STORAGE_KEY_ADMIN = 'nsuk_urp_admin_creds_v1';
    const STORAGE_KEY_STUDENTS = 'nsuk_urp_student_accounts_v1';
    const STORAGE_KEY_CURRENT_STUDENT = 'nsuk_urp_current_student_v1';

    let firebaseEnabled = false;
    let firebaseDbRef = null;
    let firebasePinRef = null;
    let firebaseRecordsRef = null;
    let firebaseAdminRef = null;
    let firebaseStudentsRef = null;
    let qrScanner = null;

    const state = {
      location: { ok: false, lat: null, lon: null, accuracy: null, denied: false },
      face: { ok: false, dataUrl: null, w: null, h: null, fromUpload: false },
      camera: { stream: null, started: false },
      admin: { loggedIn: false },
      lecturer: { unlocked: false },
      student: { loggedIn: false, name: null, matric: null }
    };

    // ========== UTILITIES ==========
    function showToast(msg) {
      $('toastText').textContent = msg;
      $('toast').classList.remove('hidden');
      clearTimeout(showToast.t);
      showToast.t = setTimeout(() => $('toast').classList.add('hidden'), 3000);
    }
    function nowIso() { return new Date().toISOString(); }

    // Basic hash for passwords (for consistency across devices)
    function weakHash(str) {
      let h = 0x811c9dc5;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h = (h + ((h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24))) >>> 0;
      }
      return ('00000000' + h.toString(16)).slice(-8);
    }

    function normalizeMatric(m) { return (m || '').trim(); }
    function matricToKey(m) {
      return normalizeMatric(m).replace(/[.#$\[\]\/]/g, '_');
    }

    // ========== Local storage helpers ==========
    function getStoredRecords() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY_RECORDS) || '[]'); } catch { return []; }
    }
    function setStoredRecords(arr) { localStorage.setItem(STORAGE_KEY_RECORDS, JSON.stringify(arr || [])); }

    function getStudentAccounts() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY_STUDENTS) || '{}'); } catch { return {}; }
    }
    function saveStudentAccountLocal(matric, name, password) {
      const accounts = getStudentAccounts();
      accounts[matric] = { name, password, passwordHash: weakHash(password), createdAt: nowIso() };
      localStorage.setItem(STORAGE_KEY_STUDENTS, JSON.stringify(accounts));
    }

    function getCurrentStudent() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY_CURRENT_STUDENT)); } catch { return null; }
    }
    function setCurrentStudent(student) {
      if (student) {
        localStorage.setItem(STORAGE_KEY_CURRENT_STUDENT, JSON.stringify(student));
        state.student.loggedIn = true;
        state.student.name = student.name;
        state.student.matric = student.matric;
      } else {
        localStorage.removeItem(STORAGE_KEY_CURRENT_STUDENT);
        state.student.loggedIn = false;
        state.student.name = null;
        state.student.matric = null;
      }
    }

    function getAdminCredsLocal() {
      const d = localStorage.getItem(STORAGE_KEY_ADMIN);
      return d ? JSON.parse(d) : null;
    }
    function saveAdminCredsLocal(u,p) { 
      localStorage.setItem(STORAGE_KEY_ADMIN, JSON.stringify({ 
        username: u, 
        password: p,
        passwordHash: weakHash(p),
        createdAt: nowIso() 
      })); 
    }

    function ensurePinLocal() {
      if (!localStorage.getItem(STORAGE_KEY_PIN)) {
        const newPin = String(Math.floor(100000 + Math.random()*900000));
        localStorage.setItem(STORAGE_KEY_PIN, newPin);
        return newPin;
      }
      return localStorage.getItem(STORAGE_KEY_PIN);
    }
    function getPinLocal() { return ensurePinLocal(); }
    function setPinLocal(pin) { 
      if (!pin) return false; 
      localStorage.setItem(STORAGE_KEY_PIN, String(pin)); 
      return true; 
    }

    // ========== CROSS-DEVICE EXPORT/IMPORT ==========
    function exportAllData() {
      const allData = {
        version: '2.0',
        exportedAt: nowIso(),
        pin: getPinLocal(),
        admin: getAdminCredsLocal(),
        students: getStudentAccounts(),
        records: getStoredRecords(),
        currentStudent: getCurrentStudent()
      };
      
      const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `nsuk_urp_all_data_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast('All data exported for cross-device use');
    }

    function importAllData(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          
          // Import PIN
          if (data.pin) {
            setPinLocal(data.pin);
            showToast('PIN imported');
          }
          
          // Import admin credentials
          if (data.admin) {
            localStorage.setItem(STORAGE_KEY_ADMIN, JSON.stringify(data.admin));
            showToast('Admin credentials imported');
          }
          
          // Import student accounts
          if (data.students && typeof data.students === 'object') {
            localStorage.setItem(STORAGE_KEY_STUDENTS, JSON.stringify(data.students));
            showToast('Student accounts imported');
          }
          
          // Import records
          if (Array.isArray(data.records)) {
            const existing = getStoredRecords();
            const merged = [...existing, ...data.records].filter((v,i,a) => 
              a.findIndex(t => t.id === v.id) === i
            );
            setStoredRecords(merged);
            showToast('Records imported and merged');
          }
          
          // Import current student if logged in
          if (data.currentStudent) {
            setCurrentStudent(data.currentStudent);
            showToast('Current student session restored');
          }
          
          // Refresh UI
          revealAdminPin();
          renderDashboard();
          renderStudentRecords();
          showToast('All data imported successfully!');
          
        } catch (error) {
          console.error('Import error:', error);
          showToast('Error importing data');
        }
      };
      reader.readAsText(file);
    }

    function shareAllDataAsQR() {
      const allData = {
        version: '2.0',
        exportedAt: nowIso(),
        pin: getPinLocal(),
        admin: getAdminCredsLocal(),
        students: getStudentAccounts(),
        records: getStoredRecords()
      };
      
      const jsonStr = JSON.stringify(allData);
      if (jsonStr.length > 2000) {
        showToast('Data too large for QR. Use file export instead.');
        return;
      }
      
      const qrData = encodeURIComponent(jsonStr);
      const qrUrl = `https://chart.googleapis.com/chart?chs=400x400&cht=qr&chl=${qrData}&chld=L|1`;
      
      const win = window.open('', '_blank', 'width=500,height=600');
      win.document.write(`
        <html>
          <head><title>Scan QR to Import All Data</title></head>
          <body style="font-family: sans-serif; padding: 20px; text-align: center;">
            <h2>Scan QR to Import All Data</h2>
            <p>Scan this QR code from another device to import PIN, admin credentials, student accounts, and records.</p>
            <img src="${qrUrl}" style="max-width: 100%; height: auto; border: 1px solid #ccc; border-radius: 8px;" />
            <p style="margin-top: 20px; color: #666; font-size: 14px;">
              On the other device, go to Admin panel and use "Import All Data" option.
            </p>
            <button onclick="window.print()" style="margin-top: 20px; padding: 10px 20px; background: #0f1b3d; color: white; border: none; border-radius: 8px; cursor: pointer;">
              Print QR Code
            </button>
          </body>
        </html>
      `);
    }

    // ========== UI helpers ==========
    function setSyncSummary(text, ok) {
      $('syncSummary').textContent = text;
      const el = $('syncStatus');
      el.title = text;
      if (ok) el.style.background = '#064e3bff';
      else el.style.background = '#11182733';
    }

    function setChecklist() {
      const mark = (ok) => ok ? '✓' : '—';
      const cls = (ok) => ok ? 'bg-emerald-50 text-emerald-700 ring-emerald-200' : 'bg-slate-100 text-slate-700 ring-slate-200';

      $('checkLogin').textContent = mark(state.student.loggedIn);
      $('checkLogin').className = `mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg ring-1 ${cls(state.student.loggedIn)}`;

      $('checkLoc').textContent = mark(state.location.ok);
      $('checkLoc').className = `mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg ring-1 ${cls(state.location.ok)}`;

      $('checkFace').textContent = mark(state.face.ok);
      $('checkFace').className = `mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg ring-1 ${cls(state.face.ok)}`;

      const fieldsOk = requiredFieldsFilled();
      $('checkFields').textContent = mark(fieldsOk);
      $('checkFields').className = `mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg ring-1 ${cls(fieldsOk)}`;

      const ver = (state.student.loggedIn && state.location.ok && state.face.ok && fieldsOk) ? 'Ready to submit' : 'Pending';
      $('verifyText') && ($('verifyText').textContent = ver);
    }

    function requiredFieldsFilled() {
      const course = $('courseCode').value.trim();
      return Boolean(course);
    }

    function updateDateTimePreview() {
      const d = new Date();
      const pad = n => String(n).padStart(2, '0');
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      $('dateText').textContent = `${pad(d.getDate())} ${months[d.getMonth()]} ${d.getFullYear()}`;
      $('timeText').textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function updateSubmitState() {
      if (!state.student.loggedIn) {
        $('formFieldset').disabled = true;
        $('formFieldset').classList.add('opacity-60');
        $('formLockedNote').classList.remove('hidden');
        $('formLockedNote').innerHTML = '<span class="font-semibold">Locked:</span> Login or create an account first.';
        $('btnSubmit').disabled = true;
        setChecklist();
        return;
      }

      const unlocked = state.face.ok;
      $('formFieldset').disabled = !unlocked;
      $('formFieldset').classList.toggle('opacity-60', !unlocked);
      $('formLockedNote').classList.toggle('hidden', unlocked);
      $('formLockedNote').innerHTML = '<span class="font-semibold">Locked:</span> Start camera and capture face to unlock attendance form.';

      const canSubmit = state.location.ok && state.face.ok && requiredFieldsFilled();
      $('btnSubmit').disabled = !canSubmit;
      setChecklist();
    }

    // ========== FIREBASE INIT (optional) ==========
    function initFirebaseIfConfigured() {
      if (!FIREBASE_CONFIG) {
        firebaseEnabled = false;
        setSyncSummary('Cross-Device Ready', false);
        return;
      }
      try {
        firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.database();
        firebaseDbRef = db;

        firebasePinRef = db.ref('nsuk_urp/pin');
        firebaseRecordsRef = db.ref('nsuk_urp/records');
        firebaseAdminRef = db.ref('nsuk_urp/admin');
        firebaseStudentsRef = db.ref('nsuk_urp/students');

        firebaseEnabled = true;
        setSyncSummary('Realtime: Firebase', true);
        setupFirebaseListeners();
      } catch (err) {
        console.error('Firebase init error', err);
        firebaseEnabled = false;
        setSyncSummary('Cross-Device Ready', false);
      }
    }

    function setupFirebaseListeners() {
      if (!firebaseEnabled) return;

      firebasePinRef.on('value', snap => {
        const val = snap.val();
        if (val && val.pin) {
          setPinLocal(String(val.pin));
          $('adminPinDisplay').textContent = String(val.pin);
          if (!$('lecturerPinInput').value) $('lecturerPinInput').value = String(val.pin);
        }
      });

      firebaseAdminRef.on('value', snap => {
        const val = snap.val();
        if (val && val.username && val.passwordHash) {
          localStorage.setItem(STORAGE_KEY_ADMIN, JSON.stringify({
            username: String(val.username),
            passwordHash: String(val.passwordHash),
            syncedAt: nowIso()
          }));
        }
      });

      firebaseStudentsRef.on('child_added', snap => {
        const v = snap.val();
        if (!v || !v.matric) return;
        const matric = normalizeMatric(v.matric);
        const accounts = getStudentAccounts();
        if (!accounts[matric]) {
          accounts[matric] = {
            name: v.name || '',
            passwordHash: v.passwordHash || '',
            createdAt: v.createdAt || nowIso(),
            syncedAt: nowIso()
          };
          localStorage.setItem(STORAGE_KEY_STUDENTS, JSON.stringify(accounts));
        }
      });

      firebaseRecordsRef.on('child_added', snap => {
        const r = snap.val();
        if (!r) return;
        r.id = r.id || snap.key;
        const existing = getStoredRecords();
        const exists = existing.some(e => e.id === r.id || (e.matric === r.matric && e.date === r.date && e.time === r.time));
        if (!exists) {
          existing.unshift(r);
          setStoredRecords(existing);
          renderDashboard();
          renderStudentRecords();
        }
      });
    }

    // ========== Cross-device Auth helpers ==========
    async function createAdminAccount(u, p) {
      if (!u || !p) throw new Error('missing');
      const payloadLocal = { username: u, password: p, passwordHash: weakHash(p), createdAt: nowIso() };
      localStorage.setItem(STORAGE_KEY_ADMIN, JSON.stringify(payloadLocal));

      if (firebaseEnabled) {
        const payloadRemote = { username: u, passwordHash: weakHash(p), updatedAt: nowIso() };
        await firebaseAdminRef.set(payloadRemote);
      }
      showToast('Admin account created (works across devices when shared)');
    }

    async function verifyAdminLogin(u, p) {
      if (!u || !p) return false;

      if (firebaseEnabled) {
        const snap = await firebaseAdminRef.get();
        const v = snap.val();
        if (!v || !v.username || !v.passwordHash) return false;
        const ok = (String(v.username) === String(u)) && (String(v.passwordHash) === weakHash(p));
        if (ok) {
          localStorage.setItem(STORAGE_KEY_ADMIN, JSON.stringify({
            username: String(v.username),
            passwordHash: String(v.passwordHash),
            syncedAt: nowIso()
          }));
        }
        return ok;
      }

      const creds = getAdminCredsLocal();
      if (!creds) return false;
      if (creds.passwordHash) return (creds.username === u && creds.passwordHash === weakHash(p));
      return (creds.username === u && creds.password === p);
    }

    async function createStudentAccount(name, matric, password) {
      matric = normalizeMatric(matric);
      if (!name || !matric || !password) throw new Error('missing');

      saveStudentAccountLocal(matric, name, password);

      if (firebaseEnabled) {
        const key = matricToKey(matric);
        const ref = firebaseStudentsRef.child(key);
        const snap = await ref.get();
        if (snap.exists()) throw new Error('exists');
        await ref.set({
          matric,
          name,
          passwordHash: weakHash(password),
          createdAt: nowIso()
        });
      }
      showToast('Student account created (works across devices when shared)');
    }

    async function verifyStudentLogin(matric, password) {
      matric = normalizeMatric(matric);
      if (!matric || !password) return { ok: false, reason: 'missing' };

      if (firebaseEnabled) {
        const key = matricToKey(matric);
        const snap = await firebaseStudentsRef.child(key).get();
        const v = snap.val();
        if (!v) return { ok: false, reason: 'notfound' };
        if (String(v.passwordHash) !== weakHash(password)) return { ok: false, reason: 'wrongpass' };

        const accounts = getStudentAccounts();
        accounts[matric] = { name: v.name || '', passwordHash: v.passwordHash || '', createdAt: v.createdAt || nowIso(), syncedAt: nowIso() };
        localStorage.setItem(STORAGE_KEY_STUDENTS, JSON.stringify(accounts));

        return { ok: true, name: v.name || '' };
      }

      const accounts = getStudentAccounts();
      const account = accounts[matric];
      if (!account) return { ok: false, reason: 'notfound' };
      if (account.passwordHash) {
        if (account.passwordHash !== weakHash(password)) return { ok: false, reason: 'wrongpass' };
        return { ok: true, name: account.name || '' };
      }
      if (account.password !== password) return { ok: false, reason: 'wrongpass' };
      return { ok: true, name: account.name || '' };
    }

    // ========== STUDENT LOGIN/SIGNUP ==========
    function initStudentAuth() {
      const currentStudent = getCurrentStudent();
      if (currentStudent) {
        state.student.loggedIn = true;
        state.student.name = currentStudent.name;
        state.student.matric = currentStudent.matric;
        showStudentDashboard();
      } else {
        showStudentLogin();
      }
    }

    function showStudentLogin() {
      $('studentLoginSection').classList.remove('hidden');
      $('studentDashboard').classList.add('hidden');
      $('studentLoginMsg').textContent = '';
      $('studentSignupMsg').textContent = '';
    }

    function showStudentDashboard() {
      $('studentLoginSection').classList.add('hidden');
      $('studentDashboard').classList.remove('hidden');
      $('loggedInStudentName').textContent = state.student.name;
      $('loggedInStudentMatric').textContent = state.student.matric;
      $('studentName').value = state.student.name;
      $('matricNo').value = state.student.matric;
      updateSubmitState();
      renderStudentRecords();
    }

    $('btnStudentLogin').addEventListener('click', async () => {
      const matric = $('studentLoginMatric').value.trim();
      const password = $('studentLoginPassword').value;

      if (!matric || !password) {
        $('studentLoginMsg').textContent = 'Please enter matric number and password';
        $('studentLoginMsg').className = 'text-xs text-rose-700 font-semibold text-center mt-2';
        return;
      }

      try {
        const res = await verifyStudentLogin(matric, password);
        if (!res.ok) {
          if (res.reason === 'notfound') {
            $('studentLoginMsg').textContent = 'Account not found. Please sign up first.';
          } else if (res.reason === 'wrongpass') {
            $('studentLoginMsg').textContent = 'Incorrect password';
          } else {
            $('studentLoginMsg').textContent = 'Login failed';
          }
          $('studentLoginMsg').className = 'text-xs text-rose-700 font-semibold text-center mt-2';
          return;
        }

        setCurrentStudent({ name: res.name, matric: normalizeMatric(matric) });
        showStudentDashboard();
        showToast(`Welcome back, ${res.name}! Account works across devices.`);
      } catch (err) {
        console.error(err);
        $('studentLoginMsg').textContent = 'Login error';
        $('studentLoginMsg').className = 'text-xs text-rose-700 font-semibold text-center mt-2';
      }
    });

    $('btnStudentSignup').addEventListener('click', async () => {
      const name = $('studentSignupName').value.trim();
      const matric = $('studentSignupMatric').value.trim();
      const password = $('studentSignupPassword').value;

      if (!name || !matric || !password) {
        $('studentSignupMsg').textContent = 'Please fill all fields';
        $('studentSignupMsg').className = 'text-xs text-rose-700 font-semibold text-center mt-2';
        return;
      }

      if (password.length < 4) {
        $('studentSignupMsg').textContent = 'Password must be at least 4 characters';
        $('studentSignupMsg').className = 'text-xs text-rose-700 font-semibold text-center mt-2';
        return;
      }

      try {
        await createStudentAccount(name, matric, password);
        setCurrentStudent({ name, matric: normalizeMatric(matric) });
        showStudentDashboard();
      } catch (err) {
        if (String(err.message) === 'exists') {
          $('studentSignupMsg').textContent = 'Account already exists. Please login instead.';
          $('studentSignupMsg').className = 'text-xs text-rose-700 font-semibold text-center mt-2';
          return;
        }
        console.error(err);
        $('studentSignupMsg').textContent = 'Signup failed';
        $('studentSignupMsg').className = 'text-xs text-rose-700 font-semibold text-center mt-2';
      }
    });

    $('btnStudentLogout').addEventListener('click', () => {
      setCurrentStudent(null);
      showStudentLogin();
      $('studentLoginMatric').value = '';
      $('studentLoginPassword').value = '';
      $('studentSignupName').value = '';
      $('studentSignupMatric').value = '';
      $('studentSignupPassword').value = '';
      showToast('Logged out successfully');
      updateSubmitState();
    });

    // Export/Import Student Accounts
    $('btnExportStudents').addEventListener('click', () => {
      const students = getStudentAccounts();
      const data = {
        version: '1.0',
        exportedAt: nowIso(),
        students: students
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `nsuk_student_accounts_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast('Student accounts exported for cross-device use');
    });

    $('btnImportStudents').addEventListener('click', () => {
      $('importStudentsFile').click();
    });

    $('importStudentsFile').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (data.students && typeof data.students === 'object') {
            const existing = getStudentAccounts();
            const merged = { ...existing, ...data.students };
            localStorage.setItem(STORAGE_KEY_STUDENTS, JSON.stringify(merged));
            showToast('Student accounts imported successfully');
          } else {
            showToast('Invalid student accounts file');
          }
        } catch (error) {
          showToast('Error importing student accounts');
        }
      };
      reader.readAsText(file);
    });

    $('btnShareStudentsQr').addEventListener('click', () => {
      const students = getStudentAccounts();
      const data = {
        version: '1.0',
        exportedAt: nowIso(),
        students: students
      };
      
      const jsonStr = JSON.stringify(data);
      if (jsonStr.length > 1500) {
        showToast('Too many students for QR. Use file export.');
        return;
      }
      
      const qrData = encodeURIComponent(jsonStr);
      const qrUrl = `https://chart.googleapis.com/chart?chs=400x400&cht=qr&chl=${qrData}&chld=L|1`;
      
      const win = window.open('', '_blank', 'width=450,height=550');
      win.document.write(`
        <html>
          <head><title>Student Accounts QR</title></head>
          <body style="font-family: sans-serif; padding: 20px; text-align: center;">
            <h2>Scan to Import Student Accounts</h2>
            <img src="${qrUrl}" style="max-width: 100%; height: auto;" />
            <p style="margin-top: 20px; color: #666; font-size: 14px;">
              Scan this QR on another device to import all student accounts.
            </p>
          </body>
        </html>
      `);
    });

    function renderStudentRecords() {
      if (!state.student.loggedIn) return;

      const records = getStoredRecords();
      const studentRecords = records.filter(r => r.matric === state.student.matric);
      const tbody = $('localRecordsTbody');
      tbody.innerHTML = '';

      if (!studentRecords.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-6 text-slate-500">No attendance records yet</td></tr>';
        return;
      }

      studentRecords.forEach(r => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-100';
        tr.innerHTML = `
          <td class="px-4 py-3">${r.course || ''}</td>
          <td class="px-4 py-3 text-sm">${r.date} ${r.time}</td>
          <td class="px-4 py-3 text-xs">${r.lat?.toFixed?.(6) || ''}</td>
          <td class="px-4 py-3 text-xs">${r.lon?.toFixed?.(6) || ''}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ========== App logic (location/camera/submit/export/import) ==========
    $('btnGetLocation').addEventListener('click', () => {
      if (!navigator.geolocation) return showToast('Geolocation not supported');
      $('locStatus').textContent = 'Requesting...';
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        state.location.ok = true; state.location.lat = latitude; state.location.lon = longitude; state.location.accuracy = accuracy;
        $('locStatus').textContent = `Captured (±${Math.round(accuracy)}m)`;
        $('latText').textContent = latitude.toFixed(6); $('lonText').textContent = longitude.toFixed(6);
        $('locError').classList.add('hidden');
        showToast('Location captured');
        updateSubmitState();
      }, err => {
        state.location.ok = false; state.location.denied = err.code === err.PERMISSION_DENIED;
        $('locStatus').textContent = 'Error';
        $('locError').textContent = err.message;
        $('locError').classList.remove('hidden');
        showToast('Location error: ' + err.message);
        updateSubmitState();
      });
    });

    $('btnToggleManualCoords').addEventListener('click', () => $('manualCoordsPanel').classList.toggle('hidden'));
    $('btnApplyManualCoords').addEventListener('click', () => {
      const lat = parseFloat($('manualLat').value.trim());
      const lon = parseFloat($('manualLon').value.trim());
      if (Number.isFinite(lat) && Number.isFinite(lon)) {
        state.location.ok = true; state.location.lat = lat; state.location.lon = lon; state.location.accuracy = null;
        $('locStatus').textContent = 'Manual';
        $('latText').textContent = lat.toFixed(6);
        $('lonText').textContent = lon.toFixed(6);
        $('locError').classList.add('hidden');
        showToast('Manual coordinates applied');
        updateSubmitState();
      } else showToast('Enter valid numeric coordinates');
    });

    // camera
    $('btnStartCamera').addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }});
        state.camera.stream = stream;
        state.camera.started = true;
        $('video').srcObject = stream;
        $('btnCaptureFace').disabled = false;
        showToast('Camera started');
      } catch (err) {
        showToast('Camera error: ' + err.message);
      }
    });

    $('btnCaptureFace').addEventListener('click', () => {
      if (!state.camera.started) return showToast('Start camera first');
      const canvas = $('captureCanvas');
      const video = $('video');
      canvas.width = video.videoWidth || 1280;
      canvas.height = video.videoHeight || 720;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.8);

      state.face.ok = true; state.face.dataUrl = dataUrl; state.face.w = canvas.width; state.face.h = canvas.height; state.face.fromUpload = false;
      $('facePreview').src = dataUrl;
      $('facePreview').classList.remove('hidden');
      $('faceEmpty').classList.add('hidden');
      $('faceStatus').textContent = 'Captured';
      $('faceQuality').textContent = `${canvas.width}×${canvas.height}`;
      $('btnRetake').disabled = false;

      if (state.camera.stream) {
        state.camera.stream.getTracks().forEach(t => t.stop());
        state.camera.stream = null;
        state.camera.started = false;
        $('video').srcObject = null;
      }

      showToast('Face captured');
      updateSubmitState();
    });

    $('btnRetake').addEventListener('click', () => {
      state.face.ok=false; state.face.dataUrl=null; state.face.w=null; state.face.h=null; state.face.fromUpload=false;
      $('facePreview').classList.add('hidden');
      $('faceEmpty').classList.remove('hidden');
      $('faceStatus').textContent='Not captured';
      $('faceQuality').textContent='—';
      $('btnRetake').disabled = true;
      updateSubmitState();
    });

    $('faceFile').addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      if (!f.type.startsWith('image/')) return showToast('Select an image file');
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        const img = new Image();
        img.onload = () => {
          state.face.ok=true; state.face.dataUrl=dataUrl; state.face.w=img.width; state.face.h=img.height; state.face.fromUpload=true;
          $('facePreview').src=dataUrl;
          $('facePreview').classList.remove('hidden');
          $('faceEmpty').classList.add('hidden');
          $('faceStatus').textContent='Uploaded';
          $('faceQuality').textContent=`${img.width}×${img.height}`;
          $('btnRetake').disabled=false;
          updateSubmitState();
          showToast('Image uploaded');
        };
        img.src = dataUrl;
      };
      reader.readAsDataURL(f);
    });

    // submit attendance
    $('attendanceForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!state.student.loggedIn) { showToast('Please login first'); return; }
      if (!state.location.ok || !state.face.ok || !requiredFieldsFilled()) { showToast('Complete all steps first'); return; }

      const d = new Date();
      const pad = n => String(n).padStart(2,'0');
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

      const baseRecord = {
        name: state.student.name,
        matric: state.student.matric,
        course: $('courseCode').value.trim(),
        date: `${pad(d.getDate())} ${months[d.getMonth()]} ${d.getFullYear()}`,
        time: `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`,
        lat: state.location.lat,
        lon: state.location.lon,
        accuracy: state.location.accuracy,
        faceDataUrl: state.face.dataUrl,
        faceFromUpload: !!state.face.fromUpload,
        createdAt: nowIso()
      };

      if (firebaseEnabled) {
        try {
          const pushKey = await pushRecordToFirebase(baseRecord);
          if (pushKey) {
            baseRecord.id = pushKey;
            const records = getStoredRecords(); records.unshift(baseRecord); setStoredRecords(records);
            showToast('Attendance submitted (synced)');
          } else {
            baseRecord.id = Date.now() + Math.floor(Math.random()*999);
            const records = getStoredRecords(); records.unshift(baseRecord); setStoredRecords(records);
            showToast('Attendance submitted (local only - sync failed)');
          }
        } catch {
          baseRecord.id = Date.now() + Math.floor(Math.random()*999);
          const records = getStoredRecords(); records.unshift(baseRecord); setStoredRecords(records);
          showToast('Attendance submitted (local fallback)');
        }
      } else {
        baseRecord.id = Date.now() + Math.floor(Math.random()*999);
        const records = getStoredRecords(); records.unshift(baseRecord); setStoredRecords(records);
        showToast('Attendance submitted (works across devices when shared)');
      }

      $('courseCode').value='';
      state.face.ok=false; state.face.dataUrl=null; state.face.w=null; state.face.h=null; state.face.fromUpload=false;
      $('facePreview').classList.add('hidden');
      $('faceEmpty').classList.remove('hidden');
      $('faceStatus').textContent='Not captured';
      $('faceQuality').textContent='—';
      $('btnRetake').disabled=true;

      updateSubmitState();
      renderDashboard();
      renderStudentRecords();
    });

    async function pushRecordToFirebase(record) {
      if (!firebaseEnabled) return Promise.resolve(null);
      try {
        const ref = await firebaseRecordsRef.push(record);
        const key = ref.key;
        await firebaseRecordsRef.child(key).update({ id: key });
        return key;
      } catch (err) {
        console.warn('pushRecordToFirebase err', err);
        return null;
      }
    }

    // Clear Data
    $('btnClearData').addEventListener('click', () => {
      if (!confirm('Are you sure you want to clear ALL attendance data? This action cannot be undone.')) return;

      localStorage.removeItem(STORAGE_KEY_RECORDS);

      if (firebaseEnabled && firebaseRecordsRef) {
        if (confirm('Do you also want to clear data from Firebase? This will delete all records from the server.')) {
          firebaseRecordsRef.remove()
            .then(() => showToast('All data cleared from local storage and Firebase'))
            .catch(err => { console.error('Firebase clear error:', err); showToast('Local data cleared, but Firebase clear failed'); });
        } else {
          showToast('Local data cleared (Firebase data preserved)');
        }
      } else {
        showToast('All local data cleared');
      }

      renderDashboard();
      renderStudentRecords();
    });

    // Draft export/import/QR/share
    function createDraftObject() {
      const d = new Date();
      const pad = n => String(n).padStart(2,'0');
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      return {
        t: nowIso(),
        name: state.student.name || '',
        matric: state.student.matric || '',
        course: $('courseCode').value.trim(),
        date: `${pad(d.getDate())} ${months[d.getMonth()]} ${d.getFullYear()}`,
        time: `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`,
        lat: state.location.lat,
        lon: state.location.lon,
        accuracy: state.location.accuracy,
        faceDataUrl: state.face.dataUrl || null,
        faceFromUpload: !!state.face.fromUpload
      };
    }

    $('btnExportDraft').addEventListener('click', () => {
      if (!state.student.loggedIn) { showToast('Please login first'); return; }
      const draft = createDraftObject();
      const blob = new Blob([JSON.stringify(draft)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `nsuk_urp_draft_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast('Draft exported (JSON)');
    });

    $('importDraftFile').addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (data.course) $('courseCode').value = data.course;
          if (!isNaN(parseFloat(data.lat))) {
            state.location.ok = true;
            state.location.lat = parseFloat(data.lat);
            state.location.lon = parseFloat(data.lon);
            state.location.accuracy = data.accuracy || null;
            $('latText').textContent = state.location.lat?.toFixed(6) || '—';
            $('lonText').textContent = state.location.lon?.toFixed(6) || '—';
            $('locStatus').textContent = 'Imported';
          }
          if (data.faceDataUrl) {
            state.face.ok = true;
            state.face.dataUrl = data.faceDataUrl;
            $('facePreview').src = data.faceDataUrl;
            $('facePreview').classList.remove('hidden');
            $('faceEmpty').classList.add('hidden');
            $('faceStatus').textContent = 'Imported';
            $('faceQuality').textContent = '—';
            $('btnRetake').disabled = false;
          }
          updateSubmitState();
          showToast('Draft imported from another device');
        } catch {
          showToast('Invalid JSON');
        }
      };
      reader.readAsText(f);
      e.target.value='';
    });

    $('btnGenerateQr').addEventListener('click', () => {
      if (!state.student.loggedIn) { showToast('Please login first'); return; }
      const draft = createDraftObject();
      const json = JSON.stringify(draft);
      if (json.length > 1800) { showToast('Draft too large for QR — use JSON export'); $('qrPanel').classList.add('hidden'); return; }
      const qrData = encodeURIComponent(json);
      const qrUrl = `https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=${qrData}&chld=L|1`;
      $('qrImage').src = qrUrl;
      $('qrPanel').classList.remove('hidden');
      $('qrLinkBox').innerHTML = `<a target="_blank" rel="noopener" class="text-xs underline" href="${qrUrl}">Open QR image (new tab)</a>`;
      showToast('QR generated — scan from another device');
    });

    $('btnShareDraft').addEventListener('click', async () => {
      if (!state.student.loggedIn) { showToast('Please login first'); return; }
      const draft = createDraftObject();
      const text = JSON.stringify(draft);

      if (navigator.canShare && navigator.canShare({ files: [] })) {
        try {
          const file = new File([text], `nsuk_urp_draft_${new Date().toISOString().slice(0,10)}.json`, { type:'application/json' });
          await navigator.share({ files:[file], title:'Attendance draft', text:'NSUK URP attendance draft' });
          showToast('Draft shared');
          return;
        } catch {}
      }
      if (navigator.share) {
        try { await navigator.share({ title:'Attendance draft', text }); showToast('Draft shared'); }
        catch { showToast('Share cancelled'); }
      } else {
        try { await navigator.clipboard.writeText(text); showToast('Draft JSON copied to clipboard — paste on other device'); }
        catch { showToast('Share unavailable — use Export Draft (JSON)'); }
      }
    });

    // ========== ADMIN: login + PIN management ==========
    $('btnAdminSignup').addEventListener('click', async () => {
      const u = $('adminUsername').value.trim();
      const p = $('adminPassword').value;
      if (!u || !p) return showToast('Fill both fields');

      try {
        if (firebaseEnabled) {
          const snap = await firebaseAdminRef.get();
          if (snap.exists()) return showToast('Admin already exists (server)');
        } else {
          if (getAdminCredsLocal()) return showToast('Admin already exists (local)');
        }

        await createAdminAccount(u, p);
      } catch (err) {
        console.error(err);
        showToast('Admin signup failed');
      }
    });

    $('btnAdminLogin').addEventListener('click', async () => {
      const u = $('adminUsername').value.trim();
      const p = $('adminPassword').value;

      try {
        const ok = await verifyAdminLogin(u, p);
        if (ok) {
          state.admin.loggedIn = true;
          $('adminLoginForm').classList.add('hidden');
          $('adminDashboardSection').classList.remove('hidden');
          $('adminTitle').textContent='Admin Panel';
          revealAdminPin();
          showToast('Admin logged in (works across devices)');
        } else {
          showToast('Wrong username or password');
        }
      } catch (err) {
        console.error(err);
        showToast('Admin login failed');
      }
    });

    $('btnAdminLogout').addEventListener('click', () => {
      state.admin.loggedIn = false;
      $('adminLoginForm').classList.remove('hidden');
      $('adminDashboardSection').classList.add('hidden');
      $('adminTitle').textContent='Admin Login';
      $('adminUsername').value='';
      $('adminPassword').value='';
      showToast('Logged out');
    });

    function revealAdminPin() {
      const p = getPinLocal();
      $('adminPinDisplay').textContent = p || '••••••';
    }

    $('btnCopyAdminPin').addEventListener('click', async () => {
      try { 
        await navigator.clipboard.writeText(getPinLocal()); 
        showToast('PIN copied. Share with lecturers for cross-device access.'); 
      } catch { 
        showToast('Copy failed'); 
      }
    });

    $('btnResetAdminPin').addEventListener('click', async () => {
      if (!confirm('Reset PIN? All lecturers will need the new one.')) return;
      const newPin = String(Math.floor(100000 + Math.random()*900000));
      setPinLocal(newPin);
      revealAdminPin();
      showToast('Local PIN reset');
      if (firebaseEnabled) {
        try { 
          await firebasePinRef.set({ pin: newPin, updatedAt: nowIso() }); 
          showToast('PIN updated on server for all devices'); 
        } catch { 
          showToast('PIN local only (server update failed)'); 
        }
      }
    });

    $('btnExportPin').addEventListener('click', () => {
      const payload = { pin: getPinLocal(), t: nowIso() };
      const blob = new Blob([JSON.stringify(payload)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `nsuk_urp_pin_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast('PIN exported (JSON) - Share with other devices');
    });

    $('btnGeneratePinQr').addEventListener('click', () => {
      const payload = { pin: getPinLocal(), t: nowIso() };
      const json = JSON.stringify(payload);
      if (json.length > 1800) return showToast('PIN too large');
      const qrData = encodeURIComponent(json);
      const qrUrl = `https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=${qrData}&chld=L|1`;
      $('adminPinQrImage').src = qrUrl;
      $('adminPinQrLink').innerHTML = `<a target="_blank" rel="noopener" class="text-xs underline" href="${qrUrl}">Open PIN QR image</a>`;
      $('adminPinQrPanel').classList.remove('hidden');
      showToast('PIN QR generated - Scan on other devices');
    });

    $('importPinAdminFile').addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = async () => {
        try {
          const data = JSON.parse(reader.result);
          if (data.pin) {
            setPinLocal(data.pin);
            revealAdminPin();
            showToast('PIN imported locally (now works on this device)');
            if (firebaseEnabled) {
              try { 
                await firebasePinRef.set({ pin: data.pin, updatedAt: nowIso() }); 
                showToast('PIN written to server for all devices'); 
              } catch {}
            }
          } else showToast('Invalid PIN file');
        } catch { showToast('Invalid PIN file'); }
      };
      reader.readAsText(f);
      e.target.value='';
    });

    $('btnShareAdminCreds').addEventListener('click', () => {
      const adminCreds = getAdminCredsLocal();
      if (!adminCreds) return showToast('No admin credentials found');
      
      const data = {
        version: '1.0',
        exportedAt: nowIso(),
        admin: adminCreds
      };
      
      const jsonStr = JSON.stringify(data);
      const qrData = encodeURIComponent(jsonStr);
      const qrUrl = `https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=${qrData}&chld=L|1`;
      
      const win = window.open('', '_blank', 'width=400,height=500');
      win.document.write(`
        <html>
          <head><title>Admin Credentials QR</title></head>
          <body style="font-family: sans-serif; padding: 20px; text-align: center;">
            <h3>Admin Credentials QR</h3>
            <p>Scan to import admin credentials on another device</p>
            <img src="${qrUrl}" style="max-width: 100%; height: auto;" />
            <p style="margin-top: 20px; color: #666; font-size: 12px;">
              Username: ${adminCreds.username}<br>
              Scan this QR on another device's Admin Login page.
            </p>
          </body>
        </html>
      `);
    });

    // ========== LECTURER PANEL ==========
    $('importPinFile').addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (data.pin) { 
            setPinLocal(data.pin); 
            showToast('PIN imported to this device'); 
            $('lecturerPinInput').value = data.pin; 
          }
          else showToast('Invalid PIN file');
        } catch { showToast('Invalid PIN file'); }
      };
      reader.readAsText(f);
      e.target.value='';
    });

    $('btnPastePin').addEventListener('click', async () => {
      try {
        const txt = await navigator.clipboard.readText();
        const maybe = txt.trim();
        if (maybe && maybe.length >= 6) { 
          setPinLocal(maybe); 
          showToast('PIN pasted & saved (now works on this device)'); 
          $('lecturerPinInput').value = maybe; 
        }
        else showToast('Clipboard does not contain a valid PIN');
      } catch {
        const manual = prompt('Paste PIN here:');
        if (manual && manual.trim().length >= 6) { 
          setPinLocal(manual.trim()); 
          showToast('PIN saved for this device'); 
          $('lecturerPinInput').value = manual.trim(); 
        }
        else showToast('No PIN provided');
      }
    });

    // QR Scanner for PIN
    $('btnScanPinQr').addEventListener('click', () => {
      $('qrScannerPanel').classList.toggle('hidden');
    });

    $('btnStartScanner').addEventListener('click', () => {
      // Simple QR scanner simulation - in production, use a library like jsQR
      showToast('QR scanning requires a library. Use import file instead.');
    });

    $('btnLecturerUnlock').addEventListener('click', () => {
      const entered = $('lecturerPinInput').value.trim();
      if (!entered) return showToast('Enter PIN');
      if (entered === getPinLocal()) {
        state.lecturer.unlocked = true;
        $('lecturerLocked').classList.add('hidden');
        $('lecturerDashboard').classList.remove('hidden');
        renderDashboard();
        showToast('Dashboard unlocked - PIN works across all devices');
      } else {
        $('lecturerPinMsg').textContent='Incorrect PIN. Get PIN from Admin.';
        $('lecturerPinMsg').className='mt-2 text-xs text-rose-700 font-semibold text-center';
      }
    });

    $('btnLecturerLock').addEventListener('click', () => {
      state.lecturer.unlocked = false;
      $('lecturerLocked').classList.remove('hidden');
      $('lecturerDashboard').classList.add('hidden');
      $('lecturerPinInput').value='';
      showToast('Dashboard locked');
    });

    // Records export/import/merge
    $('btnExportRecords')?.addEventListener('click', () => {
      const records = getStoredRecords();
      if (!records.length) return showToast('No records to export');
      const payload = { exportedAt: nowIso(), records };
      const blob = new Blob([JSON.stringify(payload)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `nsuk_urp_records_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast('Records exported (JSON) - Import on other devices');
    });

    $('importRecordsFile')?.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);
          let incoming = [];
          if (Array.isArray(parsed)) incoming = parsed;
          else if (parsed && Array.isArray(parsed.records)) incoming = parsed.records;
          else if (parsed && parsed.matric) incoming=[parsed];
          else { showToast('Invalid records file'); return; }
          
          const existing = getStoredRecords();
          const merged = [...existing, ...incoming].filter((v,i,a) => 
            a.findIndex(t => t.id === v.id) === i
          );
          setStoredRecords(merged);
          showToast('Records imported from another device');
          renderDashboard();
          renderStudentRecords();
        } catch { showToast('Invalid records file'); }
      };
      reader.readAsText(f);
      e.target.value='';
    });

    // ========== SHARE ALL DATA BUTTON ==========
    $('btnShareAll').addEventListener('click', () => {
      const options = `
        <div style="padding: 20px; font-family: sans-serif;">
          <h3 style="margin-bottom: 15px;">Cross-Device Data Sharing</h3>
          <button onclick="exportAll()" style="display: block; width: 100%; padding: 10px; margin-bottom: 10px; background: #0f1b3d; color: white; border: none; border-radius: 8px; cursor: pointer;">
            Export All Data (File)
          </button>
          <button onclick="shareAsQR()" style="display: block; width: 100%; padding: 10px; margin-bottom: 10px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
            Share as QR Code
          </button>
          <label style="display: block; width: 100%; padding: 10px; text-align: center; background: #10b981; color: white; border-radius: 8px; cursor: pointer;">
            Import All Data
            <input type="file" id="importAllDataFile" accept="application/json" style="display: none;" onchange="handleImportAll(this.files[0])">
          </label>
          <p style="margin-top: 15px; font-size: 12px; color: #666;">
            This exports/imports: PIN, Admin credentials, Student accounts, Attendance records
          </p>
        </div>
      `;
      
      const win = window.open('', '_blank', 'width=400,height=300');
      win.document.write(`
        <html>
          <head><title>Share All Data</title></head>
          <body>${options}</body>
          <script>
            function exportAll() {
              window.opener.postMessage({type: 'exportAll'}, '*');
              window.close();
            }
            function shareAsQR() {
              window.opener.postMessage({type: 'shareAsQR'}, '*');
              window.close();
            }
            function handleImportAll(file) {
              window.opener.postMessage({type: 'importAll', file: file.name}, '*');
              // File content will be handled by the main window
              window.close();
            }
          <\/script>
        </html>
      `);
    });

    // Handle messages from the share window
    window.addEventListener('message', (event) => {
      if (event.data.type === 'exportAll') {
        exportAllData();
      } else if (event.data.type === 'shareAsQR') {
        shareAllDataAsQR();
      } else if (event.data.type === 'importAll') {
        // Trigger file input for import
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file) importAllData(file);
        };
        input.click();
      }
    });

    // ========== render functions ==========
    function renderDashboard() {
      const records = getStoredRecords();
      const tbody = $('recordsTbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      if (!records.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-slate-500">No records yet</td></tr>';
        return;
      }
      records.forEach(r => {
        const tr = document.createElement('tr');
        tr.className='border-b border-slate-100';
        tr.innerHTML = `<td class="px-4 py-3 font-medium">${r.name || ''}</td>
          <td class="px-4 py-3">${r.matric || ''}</td>
          <td class="px-4 py-3">${r.course || ''}</td>
          <td class="px-4 py-3 text-sm">${r.date} ${r.time}</td>
          <td class="px-4 py-3 text-xs">${r.lat?.toFixed?.(6) || ''}</td>
          <td class="px-4 py-3 text-xs">${r.lon?.toFixed?.(6) || ''}</td>
          <td class="px-4 py-3"><button class="text-xs underline text-blue-600" onclick="previewFace('${r.id}')">View</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function previewFace(id) {
      const records = getStoredRecords();
      const r = records.find(x => String(x.id) === String(id));
      if (!r) return alert('Record not found');
      const win = window.open('', '_blank', 'width=520,height=640,scrollbars=yes');
      win.document.write(`<title>Face preview</title><div style="font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; padding:12px;">
        <h3>${r.name || ''} — ${r.matric || ''}</h3>
        <p style="color:#555">${r.course || ''} — ${r.date} ${r.time}</p>
        <p style="margin-top:8px;color:#555">Lat: ${r.lat?.toFixed?.(6) || ''} Lon: ${r.lon?.toFixed?.(6) || ''}</p>
        <div style="margin-top:12px;border:1px solid #eee;padding:8px;background:#fafafa">${r.faceDataUrl ? `<img src="${r.faceDataUrl}" style="max-width:100%;height:auto;border-radius:8px" />` : '<div style="color:#666">No image</div>'}</div>
      </div>`);
    }
    window.previewFace = previewFace;

    $('btnDownloadPdf').addEventListener('click', () => {
      const records = getStoredRecords();
      if (!records.length) return showToast('No records to export');
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text('NSUK URP Attendance Records', 14, 20);
      doc.setFontSize(10);
      doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);
      const headers = [['Name','Matric','Course','Date','Time','Latitude','Longitude']];
      const data = records.map(r => [r.name||'', r.matric||'', r.course||'', r.date||'', r.time||'', r.lat?.toFixed(6)||'', r.lon?.toFixed(6)||'']);
      doc.autoTable({ head: headers, body: data, startY: 40 });
      doc.save(`NSUK_URP_Attendance_${new Date().toISOString().slice(0,10)}.pdf`);
      showToast('PDF downloaded');
    });

    // tabs
    function showPanel(panel) {
      $('panelStudent').classList.add('hidden');
      $('panelLecturer').classList.add('hidden');
      $('panelAdmin').classList.add('hidden');
      $('tabStudent').className = 'rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-white text-slate-800 hover:bg-slate-50';
      $('tabLecturer').className = 'rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-white text-slate-800 hover:bg-slate-50';
      $('tabAdminLogin').className = 'rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-white text-slate-800 hover:bg-slate-50 ml-auto';
      if (panel === 'student') { $('panelStudent').classList.remove('hidden'); $('tabStudent').className = 'rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-slate-900 text-white'; }
      else if (panel === 'lecturer') { $('panelLecturer').classList.remove('hidden'); $('tabLecturer').className = 'rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-slate-900 text-white'; }
      else if (panel === 'admin') { $('panelAdmin').classList.remove('hidden'); $('tabAdminLogin').className = 'rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-slate-900 text-white ml-auto'; }
    }
    $('tabStudent').addEventListener('click', ()=>showPanel('student'));
    $('tabLecturer').addEventListener('click', ()=>showPanel('lecturer'));
    $('tabAdminLogin').addEventListener('click', ()=>showPanel('admin'));

    $('btnOpenHelp').addEventListener('click', () => {
      alert(`CROSS-DEVICE ATTENDANCE SYSTEM

1) ADMIN SETUP:
   - Create admin account (once)
   - Generate PIN for lecturers
   - Use "Share All Data" to export PIN, admin credentials, and student accounts

2) LECTURER ACCESS (Any Device):
   - Get PIN from Admin via QR code, file, or copy-paste
   - Enter PIN to unlock dashboard
   - View/export attendance records

3) STUDENT ACCESS (Any Device):
   - Create account on any device
   - Accounts work across devices when data is shared
   - Submit attendance with location + face capture

4) CROSS-DEVICE DATA SHARING:
   - Use "Share All Data" button to export/import everything
   - PIN, admin credentials, student accounts, and records
   - Works without internet when using file export/import
   - With Firebase: automatic sync across devices

5) WITHOUT FIREBASE:
   - Admin exports data and shares via file/QR
   - Lecturers import PIN file/QR
   - Students can login on any device with imported accounts`);
    });

    document.addEventListener('DOMContentLoaded', () => {
      $('year').textContent = new Date().getFullYear();
      ensurePinLocal();
      revealAdminPin();
      updateDateTimePreview();
      setInterval(updateDateTimePreview, 1000);

      initStudentAuth();
      $('courseCode').addEventListener('input', updateSubmitState);

      initFirebaseIfConfigured();

      renderDashboard();
      showPanel('student');
      updateSubmitState();
    });
  </script>
</body>
</html>
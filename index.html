<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f1b3d" />
  <title>NSUK URP — E-Attendance</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root { color-scheme: light; }
    html { scroll-behavior: smooth; }
    .shimmer {
      background: linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.18), rgba(255,255,255,0.05));
      background-size: 200% 100%;
      animation: shimmer 2.2s ease-in-out infinite;
    }
    @keyframes shimmer { 0% { background-position: 0% 0; } 100% { background-position: 200% 0; } }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    @media print { .no-print { display: none !important; } body { background: #fff !important; } }

    /* small helpers for new UI */
    .small-muted { font-size: .78rem; color: #6b7280; }
    .note-box { font-size: .82rem; color: #374151; background: #f8fafc; border: 1px solid #e6eef6; padding: .6rem; border-radius: .75rem; }
    .word-break-all { word-break: break-all; }
  </style>
</head>

<body class="min-h-screen bg-slate-50 text-slate-900">
  <!-- Header -->
  <header class="no-print">
    <div class="bg-[#0f1b3d] text-white">
      <div class="mx-auto max-w-6xl px-4 py-5 sm:py-6">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div class="flex items-start gap-3">
            <div class="shimmer mt-0.5 h-10 w-10 rounded-xl bg-white/10 ring-1 ring-white/15 flex items-center justify-center">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2l9 4.5-9 4.5L3 6.5 12 2Z" stroke="rgba(255,255,255,0.95)" stroke-width="1.6" stroke-linejoin="round"/>
                <path d="M6.5 9.2V14c0 2.2 2.5 4 5.5 4s5.5-1.8 5.5-4V9.2" stroke="rgba(255,255,255,0.95)" stroke-width="1.6" stroke-linecap="round"/>
                <path d="M21 6.5v6" stroke="rgba(255,255,255,0.95)" stroke-width="1.6" stroke-linecap="round"/>
                <circle cx="21" cy="13.5" r="1" fill="rgba(255,255,255,0.95)"/>
              </svg>
            </div>
            <div>
              <h1 class="text-base sm:text-lg font-semibold tracking-tight">Department of Urban and Regional Planning</h1>
              <p class="text-sm text-white/80">Nasarawa State University, Keffi (NSUK) — E-Attendance</p>
            </div>
          </div>
          <div class="flex flex-wrap items-center gap-2 sm:gap-3">
            <div class="rounded-xl bg-white/10 ring-1 ring-white/15 px-3 py-2">
              <p class="text-xs text-white/70">Status</p>
              <p id="statusSummary" class="text-sm font-medium">Ready</p>
            </div>
            <button id="btnOpenHelp" class="rounded-xl bg-white text-[#0f1b3d] px-3 py-2 text-sm font-semibold hover:bg-white/95">Instructions</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <nav class="border-b border-slate-200 bg-white">
      <div class="mx-auto max-w-6xl px-4">
        <div class="flex gap-2 py-3" role="tablist">
          <button id="tabStudent" class="rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-slate-900 text-white" role="tab" aria-selected="true">Student Attendance</button>
          <button id="tabLecturer" class="rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-white text-slate-800 hover:bg-slate-50" role="tab" aria-selected="false">Lecturer Dashboard</button>
          <button id="tabAdminLogin" class="rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-white text-slate-800 hover:bg-slate-50 ml-auto">Admin Login</button>
        </div>
      </div>
    </nav>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-6 sm:py-8">

    <!-- Student Panel -->
    <section id="panelStudent" role="tabpanel">
      <div class="grid gap-4 lg:grid-cols-12">
        <div class="lg:col-span-8">
          <div class="rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm">
            <div class="border-b border-slate-200 px-5 py-4 sm:px-6">
              <h2 class="text-lg font-semibold">Student Attendance</h2>
              <p class="mt-1 text-sm text-slate-600">
                Capture location + face (or upload image) then fill the form. Use "Export Draft" / "Generate QR" to move work between devices.
              </p>
            </div>

            <div class="px-5 py-5 sm:px-6">
              <!-- Step 1: Location -->
              <div class="rounded-2xl border border-slate-200 bg-slate-50/70 p-4">
                <div class="flex items-start justify-between gap-3">
                  <div class="min-w-0">
                    <div class="flex items-center gap-2">
                      <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-[#0f1b3d] text-white text-sm font-bold">1</span>
                      <h3 class="text-base font-semibold">Enable Location</h3>
                    </div>
                    <p class="mt-1 text-sm text-slate-600">We capture your latitude and longitude for attendance verification.</p>
                  </div>
                  <div class="flex gap-2 items-center">
                    <button id="btnGetLocation" class="shrink-0 rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">
                      Capture Location
                    </button>
                    <button id="btnToggleManualCoords" class="shrink-0 rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50">
                      Manual coords
                    </button>
                  </div>
                </div>

                <div id="manualCoordsPanel" class="mt-3 hidden grid gap-2 sm:grid-cols-3">
                  <div>
                    <label class="text-xs text-slate-500">Latitude (manual)</label>
                    <input id="manualLat" type="text" inputmode="decimal" class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm tabular-nums" placeholder="e.g., 8.524139" />
                  </div>
                  <div>
                    <label class="text-xs text-slate-500">Longitude (manual)</label>
                    <input id="manualLon" type="text" inputmode="decimal" class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm tabular-nums" placeholder="e.g., 7.123456" />
                  </div>
                  <div class="flex items-end">
                    <button id="btnApplyManualCoords" class="w-full rounded-xl bg-emerald-600 px-3 py-2 text-sm font-semibold text-white hover:bg-emerald-700">Apply</button>
                  </div>
                </div>

                <div class="mt-3 grid gap-2 sm:grid-cols-3">
                  <div class="rounded-xl bg-white p-3 ring-1 ring-slate-200">
                    <p class="text-xs text-slate-500">Location Status</p>
                    <p id="locStatus" class="mt-1 text-sm font-semibold text-slate-800">Not captured</p>
                  </div>
                  <div class="rounded-xl bg-white p-3 ring-1 ring-slate-200">
                    <p class="text-xs text-slate-500">Latitude</p>
                    <p id="latText" class="mt-1 text-sm font-semibold tabular-nums">—</p>
                  </div>
                  <div class="rounded-xl bg-white p-3 ring-1 ring-slate-200">
                    <p class="text-xs text-slate-500">Longitude</p>
                    <p id="lonText" class="mt-1 text-sm font-semibold tabular-nums">—</p>
                  </div>
                </div>

                <div id="locError" class="mt-3 hidden rounded-xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-800"></div>
                <div class="mt-3 small-muted">If geolocation isn't available, use Manual coords or Export Draft / Generate QR to finish on another device.</div>
              </div>

              <!-- Step 2: Face Capture -->
              <div class="mt-4 rounded-2xl border border-slate-200 bg-slate-50/70 p-4">
                <div class="flex items-start justify-between gap-3">
                  <div class="min-w-0">
                    <div class="flex items-center gap-2">
                      <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-[#0f1b3d] text-white text-sm font-bold">2</span>
                      <h3 class="text-base font-semibold">Capture Face</h3>
                    </div>
                    <p class="mt-1 text-sm text-slate-600">Use your front camera and capture a clear image. If camera isn't available, upload an image file.</p>
                  </div>
                  <div class="flex gap-2">
                    <button id="btnStartCamera" class="rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50">
                      Start Camera
                    </button>
                    <button id="btnCaptureFace" class="rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                      Capture
                    </button>
                    <label for="faceFile" class="rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50 cursor-pointer">Upload</label>
                    <input id="faceFile" type="file" accept="image/*" class="hidden" />
                  </div>
                </div>

                <div class="mt-4 grid gap-3 sm:grid-cols-2">
                  <div class="rounded-2xl bg-white ring-1 ring-slate-200 overflow-hidden">
                    <div class="border-b border-slate-200 px-3 py-2">
                      <p class="text-xs font-semibold text-slate-600">Live Camera</p>
                    </div>
                    <div class="p-3">
                      <video id="video" class="w-full rounded-xl bg-slate-900/5" autoplay muted playsinline></video>
                      <p id="camHint" class="mt-2 text-xs text-slate-500">Tip: Ensure your face is well-lit and centered.</p>
                      <div id="camError" class="mt-2 hidden rounded-xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-800"></div>
                    </div>
                  </div>

                  <div class="rounded-2xl bg-white ring-1 ring-slate-200 overflow-hidden">
                    <div class="border-b border-slate-200 px-3 py-2 flex items-center justify-between">
                      <p class="text-xs font-semibold text-slate-600">Captured Image</p>
                      <button id="btnRetake" class="text-xs font-semibold text-slate-700 hover:text-slate-900 disabled:opacity-50" disabled>Retake</button>
                    </div>
                    <div class="p-3">
                      <div class="aspect-video w-full rounded-xl bg-slate-900/5 flex items-center justify-center overflow-hidden">
                        <img id="facePreview" alt="Captured face preview" class="hidden h-full w-full object-cover" />
                        <div id="faceEmpty" class="text-sm text-slate-500">No image captured yet</div>
                      </div>
                      <div class="mt-2 grid gap-2 sm:grid-cols-2">
                        <div class="rounded-xl bg-slate-50 ring-1 ring-slate-200 p-3">
                          <p class="text-xs text-slate-500">Face Status</p>
                          <p id="faceStatus" class="mt-1 text-sm font-semibold">Not captured</p>
                        </div>
                        <div class="rounded-xl bg-slate-50 ring-1 ring-slate-200 p-3">
                          <p class="text-xs text-slate-500">Image Quality</p>
                          <p id="faceQuality" class="mt-1 text-sm font-semibold">—</p>
                        </div>
                      </div>
                      <div class="mt-3 small-muted">You may upload an image or import a draft from another device to finish and submit.</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 3: Attendance Form -->
              <div class="mt-4 rounded-2xl border border-slate-200 bg-slate-50/70 p-4">
                <div class="flex items-start gap-3">
                  <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-[#0f1b3d] text-white text-sm font-bold">3</span>
                  <div>
                    <h3 class="text-base font-semibold">Attendance Form</h3>
                    <p class="mt-1 text-sm text-slate-600">
                      The form is unlocked after successful face capture. Submission requires location + face + required fields.
                    </p>
                  </div>
                </div>

                <form id="attendanceForm" class="mt-4" autocomplete="on" novalidate>
                  <fieldset id="formFieldset" disabled class="opacity-60">
                    <div class="grid gap-3 sm:grid-cols-2">
                      <div>
                        <label for="studentName" class="block text-sm font-semibold text-slate-800">Name <span class="text-rose-600">*</span></label>
                        <input id="studentName" name="name" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm" placeholder="e.g., Abdullahi Suleiman" />
                      </div>
                      <div>
                        <label for="matricNo" class="block text-sm font-semibold text-slate-800">Matric Number <span class="text-rose-600">*</span></label>
                        <input id="matricNo" name="matric" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm" placeholder="e.g., FT26URP1234" />
                      </div>
                      <div class="sm:col-span-2">
                        <label for="courseCode" class="block text-sm font-semibold text-slate-800">Course Code <span class="text-rose-600">*</span></label>
                        <input id="courseCode" name="course" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm" placeholder="e.g., URP 111" />
                      </div>
                    </div>

                    <div class="mt-4 grid gap-2 sm:grid-cols-3">
                      <div class="rounded-xl bg-white p-3 ring-1 ring-slate-200">
                        <p class="text-xs text-slate-500">Date</p>
                        <p id="dateText" class="mt-1 text-sm font-semibold">—</p>
                      </div>
                      <div class="rounded-xl bg-white p-3 ring-1 ring-slate-200">
                        <p class="text-xs text-slate-500">Time</p>
                        <p id="timeText" class="mt-1 text-sm font-semibold">—</p>
                      </div>
                      <div class="rounded-xl bg-white p-3 ring-1 ring-slate-200">
                        <p class="text-xs text-slate-500">Verification</p>
                        <p id="verifyText" class="mt-1 text-sm font-semibold">Pending</p>
                      </div>
                    </div>

                    <div class="mt-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                      <div class="text-xs text-slate-600">
                        <span class="font-semibold">Auto-captured:</span> Date/Time, Latitude/Longitude, Face image.
                      </div>
                      <div class="flex gap-2">
                        <button id="btnExportDraft" type="button" class="rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50">Export Draft (JSON)</button>
                        <button id="btnGenerateQr" type="button" class="rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50">Generate QR</button>
                        <button id="btnShareDraft" type="button" class="rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50">Share Draft</button>
                        <button id="btnSubmit" type="submit" class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                          Submit Attendance
                        </button>
                      </div>
                    </div>
                  </fieldset>

                  <div id="formLockedNote" class="mt-3 rounded-xl border border-slate-200 bg-white p-3 text-sm text-slate-700">
                    <span class="font-semibold">Locked:</span> Start the camera and capture your face to unlock the attendance form.
                  </div>

                  <div class="mt-3 flex gap-2 items-center">
                    <label class="small-muted">Import draft (JSON):</label>
                    <input id="importDraftFile" type="file" accept="application/json" class="ml-2" />
                  </div>

                  <div id="qrPanel" class="mt-3 hidden">
                    <div class="flex gap-3 items-start">
                      <div>
                        <img id="qrImage" alt="QR code" class="rounded-lg ring-1 ring-slate-200" />
                      </div>
                      <div class="flex-1">
                        <p class="text-sm font-semibold">Scan this QR from another device to prefill the attendance form.</p>
                        <p class="small-muted mt-1">If QR fails use JSON export instead.</p>
                        <div id="qrLinkBox" class="mt-2 word-break-all"></div>
                      </div>
                    </div>
                  </div>

                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Quick Info -->
        <aside class="lg:col-span-4">
          <div class="rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm">
            <div class="border-b border-slate-200 px-5 py-4 sm:px-6">
              <h3 class="text-base font-semibold">Quick Checklist</h3>
              <p class="mt-1 text-sm text-slate-600">Ensure all items are completed before submitting.</p>
            </div>
            <div class="px-5 py-5 sm:px-6">
              <ul class="space-y-3">
                <li class="flex items-start gap-3">
                  <span id="checkLoc" class="mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg bg-slate-100 text-slate-700 ring-1 ring-slate-200" aria-hidden="true">—</span>
                  <div>
                    <p class="text-sm font-semibold">Location captured</p>
                    <p class="text-xs text-slate-600">Allow location access when prompted or use manual coords.</p>
                  </div>
                </li>
                <li class="flex items-start gap-3">
                  <span id="checkFace" class="mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg bg-slate-100 text-slate-700 ring-1 ring-slate-200" aria-hidden="true">—</span>
                  <div>
                    <p class="text-sm font-semibold">Face captured</p>
                    <p class="text-xs text-slate-600">Use the front camera; ensure clarity, or upload image file.</p>
                  </div>
                </li>
                <li class="flex items-start gap-3">
                  <span id="checkFields" class="mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg bg-slate-100 text-slate-700 ring-1 ring-slate-200" aria-hidden="true">—</span>
                  <div>
                    <p class="text-sm font-semibold">Required fields filled</p>
                    <p class="text-xs text-slate-600">Name, matric number, course code.</p>
                  </div>
                </li>
              </ul>

              <div class="mt-5 rounded-2xl border border-slate-200 bg-slate-50 p-4">
                <p class="text-xs font-semibold text-slate-700">Privacy (Local Device Only)</p>
                <p class="mt-1 text-xs text-slate-600">
                  Attendance records (including the captured image) are stored in your browser's local storage on this device.
                  No data is uploaded to any server unless you manually share or import them.
                </p>
              </div>

              <div class="mt-4 rounded-2xl border border-slate-200 bg-white p-4">
                <p class="text-xs font-semibold text-slate-700">Support</p>
                <p class="mt-1 text-xs text-slate-600">
                  If location/camera fails, confirm you are using HTTPS and that permissions are allowed in your browser settings.
                </p>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <!-- Lecturer Panel (PIN Access Only) -->
    <section id="panelLecturer" role="tabpanel" class="hidden">
      <div class="grid gap-6 lg:grid-cols-12">
        <div class="lg:col-span-4">
          <div class="rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm">
            <div class="border-b border-slate-200 px-5 py-4 sm:px-6">
              <h2 class="text-lg font-semibold">Lecturer Access</h2>
              <p class="mt-1 text-sm text-slate-600">Enter the PIN shared by Admin (or import PIN file / paste PIN to accept an externally generated PIN)</p>
            </div>
            <div class="p-5 space-y-4">
              <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
                <label class="block text-sm font-semibold text-slate-800">Lecturer PIN</label>
                <input id="lecturerPinInput" type="text" inputmode="numeric" class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-lg tracking-widest text-center" placeholder="••••••" maxlength="6" />
                <button id="btnLecturerUnlock" class="mt-3 w-full rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">Unlock Dashboard</button>
                <p id="lecturerPinMsg" class="mt-2 text-xs text-center"></p>

                <div class="mt-3 grid grid-cols-2 gap-2">
                  <label for="importPinFile" class="rounded-xl bg-white px-3 py-2 text-sm text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50 cursor-pointer text-center">Import PIN (file)</label>
                  <button id="btnPastePin" class="rounded-xl bg-white px-3 py-2 text-sm text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50">Paste PIN</button>
                  <input id="importPinFile" type="file" accept="application/json" class="hidden" />
                  <input id="pastePinInput" type="text" placeholder="Paste PIN here" class="hidden rounded-xl border border-slate-300 px-2 py-2" />
                </div>

              </div>
            </div>
          </div>
        </div>

        <div class="lg:col-span-8">
          <div id="lecturerLocked" class="rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm p-10 text-center">
            <div class="mx-auto w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mb-4">
              <svg class="w-10 h-10 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
            </div>
            <h3 class="text-lg font-semibold">Dashboard Locked</h3>
            <p class="text-sm text-slate-600 mt-1">Enter the 6-digit PIN to view attendance records.</p>
          </div>

          <div id="lecturerDashboard" class="hidden rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm">
            <div class="border-b border-slate-200 px-5 py-4 sm:px-6">
              <div class="flex items-center justify-between">
                <div>
                  <h2 class="text-lg font-semibold">Attendance Dashboard</h2>
                  <p class="text-sm text-slate-600">View and export records. Use Import to merge records received from other devices.</p>
                </div>
                <div class="flex gap-2">
                  <button id="btnDownloadPdf" class="rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white">Download PDF</button>
                  <button id="btnExportRecords" class="rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200">Export Records (JSON)</button>
                  <label for="importRecordsFile" class="rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50 cursor-pointer">Import Records</label>
                  <button id="btnLecturerLock" class="rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200">Lock</button>
                  <input id="importRecordsFile" type="file" accept="application/json" class="hidden" />
                </div>
              </div>
            </div>
            <div class="p-5">
              <div class="overflow-x-auto rounded-2xl ring-1 ring-slate-200">
                <table class="min-w-full bg-white">
                  <thead class="bg-slate-50"><tr class="text-left text-xs font-semibold text-slate-600">
                    <th class="px-4 py-3">Name</th><th class="px-4 py-3">Matric</th><th class="px-4 py-3">Course</th>
                    <th class="px-4 py-3">Date & Time</th><th class="px-4 py-3">Lat</th><th class="px-4 py-3">Lon</th><th class="px-4 py-3">Face</th>
                  </tr></thead>
                  <tbody id="recordsTbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Admin Panel (Login + PIN Management) -->
    <section id="panelAdmin" role="tabpanel" class="hidden">
      <div class="max-w-md mx-auto">
        <div class="rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm">
          <div class="border-b border-slate-200 px-6 py-5">
            <h2 class="text-lg font-semibold" id="adminTitle">Admin Login</h2>
          </div>
          <div class="p-6 space-y-5">

            <!-- Login Form -->
            <div id="adminLoginForm">
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-semibold text-slate-800">Username</label>
                  <input id="adminUsername" type="text" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="admin" />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-slate-800">Password</label>
                  <input id="adminPassword" type="password" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2" />
                </div>
                <button id="btnAdminLogin" class="w-full rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">Login</button>
                <button id="btnAdminSignup" class="w-full rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50">Create Admin Account (First Time)</button>
              </div>
            </div>

            <!-- Admin Dashboard (after login) -->
            <div id="adminDashboardSection" class="hidden space-y-5">
              <div class="text-center">
                <p class="text-sm text-emerald-700 font-semibold">Admin logged in</p>
                <button id="btnAdminLogout" class="mt-2 text-xs text-slate-600 underline">Logout</button>
              </div>

              <div class="rounded-2xl border border-amber-200 bg-amber-50 p-4 text-sm">
                <p><strong>Admin Tools:</strong> Generate, export and manage the PIN that lecturers will use. To share the PIN across devices use Export PIN (JSON) or Generate PIN QR.</p>
              </div>

              <div class="space-y-3">
                <div class="rounded-xl bg-slate-50 ring-1 ring-slate-200 p-4 text-center">
                  <p class="text-xs text-slate-600">Current Lecturer PIN</p>
                  <p id="adminPinDisplay" class="text-3xl font-bold tracking-widest mt-2">••••••</p>
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <button id="btnCopyAdminPin" class="rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white">Copy PIN</button>
                  <button id="btnResetAdminPin" class="rounded-xl bg-rose-600 px-4 py-2 text-sm font-semibold text-white">Reset PIN</button>
                </div>

                <div class="grid grid-cols-2 gap-3 mt-2">
                  <button id="btnExportPin" class="rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200">Export PIN (JSON)</button>
                  <button id="btnGeneratePinQr" class="rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200">Generate PIN QR</button>
                </div>

                <div class="mt-2">
                  <label for="importPinAdminFile" class="rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50 cursor-pointer">Import PIN (file)</label>
                  <input id="importPinAdminFile" type="file" accept="application/json" class="hidden" />
                </div>

                <div id="adminPinQrPanel" class="mt-3 hidden">
                  <img id="adminPinQrImage" alt="PIN QR" class="rounded-lg ring-1 ring-slate-200" />
                  <div id="adminPinQrLink" class="mt-2 word-break-all small-muted"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="no-print border-t border-slate-200 bg-white">
    <div class="mx-auto max-w-6xl px-4 py-6">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <p class="text-xs text-slate-600">© <span id="year"></span> NSUK — Department of Urban and Regional Planning.</p>
        <p class="text-xs text-slate-500">Developed by A. Suleiman and Powered by Ramsulone Innovation & Services Ltd.</p>
      </div>
    </div>
  </footer>

  <!-- Toast -->
  <div id="toast" class="pointer-events-none fixed bottom-4 left-1/2 -translate-x-1/2 z-50 hidden">
    <div class="rounded-2xl bg-slate-900 text-white px-4 py-3 shadow-lg ring-1 ring-white/10">
      <p id="toastText" class="text-sm font-semibold">—</p>
    </div>
  </div>

  <!-- Hidden canvas for capture -->
  <canvas id="captureCanvas" class="hidden"></canvas>

  <script>
    const $ = id => document.getElementById(id);
    const STORAGE_KEY_RECORDS = 'nsuk_urp_attendance_records_v1';
    const STORAGE_KEY_PIN = 'nsuk_urp_lecturer_pin_v1';
    const STORAGE_KEY_ADMIN = 'nsuk_urp_admin_creds_v1';

    const state = {
      location: { ok: false, lat: null, lon: null, accuracy: null, denied: false },
      face: { ok: false, dataUrl: null, w: null, h: null, fromUpload: false },
      camera: { stream: null, started: false },
      admin: { loggedIn: false },
      lecturer: { unlocked: false }
    };

    // ========== UTILITIES ==========
    function showToast(msg) {
      $('toastText').textContent = msg;
      $('toast').classList.remove('hidden');
      clearTimeout(showToast.t);
      showToast.t = setTimeout(() => $('toast').classList.add('hidden'), 3000);
    }

    function safeParseJSON(s) {
      try { return JSON.parse(s); } catch { return null; }
    }

    function nowIso() { return new Date().toISOString(); }

    // ========== UI state helpers ==========
    function setStatusSummary() {
      const pieces = [];
      pieces.push(state.location.ok ? 'Location ✓' : (state.location.denied ? 'Location denied' : 'Location …'));
      pieces.push(state.face.ok ? 'Face ✓' : 'Face …');
      $('statusSummary').textContent = pieces.join(' • ');
    }

    function setChecklist() {
      const mark = (ok) => ok ? '✓' : '—';
      const cls = (ok) => ok ? 'bg-emerald-50 text-emerald-700 ring-emerald-200' : 'bg-slate-100 text-slate-700 ring-slate-200';

      $('checkLoc').textContent = mark(state.location.ok);
      $('checkLoc').className = `mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg ring-1 ${cls(state.location.ok)}`;

      $('checkFace').textContent = mark(state.face.ok);
      $('checkFace').className = `mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg ring-1 ${cls(state.face.ok)}`;

      const fieldsOk = requiredFieldsFilled();
      $('checkFields').textContent = mark(fieldsOk);
      $('checkFields').className = `mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg ring-1 ${cls(fieldsOk)}`;

      const ver = (state.location.ok && state.face.ok && fieldsOk) ? 'Ready to submit' : 'Pending';
      $('verifyText').textContent = ver;

      setStatusSummary();
    }

    function requiredFieldsFilled() {
      const name = $('studentName').value.trim();
      const matric = $('matricNo').value.trim();
      const course = $('courseCode').value.trim();
      return Boolean(name && matric && course);
    }

    function updateDateTimePreview() {
      const d = new Date();
      const pad = n => String(n).padStart(2, '0');
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      $('dateText').textContent = `${pad(d.getDate())} ${months[d.getMonth()]} ${d.getFullYear()}`;
      $('timeText').textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function updateSubmitState() {
      const unlocked = state.face.ok;
      $('formFieldset').disabled = !unlocked;
      $('formFieldset').classList.toggle('opacity-60', !unlocked);
      $('formLockedNote').classList.toggle('hidden', unlocked);

      const canSubmit = state.location.ok && state.face.ok && requiredFieldsFilled();
      $('btnSubmit').disabled = !canSubmit;

      setChecklist();
    }

    // ========== Local storage helpers ==========
    function getStoredRecords() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY_RECORDS) || '[]');
    }
    function setStoredRecords(arr) {
      localStorage.setItem(STORAGE_KEY_RECORDS, JSON.stringify(arr || []));
    }
    function getAdminCreds() {
      const data = localStorage.getItem(STORAGE_KEY_ADMIN);
      return data ? JSON.parse(data) : null;
    }
    function saveAdminCreds(username, password) {
      localStorage.setItem(STORAGE_KEY_ADMIN, JSON.stringify({ username, password }));
    }
    function ensurePin() {
      if (!localStorage.getItem(STORAGE_KEY_PIN)) {
        localStorage.setItem(STORAGE_KEY_PIN, String(Math.floor(100000 + Math.random() * 900000)));
      }
    }
    function getPin() {
      ensurePin();
      return localStorage.getItem(STORAGE_KEY_PIN);
    }
    function setPin(pin) {
      if (!pin || String(pin).trim().length < 6) return false;
      localStorage.setItem(STORAGE_KEY_PIN, String(pin).trim());
      return true;
    }

    // ========== LOCATION ==========
    $('btnGetLocation').addEventListener('click', () => {
      if (!navigator.geolocation) {
        showToast('Geolocation not supported');
        return;
      }
      $('locStatus').textContent = 'Requesting...';
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude, accuracy } = pos.coords;
          state.location.ok = true;
          state.location.lat = latitude;
          state.location.lon = longitude;
          state.location.accuracy = accuracy;
          $('locStatus').textContent = `Captured (±${Math.round(accuracy)}m)`;
          $('latText').textContent = latitude.toFixed(6);
          $('lonText').textContent = longitude.toFixed(6);
          $('locError').classList.add('hidden');
          showToast('Location captured');
          updateSubmitState();
        },
        err => {
          state.location.ok = false;
          state.location.denied = err.code === err.PERMISSION_DENIED;
          $('locStatus').textContent = 'Error';
          $('locError').textContent = err.message;
          $('locError').classList.remove('hidden');
          showToast('Location error: ' + err.message);
          updateSubmitState();
        }
      );
    });

    $('btnToggleManualCoords').addEventListener('click', () => {
      $('manualCoordsPanel').classList.toggle('hidden');
    });
    $('btnApplyManualCoords').addEventListener('click', () => {
      const lat = parseFloat($('manualLat').value.trim());
      const lon = parseFloat($('manualLon').value.trim());
      if (Number.isFinite(lat) && Number.isFinite(lon)) {
        state.location.ok = true;
        state.location.lat = lat;
        state.location.lon = lon;
        state.location.accuracy = null;
        $('locStatus').textContent = 'Manual';
        $('latText').textContent = lat.toFixed(6);
        $('lonText').textContent = lon.toFixed(6);
        $('locError').classList.add('hidden');
        showToast('Manual coordinates applied');
        updateSubmitState();
      } else {
        showToast('Enter valid numeric coordinates');
      }
    });

    // ========== CAMERA / UPLOAD ==========
    $('btnStartCamera').addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user' }
        });
        state.camera.stream = stream;
        state.camera.started = true;
        $('video').srcObject = stream;
        $('btnCaptureFace').disabled = false;
        showToast('Camera started');
      } catch (err) {
        showToast('Camera error: ' + err.message);
      }
    });

    $('btnCaptureFace').addEventListener('click', () => {
      if (!state.camera.started) {
        showToast('Start camera first');
        return;
      }
      const canvas = $('captureCanvas');
      const video = $('video');
      canvas.width = video.videoWidth || 1280;
      canvas.height = video.videoHeight || 720;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.8);

      state.face.ok = true;
      state.face.dataUrl = dataUrl;
      state.face.w = canvas.width;
      state.face.h = canvas.height;
      state.face.fromUpload = false;

      $('facePreview').src = dataUrl;
      $('facePreview').classList.remove('hidden');
      $('faceEmpty').classList.add('hidden');
      $('faceStatus').textContent = 'Captured';
      $('faceQuality').textContent = `${canvas.width}×${canvas.height}`;
      $('btnRetake').disabled = false;

      // Stop camera
      if (state.camera.stream) {
        state.camera.stream.getTracks().forEach(t => t.stop());
        state.camera.stream = null;
        state.camera.started = false;
        $('video').srcObject = null;
      }

      showToast('Face captured');
      updateSubmitState();
    });

    $('btnRetake').addEventListener('click', () => {
      state.face.ok = false;
      state.face.dataUrl = null;
      state.face.w = null;
      state.face.h = null;
      state.face.fromUpload = false;
      $('facePreview').classList.add('hidden');
      $('faceEmpty').classList.remove('hidden');
      $('faceStatus').textContent = 'Not captured';
      $('faceQuality').textContent = '—';
      $('btnRetake').disabled = true;
      updateSubmitState();
    });

    // Upload image (file input)
    $('faceFile').addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      if (!f.type.startsWith('image/')) {
        showToast('Select an image file');
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        const img = new Image();
        img.onload = () => {
          state.face.ok = true;
          state.face.dataUrl = dataUrl;
          state.face.w = img.width;
          state.face.h = img.height;
          state.face.fromUpload = true;

          $('facePreview').src = dataUrl;
          $('facePreview').classList.remove('hidden');
          $('faceEmpty').classList.add('hidden');
          $('faceStatus').textContent = 'Uploaded';
          $('faceQuality').textContent = `${img.width}×${img.height}`;
          $('btnRetake').disabled = false;
          updateSubmitState();
          showToast('Image uploaded');
        };
        img.src = dataUrl;
      };
      reader.readAsDataURL(f);
    });

    // ========== SUBMIT ==========
    $('attendanceForm').addEventListener('submit', e => {
      e.preventDefault();
      if (!state.location.ok || !state.face.ok || !requiredFieldsFilled()) {
        showToast('Complete all steps first');
        return;
      }

      const d = new Date();
      const pad = n => String(n).padStart(2, '0');
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

      const record = {
        id: Date.now() + Math.floor(Math.random()*999),
        name: $('studentName').value.trim(),
        matric: $('matricNo').value.trim(),
        course: $('courseCode').value.trim(),
        date: `${pad(d.getDate())} ${months[d.getMonth()]} ${d.getFullYear()}`,
        time: `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`,
        lat: state.location.lat,
        lon: state.location.lon,
        accuracy: state.location.accuracy,
        faceDataUrl: state.face.dataUrl,
        faceFromUpload: !!state.face.fromUpload,
        createdAt: nowIso()
      };

      // Save to localStorage
      const records = getStoredRecords();
      records.unshift(record);
      setStoredRecords(records);

      showToast('Attendance submitted: ' + record.name);

      // Reset form but keep location
      $('studentName').value = '';
      $('matricNo').value = '';
      $('courseCode').value = '';

      // Reset face
      state.face.ok = false;
      state.face.dataUrl = null;
      state.face.w = null;
      state.face.h = null;
      state.face.fromUpload = false;
      $('facePreview').classList.add('hidden');
      $('faceEmpty').classList.remove('hidden');
      $('faceStatus').textContent = 'Not captured';
      $('faceQuality').textContent = '—';
      $('btnRetake').disabled = true;

      updateSubmitState();
      renderDashboard();
    });

    // ========== DRAFT EXPORT / IMPORT / QR ==========
    function createDraftObject() {
      const d = new Date();
      const pad = n => String(n).padStart(2, '0');
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      return {
        t: nowIso(),
        name: $('studentName').value.trim(),
        matric: $('matricNo').value.trim(),
        course: $('courseCode').value.trim(),
        date: `${pad(d.getDate())} ${months[d.getMonth()]} ${d.getFullYear()}`,
        time: `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`,
        lat: state.location.lat,
        lon: state.location.lon,
        accuracy: state.location.accuracy,
        faceDataUrl: state.face.dataUrl || null,
        faceFromUpload: !!state.face.fromUpload
      };
    }

    $('btnExportDraft').addEventListener('click', () => {
      const draft = createDraftObject();
      const blob = new Blob([JSON.stringify(draft)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `nsuk_urp_attendance_draft_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast('Draft exported (JSON)');
    });

    $('importDraftFile').addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (data.name) $('studentName').value = data.name;
          if (data.matric) $('matricNo').value = data.matric;
          if (data.course) $('courseCode').value = data.course;
          if (!isNaN(parseFloat(data.lat))) {
            state.location.ok = true;
            state.location.lat = parseFloat(data.lat);
            state.location.lon = parseFloat(data.lon);
            state.location.accuracy = data.accuracy || null;
            $('latText').textContent = state.location.lat?.toFixed(6) || '—';
            $('lonText').textContent = state.location.lon?.toFixed(6) || '—';
            $('locStatus').textContent = 'Imported';
          }
          if (data.faceDataUrl) {
            state.face.ok = true;
            state.face.dataUrl = data.faceDataUrl;
            $('facePreview').src = data.faceDataUrl;
            $('facePreview').classList.remove('hidden');
            $('faceEmpty').classList.add('hidden');
            $('faceStatus').textContent = 'Imported';
            $('faceQuality').textContent = '—';
            $('btnRetake').disabled = false;
            state.face.fromUpload = !!data.faceFromUpload;
          }
          updateSubmitState();
          showToast('Draft imported');
        } catch (err) {
          showToast('Invalid JSON file');
        }
      };
      reader.readAsText(f);
      e.target.value = '';
    });

    $('btnGenerateQr').addEventListener('click', () => {
      const draft = createDraftObject();
      const json = JSON.stringify(draft);
      if (json.length > 1800) {
        showToast('Draft too large for QR — use JSON export instead');
        $('qrPanel').classList.add('hidden');
        return;
      }
      const qrData = encodeURIComponent(json);
      const qrUrl = `https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=${qrData}&chld=L|1`;
      $('qrImage').src = qrUrl;
      $('qrPanel').classList.remove('hidden');
      $('qrLinkBox').innerHTML = `<a target="_blank" rel="noopener" class="text-xs underline" href="${qrUrl}">Open QR image (new tab)</a>`;
      showToast('QR generated — scan from another device');
    });

    $('btnShareDraft').addEventListener('click', async () => {
      const draft = createDraftObject();
      const text = JSON.stringify(draft);
      if (navigator.canShare && navigator.canShare({ files: [] })) {
        try {
          const file = new File([text], `nsuk_urp_attendance_draft_${new Date().toISOString().slice(0,10)}.json`, { type: 'application/json' });
          await navigator.share({ files: [file], title: 'Attendance draft', text: 'NSUK URP attendance draft' });
          showToast('Draft shared');
          return;
        } catch (err) {}
      }
      if (navigator.share) {
        try {
          await navigator.share({ title: 'Attendance draft', text });
          showToast('Draft shared');
        } catch (err) {
          showToast('Share cancelled or failed');
        }
      } else {
        try {
          await navigator.clipboard.writeText(text);
          showToast('Draft JSON copied to clipboard — paste on other device');
        } catch {
          showToast('Share unavailable — use Export Draft (JSON)');
        }
      }
    });

    // ========== ADMIN: Login + PIN export/import/QR ==========
    $('btnAdminSignup').addEventListener('click', () => {
      const u = $('adminUsername').value.trim();
      const p = $('adminPassword').value;
      if (!u || !p) return showToast('Fill both fields');
      if (getAdminCreds()) return showToast('Admin already exists');
      saveAdminCreds(u, p);
      showToast('Admin account created');
    });

    $('btnAdminLogin').addEventListener('click', () => {
      const u = $('adminUsername').value.trim();
      const p = $('adminPassword').value;
      const creds = getAdminCreds();
      if (!creds) return showToast('No admin account. Create one first.');
      if (creds.username === u && creds.password === p) {
        state.admin.loggedIn = true;
        $('adminLoginForm').classList.add('hidden');
        $('adminDashboardSection').classList.remove('hidden');
        $('adminTitle').textContent = 'Admin Panel';
        revealAdminPin();
        showToast('Admin logged in');
      } else {
        showToast('Wrong username or password');
      }
    });

    $('btnAdminLogout').addEventListener('click', () => {
      state.admin.loggedIn = false;
      $('adminLoginForm').classList.remove('hidden');
      $('adminDashboardSection').classList.add('hidden');
      $('adminTitle').textContent = 'Admin Login';
      $('adminUsername').value = '';
      $('adminPassword').value = '';
      showToast('Logged out');
    });

    function revealAdminPin() {
      $('adminPinDisplay').textContent = getPin();
    }

    $('btnCopyAdminPin').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(getPin());
        showToast('PIN copied!');
      } catch { showToast('Copy failed'); }
    });

    $('btnResetAdminPin').addEventListener('click', () => {
      if (confirm('Reset PIN? All lecturers will need the new one.')) {
        localStorage.removeItem(STORAGE_KEY_PIN);
        ensurePin();
        revealAdminPin();
        showToast('New PIN generated');
      }
    });

    // Export PIN (JSON)
    $('btnExportPin').addEventListener('click', () => {
      const payload = { pin: getPin(), t: nowIso() };
      const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `nsuk_urp_pin_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast('PIN exported (JSON)');
    });

    // Generate PIN QR
    $('btnGeneratePinQr').addEventListener('click', () => {
      const payload = { pin: getPin(), t: nowIso() };
      const json = JSON.stringify(payload);
      if (json.length > 1800) {
        showToast('PIN data too large for QR (unexpected)');
        return;
      }
      const qrData = encodeURIComponent(json);
      const qrUrl = `https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=${qrData}&chld=L|1`;
      $('adminPinQrImage').src = qrUrl;
      $('adminPinQrLink').innerHTML = `<a target="_blank" rel="noopener" class="text-xs underline" href="${qrUrl}">Open PIN QR image</a>`;
      $('adminPinQrPanel').classList.remove('hidden');
      showToast('PIN QR generated — share/scan on other device');
    });

    // Import PIN file (admin)
    $('importPinAdminFile').addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (data.pin) {
            setPin(data.pin);
            revealAdminPin();
            showToast('PIN imported');
          } else {
            showToast('Invalid PIN file');
          }
        } catch {
          showToast('Invalid PIN file');
        }
      };
      reader.readAsText(f);
      e.target.value = '';
    });

    // ========== LECTURER: Import PIN file or paste ==========
    $('importPinFile').addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (data.pin) {
            setPin(data.pin);
            showToast('PIN imported to this device — lecturers can now use it');
            // optional: prefill lecturer input
            $('lecturerPinInput').value = data.pin;
          } else if (typeof data === 'string' && data.length === 6) {
            setPin(data);
            showToast('PIN imported to this device');
            $('lecturerPinInput').value = data;
          } else {
            showToast('Invalid PIN file');
          }
        } catch {
          showToast('Invalid PIN file');
        }
      };
      reader.readAsText(f);
      e.target.value = '';
    });

    // Paste PIN fallback
    $('btnPastePin').addEventListener('click', async () => {
      try {
        const txt = await navigator.clipboard.readText();
        const maybe = txt.trim();
        if (maybe && maybe.length >= 6) {
          if (setPin(maybe)) {
            showToast('PIN pasted and saved to this device');
            $('lecturerPinInput').value = maybe;
            return;
          }
        }
        showToast('Clipboard does not contain a valid PIN');
      } catch {
        // fallback: prompt
        const manual = prompt('Paste PIN here:');
        if (manual && manual.trim().length >= 6) {
          if (setPin(manual.trim())) {
            showToast('PIN saved to this device');
            $('lecturerPinInput').value = manual.trim();
          } else showToast('Invalid PIN');
        } else showToast('No PIN provided');
      }
    });

    // admin and lecturer import file handlers use same IDs but we added separate inputs to UI
    // To keep code robust, attach handlers if elements present:
    if ($('importPinFile')) {
      $('importPinFile').addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(reader.result);
            if (data.pin) {
              setPin(data.pin);
              showToast('PIN imported to this device');
              $('lecturerPinInput').value = data.pin;
            } else {
              showToast('Invalid PIN file');
            }
          } catch {
            showToast('Invalid PIN file');
          }
        };
        reader.readAsText(f);
        e.target.value = '';
      });
    }

    // ========== LECTURER PIN ACCESS ==========
    $('btnLecturerUnlock').addEventListener('click', () => {
      const entered = $('lecturerPinInput').value.trim();
      if (!entered) return showToast('Enter PIN');
      // Accept when entered equals local stored PIN
      if (entered === getPin()) {
        state.lecturer.unlocked = true;
        $('lecturerLocked').classList.add('hidden');
        $('lecturerDashboard').classList.remove('hidden');
        renderDashboard();
        showToast('Dashboard unlocked');
      } else {
        $('lecturerPinMsg').textContent = 'Incorrect PIN';
        $('lecturerPinMsg').className = 'mt-2 text-xs text-rose-700 font-semibold text-center';
      }
    });

    $('btnLecturerLock').addEventListener('click', () => {
      state.lecturer.unlocked = false;
      $('lecturerLocked').classList.remove('hidden');
      $('lecturerDashboard').classList.add('hidden');
      $('lecturerPinInput').value = '';
      showToast('Dashboard locked');
    });

    // ========== RECORDS EXPORT / IMPORT / MERGE ==========
    // Export records (download JSON)
    $('btnExportRecords')?.addEventListener('click', () => {
      const records = getStoredRecords();
      if (!records.length) {
        showToast('No records to export');
        return;
      }
      const payload = { exportedAt: nowIso(), records };
      const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `nsuk_urp_attendance_records_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast('Records exported (JSON)');
    });

    // Import records (merge into local storage)
    $('importRecordsFile')?.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);
          let incoming = [];
          if (Array.isArray(parsed)) incoming = parsed;
          else if (parsed && Array.isArray(parsed.records)) incoming = parsed.records;
          else if (parsed && parsed.matric) incoming = [parsed];
          else { showToast('Invalid records file'); return; }

          // merge and dedupe
          const existing = getStoredRecords();
          const map = new Map();
          existing.forEach(r => map.set(r.id, r));
          incoming.forEach(r => {
            if (!r.id) r.id = Date.now() + Math.floor(Math.random()*999);
            if (!map.has(r.id)) {
              // fallback dedupe by (matric + date + time)
              const duplicate = Array.from(map.values()).some(ex => ex.matric === r.matric && ex.date === r.date && ex.time === r.time);
              if (!duplicate) map.set(r.id, r);
            }
          });
          const merged = Array.from(map.values()).sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));
          setStoredRecords(merged);
          renderDashboard();
          showToast('Records imported and merged');
        } catch (err) {
          showToast('Invalid records file');
        }
      };
      reader.readAsText(f);
      e.target.value = '';
    });

    // ========== RENDER / PREVIEW ==========
    function renderDashboard() {
      const records = getStoredRecords();
      const tbody = $('recordsTbody');
      tbody.innerHTML = '';
      if (!records.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-slate-500">No records yet</td></tr>';
        return;
      }
      records.forEach(r => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-100';
        tr.innerHTML = `
          <td class="px-4 py-3 font-medium">${r.name || ''}</td>
          <td class="px-4 py-3">${r.matric || ''}</td>
          <td class="px-4 py-3">${r.course || ''}</td>
          <td class="px-4 py-3 text-sm">${r.date} ${r.time}</td>
          <td class="px-4 py-3 text-xs">${r.lat?.toFixed?.(6) || ''}</td>
          <td class="px-4 py-3 text-xs">${r.lon?.toFixed?.(6) || ''}</td>
          <td class="px-4 py-3"><button class="text-xs underline text-blue-600" onclick="previewFace(${r.id})">View</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Preview face in new window
    function previewFace(id) {
      const records = getStoredRecords();
      const r = records.find(x => x.id === id);
      if (!r) return alert('Record not found');
      const win = window.open('', '_blank', 'width=520,height=640,scrollbars=yes');
      win.document.write(`<title>Face preview</title><div style="font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; padding:12px;">
        <h3>${r.name || ''} — ${r.matric || ''}</h3>
        <p style="color:#555">${r.course || ''} — ${r.date} ${r.time}</p>
        <p style="margin-top:8px;color:#555">Lat: ${r.lat?.toFixed?.(6) || ''} Lon: ${r.lon?.toFixed?.(6) || ''}</p>
        <div style="margin-top:12px;border:1px solid #eee;padding:8px;background:#fafafa">
          ${r.faceDataUrl ? `<img src="${r.faceDataUrl}" style="max-width:100%;height:auto;border-radius:8px" />` : '<div style="color:#666">No image</div>'}
        </div>
      </div>`);
    }

    // PDF Download
    $('btnDownloadPdf').addEventListener('click', () => {
      const records = getStoredRecords();
      if (!records.length) {
        showToast('No records to export');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text('NSUK URP Attendance Records', 14, 20);
      doc.setFontSize(10);
      doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);

      const headers = [['Name', 'Matric', 'Course', 'Date', 'Time', 'Latitude', 'Longitude']];
      const data = records.map(r => [
        r.name || '',
        r.matric || '',
        r.course || '',
        r.date || '',
        r.time || '',
        r.lat?.toFixed(6) || '',
        r.lon?.toFixed(6) || ''
      ]);

      doc.autoTable({
        head: headers,
        body: data,
        startY: 40,
      });

      doc.save(`NSUK_URP_Attendance_${new Date().toISOString().slice(0,10)}.pdf`);
      showToast('PDF downloaded');
    });

    // ========== TAB SWITCH ==========
    function showPanel(panel) {
      $('panelStudent').classList.add('hidden');
      $('panelLecturer').classList.add('hidden');
      $('panelAdmin').classList.add('hidden');

      $('tabStudent').className = 'rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-white text-slate-800 hover:bg-slate-50';
      $('tabLecturer').className = 'rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-white text-slate-800 hover:bg-slate-50';
      $('tabAdminLogin').className = 'rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-white text-slate-800 hover:bg-slate-50 ml-auto';

      if (panel === 'student') {
        $('panelStudent').classList.remove('hidden');
        $('tabStudent').className = 'rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-slate-900 text-white';
      } else if (panel === 'lecturer') {
        $('panelLecturer').classList.remove('hidden');
        $('tabLecturer').className = 'rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-slate-900 text-white';
      } else if (panel === 'admin') {
        $('panelAdmin').classList.remove('hidden');
        $('tabAdminLogin').className = 'rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-slate-900 text-white ml-auto';
      }
    }

    $('tabStudent').addEventListener('click', () => showPanel('student'));
    $('tabLecturer').addEventListener('click', () => showPanel('lecturer'));
    $('tabAdminLogin').addEventListener('click', () => showPanel('admin'));

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', () => {
      $('year').textContent = new Date().getFullYear();
      ensurePin();
      updateDateTimePreview();
      setInterval(updateDateTimePreview, 1000);

      ['studentName', 'matricNo', 'courseCode'].forEach(id => {
        $(id).addEventListener('input', updateSubmitState);
      });

      // help button
      $('btnOpenHelp').addEventListener('click', () => {
        alert(
`Instructions:
1) Capture location (or use manual coords).
2) Start camera and capture face (or upload an image).
3) Fill Name, Matric No, Course Code.
4) Submit attendance.

To share PIN or records across devices:
- Admin: Export PIN (JSON) or Generate PIN QR and share it.
- Lecturer/device: Import the PIN file or paste the PIN to save it locally.
- For attendance records: Export Records (JSON) from one device and Import Records on another device to merge them into the dashboard.
- Alternatively use Export Draft / Generate QR to move in-progress student submissions between devices.`
        );
      });

      // admin file inputs already have handlers
      showPanel('student');
      updateSubmitState();
      renderDashboard();
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>NSUK URP E-Attendance</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&family=Noto+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Tailwind Configuration -->
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0f1b3d",
                        "primary-hover": "#0a1430",
                        "background-light": "#f8fafc",
                        "background-dark": "#0f172a",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1e293b",
                        "success": "#10b981",
                        "warning": "#f59e0b",
                        "danger": "#ef4444",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"],
                        "body": ["Noto Sans", "sans-serif"],
                    },
                    borderRadius: {"DEFAULT": "0.75rem", "lg": "1rem", "xl": "1.5rem", "2xl": "2rem", "full": "9999px"},
                    boxShadow: {
                        "soft": "0 2px 8px rgba(15, 23, 42, 0.08)",
                        "glow": "0 0 15px rgba(15, 27, 61, 0.3)"
                    }
                },
            },
        }
    </script>
    
    <style>
        body {
            min-height: max(884px, 100dvh);
            font-family: 'Lexend', sans-serif;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .shimmer {
            background: linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.18), rgba(255,255,255,0.05));
            background-size: 200% 100%;
            animation: shimmer 2.2s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: 0% 0; }
            100% { background-position: 200% 0; }
        }
        
        .map-pattern {
            background-color: #e5e7eb;
            background-image: url(https://lh3.googleusercontent.com/aida-public/AB6AXuAeodS4yUhkiY4Sbp8d4q1i1Mxv0J9KsZQTMvVYXiOJP5Z1g_rGRvAh11FA20bgPLJPtpQBPZ0I037mpn-RWVjCUeZ9loVlYIOoBraD8s-WZ5W3lBoiNytRar-aXF42t_aiiLA1JlDR1WzvI46rJy2eF5o4EqGDD1fsvzf6Nl4X1XInK2SH6ZUnLEa6NrWX172yJFZy4gU98ImwR0mQSuPKVHHvVKS8S6sGpA2ymJ_ry4Tr3Q2ljKjThqs8LdcZduOWoVAc_3xx4Q)
        }
        
        .dark .map-pattern {
            background-color: #2d3748;
            background-image: url(https://lh3.googleusercontent.com/aida-public/AB6AXuCROnYF9Y4mmP1UZRoInder-IupHvfP8OMFjuHyfp5VBVA82LY0aH6C80xY80sWzsBLaXYNNujf6Yj3fQlca01noStuE38l5JlJ1FGDYXqh7ZCtOFVx_h5M6qevB1dAd2z0jbcZbZK3DVNOlYNAWsdM7PwiQeOPIWyAImY2JiGls-RDQFQl2VfnDuueBWT7P26_SZaccihRJ2zNBWnguqQh4xdaazNfRTzTiq0N7egXv9is6JVH4XxOXoFye-NnCAqIoA_B57NmeA)
        }
        
        /* Print-friendly */
        @media print {
            .no-print { display: none !important; }
            body { background: #fff !important; }
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white font-display">
    <!-- Main Application Container -->
    <div id="app-container" class="relative flex min-h-screen w-full flex-col justify-between overflow-x-hidden max-w-md mx-auto shadow-2xl bg-white dark:bg-[#101522]">
        
        <!-- Splash Screen (Initially visible) -->
        <div id="splash-screen" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-background-light dark:bg-background-dark p-6 transition-opacity duration-500">
            <!-- Decorative Background Elements -->
            <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
                <div class="absolute -top-24 -left-24 w-64 h-64 bg-primary/5 rounded-full blur-3xl"></div>
                <div class="absolute top-1/2 -right-32 w-80 h-80 bg-primary/5 rounded-full blur-3xl"></div>
            </div>
            
            <!-- Logo Container -->
            <div class="flex flex-col gap-3 mb-8 z-10">
                <div class="w-32 h-32 bg-center bg-no-repeat bg-contain rounded-xl shadow-sm bg-white dark:bg-white/5 p-4" data-alt="NSUK URP University Department Logo" style='background-image: url("static/NSUK-logo.jpg");'></div>
            </div>
            
            <!-- Headline Text -->
            <h1 class="text-slate-900 dark:text-white tracking-tight text-[32px] font-bold leading-tight text-center pb-2 z-10">
                NSUK URP
            </h1>
            
            <!-- Title Text -->
            <h2 class="text-slate-600 dark:text-slate-400 text-lg font-normal leading-tight tracking-[-0.015em] text-center pb-12 z-10">
                E-Attendance System
            </h2>
            
            <!-- Progress Bar (Loading Indicator) -->
            <div class="w-48 flex flex-col gap-3 z-10">
                <div class="rounded-full bg-slate-200 dark:bg-slate-700 h-1.5 w-full overflow-hidden">
                    <div id="loading-bar" class="h-full rounded-full bg-primary" style="width: 0%;"></div>
                </div>
            </div>
            
            <!-- Meta Text (Footer) -->
            <div class="w-full pb-8 pt-4 z-10">
                <p class="text-slate-500 dark:text-slate-400 text-sm font-normal leading-normal text-center">
                    Version 1.2.0
                </p>
            </div>
        </div>
        
        <!-- Welcome & Role Selection Screen (Initially hidden) -->
        <div id="role-selection-screen" class="hidden">
            <!-- Header Section -->
            <div class="flex flex-col flex-1 items-center justify-center pt-12 px-6 pb-4">
                <div class="flex w-full flex-col gap-6 items-center">
                    <div class="flex gap-6 flex-col items-center">
                        <!-- Image with rounded-xl -->
                        <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-3xl h-32 w-32 shadow-lg ring-4 ring-primary/10" data-alt="University department logo or abstract academic symbol" style='background-image: url("static/NSUK-logo.jpg");'></div>
                        
                        <div class="flex flex-col items-center justify-center gap-2">
                            <h1 class="text-slate-900 dark:text-white text-3xl font-extrabold leading-tight tracking-tight text-center">
                                Welcome Back!
                            </h1>
                            <p class="text-slate-600 dark:text-slate-400 text-base font-normal leading-normal text-center max-w-[280px]">
                                To get started with NSUK URP, please select your role below.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Role Selection Cards -->
            <div class="w-full px-6 py-2">
                <div class="flex flex-col gap-4">
                    <!-- Student Card -->
                    <button onclick="showScreen('student-auth')" class="group flex w-full items-center gap-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 p-5 shadow-sm transition-all duration-200 hover:border-primary hover:bg-primary/5 active:scale-[0.98] active:bg-primary active:border-primary">
                        <div class="flex h-12 w-12 items-center justify-center rounded-full bg-primary/10 text-primary group-active:bg-white/20 group-active:text-white transition-colors">
                            <span class="material-symbols-outlined" style="font-size: 28px;">school</span>
                        </div>
                        <div class="flex flex-col items-start">
                            <h2 class="text-lg font-bold text-slate-900 dark:text-white group-active:text-white transition-colors">Student</h2>
                            <span class="text-sm text-slate-600 dark:text-slate-400 group-active:text-blue-100 transition-colors">Access courses & attendance</span>
                        </div>
                        <div class="ml-auto text-slate-300 group-hover:text-primary group-active:text-white transition-colors">
                            <span class="material-symbols-outlined">chevron_right</span>
                        </div>
                    </button>
                    
                    <!-- Lecturer Card -->
                    <button onclick="showScreen('lecturer-dashboard')" class="group flex w-full items-center gap-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 p-5 shadow-sm transition-all duration-200 hover:border-primary hover:bg-primary/5 active:scale-[0.98] active:bg-primary active:border-primary">
                        <div class="flex h-12 w-12 items-center justify-center rounded-full bg-primary/10 text-primary group-active:bg-white/20 group-active:text-white transition-colors">
                            <span class="material-symbols-outlined" style="font-size: 28px;">co_present</span>
                        </div>
                        <div class="flex flex-col items-start">
                            <h2 class="text-lg font-bold text-slate-900 dark:text-white group-active:text-white transition-colors">Lecturer</h2>
                            <span class="text-sm text-slate-600 dark:text-slate-400 group-active:text-blue-100 transition-colors">Manage classes & students</span>
                        </div>
                        <div class="ml-auto text-slate-300 group-hover:text-primary group-active:text-white transition-colors">
                            <span class="material-symbols-outlined">chevron_right</span>
                        </div>
                    </button>
                    
                    <!-- Admin Card -->
                    <button onclick="showScreen('admin-login')" class="group flex w-full items-center gap-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 p-5 shadow-sm transition-all duration-200 hover:border-primary hover:bg-primary/5 active:scale-[0.98] active:bg-primary active:border-primary">
                        <div class="flex h-12 w-12 items-center justify-center rounded-full bg-primary/10 text-primary group-active:bg-white/20 group-active:text-white transition-colors">
                            <span class="material-symbols-outlined" style="font-size: 28px;">admin_panel_settings</span>
                        </div>
                        <div class="flex flex-col items-start">
                            <h2 class="text-lg font-bold text-slate-900 dark:text-white group-active:text-white transition-colors">Admin</h2>
                            <span class="text-sm text-slate-600 dark:text-slate-400 group-active:text-blue-100 transition-colors">System configuration</span>
                        </div>
                        <div class="ml-auto text-slate-300 group-hover:text-primary group-active:text-white transition-colors">
                            <span class="material-symbols-outlined">chevron_right</span>
                        </div>
                    </button>
                </div>
            </div>
            
            <!-- Footer Actions & Meta -->
            <div class="mt-auto flex flex-col items-center pb-8 pt-6 gap-2">
                <button onclick="openHelpModal()" class="flex min-w-[84px] cursor-pointer items-center justify-center rounded-full h-10 px-6 bg-transparent text-primary dark:text-blue-400 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/5 dark:hover:bg-primary/20 transition-colors">
                    <span class="truncate">Need Help?</span>
                </button>
                <p class="text-slate-500 dark:text-slate-400 text-xs font-normal leading-normal px-4 text-center opacity-80">
                    Department of Urban and Regional Planning © <span id="currentYear">2026</span>
                </p>
            </div>
        </div>
        
        <!-- Student Authentication Screen (Hidden by default) -->
        <div id="student-auth" class="hidden">
            <!-- Back Button -->
            <div class="flex items-center px-4 py-4 justify-between sticky top-0 z-10 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-sm">
                <button onclick="showScreen('role-selection-screen')" class="text-slate-900 dark:text-white flex size-10 shrink-0 items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors">
                    <span class="material-symbols-outlined" style="font-size: 24px;">arrow_back_ios_new</span>
                </button>
                <h2 class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">Student Access</h2>
                <div class="size-10"></div> <!-- Spacer for centering -->
            </div>
            
            <!-- Main Content -->
            <div class="flex-1 flex flex-col px-4 pb-8">
                <!-- Login/Signup Tabs -->
                <div class="mt-6 rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-slate-200 dark:ring-slate-700 shadow-sm">
                    <div class="border-b border-slate-200 dark:border-slate-700">
                        <div class="flex">
                            <button id="studentLoginTab" onclick="showStudentTab('login')" class="flex-1 px-4 py-3 text-sm font-semibold text-primary border-b-2 border-primary">
                                Login
                            </button>
                            <button id="studentSignupTab" onclick="showStudentTab('signup')" class="flex-1 px-4 py-3 text-sm font-semibold text-slate-600 dark:text-slate-400 border-b-2 border-transparent">
                                Sign Up
                            </button>
                        </div>
                    </div>

                    <!-- Login Form -->
                    <div id="studentLoginForm" class="px-5 py-5">
                        <form id="studentLoginFormElement" onsubmit="studentLogin(event)" class="space-y-4">
                            <div>
                                <label for="studentLoginMatric" class="block text-sm font-semibold text-slate-900 dark:text-white">Matric Number</label>
                                <input id="studentLoginMatric" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="Enter your matric number" />
                            </div>
                            
                            <div>
                                <label for="studentLoginPassword" class="block text-sm font-semibold text-slate-900 dark:text-white">Password</label>
                                <div class="mt-1 relative">
                                    <input id="studentLoginPassword" type="password" required class="w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 pr-12" placeholder="Enter your password" />
                                    <button type="button" onclick="toggleStudentPasswordVisibility('studentLoginPassword', 'studentPasswordToggleIcon')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">
                                        <span id="studentPasswordToggleIcon" class="material-symbols-outlined">visibility_off</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <label class="flex items-center gap-2">
                                    <input id="studentRememberMe" type="checkbox" class="rounded border-slate-300 dark:border-slate-600 text-primary focus:ring-primary/50" />
                                    <span class="text-sm text-slate-700 dark:text-slate-300">Remember me</span>
                                </label>
                                <button type="button" onclick="studentForgotPassword()" class="text-sm text-primary hover:text-primary-hover">
                                    Forgot Password?
                                </button>
                            </div>
                            
                            <button type="submit" class="w-full rounded-xl bg-primary px-4 py-3 text-sm font-semibold text-white hover:bg-primary-hover focus:outline-none focus:ring-2 focus:ring-primary/50">
                                Sign In
                            </button>
                        </form>
                    </div>

                    <!-- Signup Form -->
                    <div id="studentSignupForm" class="hidden px-5 py-5">
                        <form id="studentSignupFormElement" onsubmit="studentSignup(event)" class="space-y-4">
                            <div>
                                <label for="studentSignupName" class="block text-sm font-semibold text-slate-900 dark:text-white">Full Name</label>
                                <input id="studentSignupName" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="Enter your full name" />
                            </div>
                            
                            <div>
                                <label for="studentSignupMatric" class="block text-sm font-semibold text-slate-900 dark:text-white">Matric Number</label>
                                <input id="studentSignupMatric" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="e.g., URP/2023/001" />
                            </div>
                            
                            <div>
                                <label for="studentSignupEmail" class="block text-sm font-semibold text-slate-900 dark:text-white">Email</label>
                                <input id="studentSignupEmail" type="email" required class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="student@nsuk.edu.ng" />
                            </div>
                            
                            <div>
                                <label for="studentSignupPassword" class="block text-sm font-semibold text-slate-900 dark:text-white">Password</label>
                                <div class="mt-1 relative">
                                    <input id="studentSignupPassword" type="password" required minlength="6" class="w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 pr-12" placeholder="Create a password" />
                                    <button type="button" onclick="toggleStudentPasswordVisibility('studentSignupPassword', 'studentSignupPasswordToggleIcon')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">
                                        <span id="studentSignupPasswordToggleIcon" class="material-symbols-outlined">visibility_off</span>
                                    </button>
                                </div>
                                <p class="mt-1 text-xs text-slate-500">Must be at least 6 characters long</p>
                            </div>
                            
                            <div>
                                <label for="studentConfirmPassword" class="block text-sm font-semibold text-slate-900 dark:text-white">Confirm Password</label>
                                <div class="mt-1 relative">
                                    <input id="studentConfirmPassword" type="password" required minlength="6" class="w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 pr-12" placeholder="Confirm your password" />
                                    <button type="button" onclick="toggleStudentPasswordVisibility('studentConfirmPassword', 'studentConfirmPasswordToggleIcon')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">
                                        <span id="studentConfirmPasswordToggleIcon" class="material-symbols-outlined">visibility_off</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex items-center">
                                <input id="studentTermsAgreement" type="checkbox" required class="rounded border-slate-300 dark:border-slate-600 text-primary focus:ring-primary/50" />
                                <label for="studentTermsAgreement" class="ml-2 text-sm text-slate-700 dark:text-slate-300">
                                    I agree to the <a href__="#" class="text-primary hover:text-primary-hover">Terms of Service</a>
                                </label>
                            </div>
                            
                            <button type="submit" class="w-full rounded-xl bg-primary px-4 py-3 text-sm font-semibold text-white hover:bg-primary-hover focus:outline-none focus:ring-2 focus:ring-primary/50">
                                Create Account
                            </button>
                        </form>
                    </div>

                    <div id="studentAuthError" class="mt-3 mx-5 mb-5 hidden rounded-xl border border-red-200 dark:border-red-900 bg-red-50 dark:bg-red-900/20 p-3 text-sm text-red-800 dark:text-red-300"></div>
                    <div id="studentAuthSuccess" class="mt-3 mx-5 mb-5 hidden rounded-xl border border-emerald-200 dark:border-emerald-900 bg-emerald-50 dark:bg-emerald-900/20 p-3 text-sm text-emerald-800 dark:text-emerald-300"></div>
                </div>

                <!-- Quick Info -->
                <div class="mt-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-4">
                    <div class="flex items-start gap-3">
                        <span class="material-symbols-outlined text-primary">info</span>
                        <div>
                            <h3 class="text-sm font-semibold text-slate-900 dark:text-white">Multi-Device Access</h3>
                            <p class="mt-1 text-xs text-slate-600 dark:text-slate-400">
                                Your account works across all devices. Once created, you can login from any device using your matric number and password.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Student Attendance Screen (Hidden by default) -->
        <div id="student-attendance" class="hidden">
            <!-- Back Button -->
            <div class="flex items-center px-4 py-4 justify-between sticky top-0 z-10 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-sm">
                <button onclick="studentLogout()" class="text-slate-900 dark:text-white flex size-10 shrink-0 items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors">
                    <span class="material-symbols-outlined" style="font-size: 24px;">logout</span>
                </button>
                <h2 class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">Student Attendance</h2>
                <div class="flex items-center gap-2">
                    <span id="studentNameBadge" class="text-xs font-semibold text-primary bg-primary/10 px-2 py-1 rounded-lg"></span>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="flex-1 flex flex-col px-4 pb-8">
                <!-- Header Section -->
                <div class="flex flex-col items-center gap-4 pt-4">
                    <div class="text-center space-y-2">
                        <h1 class="text-slate-900 dark:text-white tracking-tight text-3xl font-bold leading-tight">Student Attendance</h1>
                        <p class="text-slate-600 dark:text-slate-400 text-base font-normal leading-normal">To submit attendance, you must capture your location and capture your face using your device camera.</p>
                    </div>
                </div>
                
                <!-- Step 1: Location -->
                <div class="mt-6 rounded-2xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-4">
                    <div class="flex items-start justify-between gap-3">
                        <div class="min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-primary text-white text-sm font-bold">1</span>
                                <h3 class="text-base font-semibold">Enable Location</h3>
                            </div>
                            <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">We capture your latitude and longitude for attendance verification.</p>
                        </div>
                        <button onclick="captureLocation()" class="shrink-0 rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary-hover focus:outline-none focus:ring-2 focus:ring-primary/50">
                            Capture Location
                        </button>
                    </div>

                    <div class="mt-3 grid gap-2 sm:grid-cols-3">
                        <div class="rounded-xl bg-white dark:bg-slate-800 p-3 ring-1 ring-slate-200 dark:ring-slate-700">
                            <p class="text-xs text-slate-500 dark:text-slate-400">Location Status</p>
                            <p id="locStatus" class="mt-1 text-sm font-semibold text-slate-900 dark:text-white">Not captured</p>
                        </div>
                        <div class="rounded-xl bg-white dark:bg-slate-800 p-3 ring-1 ring-slate-200 dark:ring-slate-700">
                            <p class="text-xs text-slate-500 dark:text-slate-400">Latitude</p>
                            <p id="latText" class="mt-1 text-sm font-semibold tabular-nums text-slate-900 dark:text-white">—</p>
                        </div>
                        <div class="rounded-xl bg-white dark:bg-slate-800 p-3 ring-1 ring-slate-200 dark:ring-slate-700">
                            <p class="text-xs text-slate-500 dark:text-slate-400">Longitude</p>
                            <p id="lonText" class="mt-1 text-sm font-semibold tabular-nums text-slate-900 dark:text-white">—</p>
                        </div>
                    </div>

                    <div id="locError" class="mt-3 hidden rounded-xl border border-red-200 dark:border-red-900 bg-red-50 dark:bg-red-900/20 p-3 text-sm text-red-800 dark:text-red-300"></div>
                </div>
                
                <!-- Step 2: Face Capture -->
                <div class="mt-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-4">
                    <div class="flex items-start justify-between gap-3">
                        <div class="min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-primary text-white text-sm font-bold">2</span>
                                <h3 class="text-base font-semibold">Capture Face</h3>
                            </div>
                            <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">Use your front camera and capture a clear image.</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="startCamera()" class="rounded-xl bg-white dark:bg-slate-800 px-4 py-2 text-sm font-semibold text-slate-900 dark:text-white ring-1 ring-slate-200 dark:ring-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-primary/50">
                                Start Camera
                            </button>
                            <button onclick="captureFace()" id="btnCaptureFace" class="rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary-hover disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-primary/50" disabled>
                                Capture
                            </button>
                        </div>
                    </div>

                    <div class="mt-4 grid gap-3">
                        <div class="rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-slate-200 dark:ring-slate-700 overflow-hidden">
                            <div class="border-b border-slate-200 dark:border-slate-700 px-3 py-2">
                                <p class="text-xs font-semibold text-slate-600 dark:text-slate-400">Live Camera</p>
                            </div>
                            <div class="p-3">
                                <video id="video" class="w-full rounded-xl bg-slate-900/5 dark:bg-slate-900/20" autoplay muted playsinline></video>
                                <p id="camHint" class="mt-2 text-xs text-slate-500 dark:text-slate-500">Tip: Ensure your face is well-lit and centered.</p>
                                <div id="camError" class="mt-2 hidden rounded-xl border border-red-200 dark:border-red-900 bg-red-50 dark:bg-red-900/20 p-3 text-sm text-red-800 dark:text-red-300"></div>
                            </div>
                        </div>

                        <div class="rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-slate-200 dark:ring-slate-700 overflow-hidden">
                            <div class="border-b border-slate-200 dark:border-slate-700 px-3 py-2 flex items-center justify-between">
                                <p class="text-xs font-semibold text-slate-600 dark:text-slate-400">Captured Image</p>
                                <button onclick="retakeFace()" id="btnRetake" class="text-xs font-semibold text-slate-700 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white disabled:opacity-50" disabled>Retake</button>
                            </div>
                            <div class="p-3">
                                <div class="aspect-video w-full rounded-xl bg-slate-900/5 dark:bg-slate-900/20 flex items-center justify-center overflow-hidden">
                                    <img id="facePreview" alt="Captured face preview" class="hidden h-full w-full object-cover" />
                                    <div id="faceEmpty" class="text-sm text-slate-500 dark:text-slate-500">No image captured yet</div>
                                </div>
                                <div class="mt-2 grid gap-2 sm:grid-cols-2">
                                    <div class="rounded-xl bg-slate-50 dark:bg-slate-800/50 ring-1 ring-slate-200 dark:ring-slate-700 p-3">
                                        <p class="text-xs text-slate-500 dark:text-slate-400">Face Status</p>
                                        <p id="faceStatus" class="mt-1 text-sm font-semibold text-slate-900 dark:text-white">Not captured</p>
                                    </div>
                                    <div class="rounded-xl bg-slate-50 dark:bg-slate-800/50 ring-1 ring-slate-200 dark:ring-slate-700 p-3">
                                        <p class="text-xs text-slate-500 dark:text-slate-400">Image Quality</p>
                                        <p id="faceQuality" class="mt-1 text-sm font-semibold text-slate-900 dark:text-white">—</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 3: Attendance Form -->
                <div class="mt-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-4">
                    <div class="flex items-start gap-3">
                        <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-primary text-white text-sm font-bold">3</span>
                        <div>
                            <h3 class="text-base font-semibold">Attendance Form</h3>
                            <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">
                                The form is unlocked after successful face capture. Submission requires location + face + required fields.
                            </p>
                        </div>
                    </div>

                    <form id="attendanceForm" class="mt-4" autocomplete="on" novalidate>
                        <fieldset id="formFieldset" disabled class="opacity-60">
                            <div class="grid gap-3">
                                <div>
                                    <label class="block text-sm font-semibold text-slate-900 dark:text-white">Name <span class="text-red-600">*</span></label>
                                    <input id="studentName" name="name" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="e.g., Abdullahi Suleiman" />
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-900 dark:text-white">Matric Number <span class="text-red-600">*</span></label>
                                    <input id="matricNo" name="matric" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="e.g., URP/2023/001 or any format" />
                                </div>
                                <div>
                                    <label for="courseCode" class="block text-sm font-semibold text-slate-900 dark:text-white">Course Code <span class="text-red-600">*</span></label>
                                    <input id="courseCode" name="course" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="e.g., URP 111" />
                                </div>
                            </div>

                            <div class="mt-4 grid gap-2 sm:grid-cols-3">
                                <div class="rounded-xl bg-white dark:bg-slate-800 p-3 ring-1 ring-slate-200 dark:ring-slate-700">
                                    <p class="text-xs text-slate-500 dark:text-slate-400">Date</p>
                                    <p id="dateText" class="mt-1 text-sm font-semibold text-slate-900 dark:text-white">—</p>
                                </div>
                                <div class="rounded-xl bg-white dark:bg-slate-800 p-3 ring-1 ring-slate-200 dark:ring-slate-700">
                                    <p class="text-xs text-slate-500 dark:text-slate-400">Time</p>
                                    <p id="timeText" class="mt-1 text-sm font-semibold text-slate-900 dark:text-white">—</p>
                                </div>
                                <div class="rounded-xl bg-white dark:bg-slate-800 p-3 ring-1 ring-slate-200 dark:ring-slate-700">
                                    <p class="text-xs text-slate-500 dark:text-slate-400">Verification</p>
                                    <p id="verifyText" class="mt-1 text-sm font-semibold text-slate-900 dark:text-white">Pending</p>
                                </div>
                            </div>

                            <div class="mt-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                <div class="text-xs text-slate-600 dark:text-slate-400">
                                    <span class="font-semibold">Auto-captured:</span> Date/Time, Latitude/Longitude, Face image.
                                </div>
                                <button id="btnSubmit" type="submit" class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-emerald-300" disabled>
                                    Submit Attendance
                                </button>
                            </div>
                        </fieldset>

                        <div id="formLockedNote" class="mt-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 p-3 text-sm text-slate-700 dark:text-slate-400">
                            <span class="font-semibold">Locked:</span> Start the camera and capture your face to unlock the attendance form.
                        </div>
                    </form>
                </div>
                
                <!-- Quick Checklist -->
                <div class="mt-6 rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-slate-200 dark:ring-slate-700 shadow-sm">
                    <div class="border-b border-slate-200 dark:border-slate-700 px-5 py-4">
                        <h3 class="text-base font-semibold">Quick Checklist</h3>
                        <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">Ensure all items are completed before submitting.</p>
                    </div>
                    <div class="px-5 py-5">
                        <ul class="space-y-3">
                            <li class="flex items-start gap-3">
                                <span id="checkLoc" class="mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 ring-1 ring-slate-200 dark:ring-slate-600" aria-hidden="true">—</span>
                                <div>
                                    <p class="text-sm font-semibold text-slate-900 dark:text-white">Location captured</p>
                                    <p class="text-xs text-slate-600 dark:text-slate-400">Allow location access when prompted.</p>
                                </div>
                            </li>
                            <li class="flex items-start gap-3">
                                <span id="checkFace" class="mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 ring-1 ring-slate-200 dark:ring-slate-600" aria-hidden="true">—</span>
                                <div>
                                    <p class="text-sm font-semibold text-slate-900 dark:text-white">Face captured</p>
                                    <p class="text-xs text-slate-600 dark:text-slate-400">Use the front camera; ensure clarity.</p>
                                </div>
                            </li>
                            <li class="flex items-start gap-3">
                                <span id="checkFields" class="mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 ring-1 ring-slate-200 dark:ring-slate-600" aria-hidden="true">—</span>
                                <div>
                                    <p class="text-sm font-semibold text-slate-900 dark:text-white">Required fields filled</p>
                                    <p class="text-xs text-slate-600 dark:text-slate-400">Name, matric number, course code.</p>
                                </div>
                            </li>
                        </ul>

                        <div class="mt-5 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-4">
                            <p class="text-xs font-semibold text-slate-700 dark:text-slate-300">Privacy (Local Device Only)</p>
                            <p class="mt-1 text-xs text-slate-600 dark:text-slate-400">
                                Attendance records (including the captured image) are stored in your browser's local storage on this device.
                                No data is uploaded to any server.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Lecturer Dashboard (Hidden by default) -->
        <div id="lecturer-dashboard" class="hidden">
            <!-- Back Button -->
            <div class="flex items-center px-4 py-4 justify-between sticky top-0 z-10 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-sm">
                <button onclick="showScreen('role-selection-screen')" class="text-slate-900 dark:text-white flex size-10 shrink-0 items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors">
                    <span class="material-symbols-outlined" style="font-size: 24px;">arrow_back_ios_new</span>
                </button>
                <h2 class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">Lecturer Dashboard</h2>
                <div class="size-10"></div> <!-- Spacer for centering -->
            </div>
            
            <!-- Main Content -->
            <div class="flex-1 flex flex-col px-4 pb-8">
                <!-- PIN Access Section -->
                <div class="mt-6 rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-slate-200 dark:ring-slate-700 shadow-sm">
                    <div class="border-b border-slate-200 dark:border-slate-700 px-5 py-4">
                        <h2 class="text-lg font-semibold">Lecturer Access</h2>
                        <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">Enter the system-generated PIN to access the dashboard.</p>
                    </div>

                    <div class="px-5 py-5">
                        <div class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-4">
                            <label for="pinInput" class="block text-sm font-semibold text-slate-900 dark:text-white">Access PIN</label>
                            <div class="mt-2 flex items-center gap-2">
                                <input id="pinInput" type="password" maxlength="6" class="flex-1 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-center text-2xl font-bold tracking-widest focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="000000" />
                                <button onclick="togglePinVisibility()" type="button" class="rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700">
                                    <span id="pinToggleIcon" class="material-symbols-outlined">visibility_off</span>
                                </button>
                            </div>
                            <p class="mt-2 text-xs text-slate-600 dark:text-slate-400">Enter the 6-digit PIN provided by the system administrator.</p>
                        </div>

                        <div class="mt-4 grid grid-cols-2 gap-3">
                            <button onclick="verifyLecturerPin()" class="rounded-xl bg-primary px-4 py-3 text-sm font-semibold text-white hover:bg-primary-hover focus:outline-none focus:ring-2 focus:ring-primary/50">
                                Verify PIN
                            </button>
                            <button onclick="generateNewLecturerPin()" class="rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm font-semibold text-slate-900 dark:text-white hover:bg-slate-50 dark:hover:bg-slate-700">
                                Request New PIN
                            </button>
                        </div>

                        <div id="pinError" class="mt-3 hidden rounded-xl border border-red-200 dark:border-red-900 bg-red-50 dark:bg-red-900/20 p-3 text-sm text-red-800 dark:text-red-300"></div>
                        <div id="pinSuccess" class="mt-3 hidden rounded-xl border border-emerald-200 dark:border-emerald-900 bg-emerald-50 dark:bg-emerald-900/20 p-3 text-sm text-emerald-800 dark:text-emerald-300"></div>
                    </div>
                </div>

                <!-- Attendance Statistics -->
                <div id="dashboardContent" class="hidden mt-6 rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-slate-200 dark:ring-slate-700 shadow-sm">
                    <div class="border-b border-slate-200 dark:border-slate-700 px-5 py-4">
                        <h2 class="text-lg font-semibold">Today's Attendance</h2>
                        <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">Overview of attendance for your classes.</p>
                    </div>
                    <div class="px-5 py-5">
                        <div class="grid grid-cols-3 gap-3">
                            <div class="rounded-xl bg-primary/5 p-4 text-center">
                                <p id="totalStudents" class="text-2xl font-bold text-primary">0</p>
                                <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">Total Students</p>
                            </div>
                            <div class="rounded-xl bg-emerald-50 dark:bg-emerald-900/20 p-4 text-center">
                                <p id="presentStudents" class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">0</p>
                                <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">Present</p>
                            </div>
                            <div class="rounded-xl bg-red-50 dark:bg-red-900/20 p-4 text-center">
                                <p id="absentStudents" class="text-2xl font-bold text-red-600 dark:text-red-400">0</p>
                                <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">Absent</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attendance Dashboard (Initially hidden) -->
                <div id="attendanceDashboard" class="hidden mt-4 rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-slate-200 dark:ring-slate-700 shadow-sm">
                    <div class="border-b border-slate-200 dark:border-slate-700 px-5 py-4">
                        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                            <div>
                                <h2 class="text-lg font-semibold">Attendance Dashboard</h2>
                                <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">View, download PDF, or clear records.</p>
                            </div>
                            <div class="flex flex-wrap items-center gap-2">
                                <button onclick="downloadAttendancePDF()" class="rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary-hover focus:outline-none focus:ring-2 focus:ring-primary/50">Download PDF</button>
                                <button onclick="clearAttendanceRecords()" class="rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-2 text-sm font-semibold text-slate-900 dark:text-white hover:bg-slate-50 dark:hover:bg-slate-700">Clear Records</button>
                                <button onclick="lockLecturerDashboard()" class="rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-2 text-sm font-semibold text-slate-900 dark:text-white hover:bg-slate-50 dark:hover:bg-slate-700">Lock</button>
                            </div>
                        </div>

                        <div class="mt-4 grid gap-3 sm:grid-cols-3">
                            <div class="rounded-xl bg-slate-50 dark:bg-slate-800/50 ring-1 ring-slate-200 dark:ring-slate-700 p-3">
                                <p class="text-xs text-slate-500 dark:text-slate-400">Total Records</p>
                                <p id="statTotal" class="mt-1 text-lg font-bold tabular-nums">0</p>
                            </div>
                            <div class="rounded-xl bg-slate-50 dark:bg-slate-800/50 ring-1 ring-slate-200 dark:ring-slate-700 p-3">
                                <p class="text-xs text-slate-500 dark:text-slate-400">Most Recent</p>
                                <p id="statRecent" class="mt-1 text-sm font-semibold">—</p>
                            </div>
                            <div class="rounded-xl bg-slate-50 dark:bg-slate-800/50 ring-1 ring-slate-200 dark:ring-slate-700 p-3">
                                <label for="searchInput" class="text-xs text-slate-500 dark:text-slate-400">Search (name/matric/course)</label>
                                <input id="searchInput" class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="Type to filter…" />
                            </div>
                        </div>
                    </div>

                    <div class="px-5 py-5">
                        <div class="overflow-x-auto rounded-2xl ring-1 ring-slate-200 dark:ring-slate-700">
                            <table class="min-w-full bg-white dark:bg-slate-800">
                                <thead class="bg-slate-50 dark:bg-slate-700/50">
                                    <tr class="text-left text-xs font-semibold text-slate-600 dark:text-slate-400">
                                        <th class="px-4 py-3">Name</th>
                                        <th class="px-4 py-3">Matric</th>
                                        <th class="px-4 py-3">Course</th>
                                        <th class="px-4 py-3">Date & Time</th>
                                        <th class="px-4 py-3">Latitude</th>
                                        <th class="px-4 py-3">Longitude</th>
                                        <th class="px-4 py-3">Face</th>
                                    </tr>
                                </thead>
                                <tbody id="recordsTbody" class="divide-y divide-slate-100 dark:divide-slate-700 text-sm">
                                    <!-- Filled by JS -->
                                </tbody>
                            </table>
                        </div>

                        <p id="emptyAdmin" class="mt-3 hidden text-sm text-slate-600 dark:text-slate-400">No records found.</p>
                    </div>
                </div>

                <!-- Class Management -->
                <div id="classManagement" class="hidden mt-4 rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-slate-200 dark:ring-slate-700 shadow-sm">
                    <div class="border-b border-slate-200 dark:border-slate-700 px-5 py-4">
                        <h2 class="text-lg font-semibold">Class Management</h2>
                        <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">Manage your courses and attendance sessions.</p>
                    </div>
                    <div class="px-5 py-5">
                        <div class="space-y-3">
                            <button onclick="createNewSession()" class="flex w-full items-center justify-between rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-4 hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors">
                                <div class="flex items-center gap-3">
                                    <div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary/10 text-primary">
                                        <span class="material-symbols-outlined">add_circle</span>
                                    </div>
                                    <div class="text-left">
                                        <h3 class="text-sm font-semibold text-slate-900 dark:text-white">Create New Session</h3>
                                        <p class="text-xs text-slate-600 dark:text-slate-400">Start a new attendance session</p>
                                    </div>
                                </div>
                                <span class="material-symbols-outlined text-slate-400">chevron_right</span>
                            </button>

                            <button onclick="viewPastSessions()" class="flex w-full items-center justify-between rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-4 hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors">
                                <div class="flex items-center gap-3">
                                    <div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary/10 text-primary">
                                        <span class="material-symbols-outlined">history</span>
                                    </div>
                                    <div class="text-left">
                                        <h3 class="text-sm font-semibold text-slate-900 dark:text-white">Past Sessions</h3>
                                        <p class="text-xs text-slate-600 dark:text-slate-400">View previous attendance records</p>
                                    </div>
                                </div>
                                <span class="material-symbols-outlined text-slate-400">chevron_right</span>
                            </button>

                            <button onclick="manageStudents()" class="flex w-full items-center justify-between rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-4 hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors">
                                <div class="flex items-center gap-3">
                                    <div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary/10 text-primary">
                                        <span class="material-symbols-outlined">groups</span>
                                    </div>
                                    <div class="text-left">
                                        <h3 class="text-sm font-semibold text-slate-900 dark:text-white">Manage Students</h3>
                                        <p class="text-xs text-slate-600 dark:text-slate-400">View and manage student list</p>
                                    </div>
                                </div>
                                <span class="material-symbols-outlined text-slate-400">chevron_right</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div id="quickActions" class="hidden mt-4 rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-slate-200 dark:ring-slate-700 shadow-sm">
                    <div class="border-b border-slate-200 dark:border-slate-700 px-5 py-4">
                        <h2 class="text-lg font-semibold">Quick Actions</h2>
                        <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">Frequently used tools and features.</p>
                    </div>
                    <div class="px-5 py-5">
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="exportAttendanceCSV()" class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 p-4 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                <div class="flex flex-col items-center gap-2">
                                    <span class="material-symbols-outlined text-primary">download</span>
                                    <span class="text-xs font-semibold">Export CSV</span>
                                </div>
                            </button>
                            <button onclick="generateAttendanceReport()" class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 p-4 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                <div class="flex flex-col items-center gap-2">
                                    <span class="material-symbols-outlined text-primary">summarize</span>
                                    <span class="text-xs font-semibold">Generate Report</span>
                                </div>
                            </button>
                            <button onclick="openHelpModal()" class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 p-4 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                <div class="flex flex-col items-center gap-2">
                                    <span class="material-symbols-outlined text-primary">help</span>
                                    <span class="text-xs font-semibold">Help</span>
                                </div>
                            </button>
                            <!-- Empty placeholder to maintain grid layout -->
                            <div class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 p-4 opacity-50">
                                <div class="flex flex-col items-center gap-2">
                                    <span class="material-symbols-outlined text-slate-400">more_horiz</span>
                                    <span class="text-xs font-semibold text-slate-400">More</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Admin Login Screen (Hidden by default) -->
        <div id="admin-login" class="hidden">
            <!-- Back Button -->
            <div class="flex items-center px-4 py-4 justify-between sticky top-0 z-10 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-sm">
                <button onclick="showScreen('role-selection-screen')" class="text-slate-900 dark:text-white flex size-10 shrink-0 items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors">
                    <span class="material-symbols-outlined" style="font-size: 24px;">arrow_back_ios_new</span>
                </button>
                <h2 class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">Admin Login</h2>
                <div class="size-10"></div> <!-- Spacer for centering -->
            </div>
            
            <!-- Main Content -->
            <div class="flex-1 flex flex-col px-4 pb-8">
                <!-- Login/Signup Tabs -->
                <div class="mt-6 rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-slate-200 dark:ring-slate-700 shadow-sm">
                    <div class="border-b border-slate-200 dark:border-slate-700">
                        <div class="flex">
                            <button id="loginTab" onclick="showAdminTab('login')" class="flex-1 px-4 py-3 text-sm font-semibold text-primary border-b-2 border-primary">
                                Login
                            </button>
                            <button id="signupTab" onclick="showAdminTab('signup')" class="flex-1 px-4 py-3 text-sm font-semibold text-slate-600 dark:text-slate-400 border-b-2 border-transparent">
                                Sign Up
                            </button>
                        </div>
                    </div>

                    <!-- Login Form -->
                    <div id="loginForm" class="px-5 py-5">
                        <form id="adminLoginForm" onsubmit="adminLogin(event)" class="space-y-4">
                            <div>
                                <label for="adminUsername" class="block text-sm font-semibold text-slate-900 dark:text-white">Username</label>
                                <input id="adminUsername" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="Enter admin username" />
                            </div>
                            
                            <div>
                                <label for="adminPassword" class="block text-sm font-semibold text-slate-900 dark:text-white">Password</label>
                                <div class="mt-1 relative">
                                    <input id="adminPassword" type="password" required class="w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 pr-12" placeholder="Enter password" />
                                    <button type="button" onclick="togglePasswordVisibility('adminPassword', 'passwordToggleIcon')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">
                                        <span id="passwordToggleIcon" class="material-symbols-outlined">visibility_off</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <label class="flex items-center gap-2">
                                    <input id="rememberMe" type="checkbox" class="rounded border-slate-300 dark:border-slate-600 text-primary focus:ring-primary/50" />
                                    <span class="text-sm text-slate-700 dark:text-slate-300">Remember me</span>
                                </label>
                                <button type="button" onclick="forgotPassword()" class="text-sm text-primary hover:text-primary-hover">
                                    Forgot Password?
                                </button>
                            </div>
                            
                            <button type="submit" class="w-full rounded-xl bg-primary px-4 py-3 text-sm font-semibold text-white hover:bg-primary-hover focus:outline-none focus:ring-2 focus:ring-primary/50">
                                Sign In
                            </button>
                        </form>
                    </div>

                    <!-- Signup Form -->
                    <div id="signupForm" class="hidden px-5 py-5">
                        <form id="adminSignupForm" onsubmit="adminSignup(event)" class="space-y-4">
                            <div>
                                <label for="signupName" class="block text-sm font-semibold text-slate-900 dark:text-white">Full Name</label>
                                <input id="signupName" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="Enter your full name" />
                            </div>
                            
                            <div>
                                <label for="signupEmail" class="block text-sm font-semibold text-slate-900 dark:text-white">Email</label>
                                <input id="signupEmail" type="email" required class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="Enter your email" />
                            </div>
                            
                            <div>
                                <label for="signupUsername" class="block text-sm font-semibold text-slate-900 dark:text-white">Username</label>
                                <input id="signupUsername" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="Choose a username" />
                            </div>
                            
                            <div>
                                <label for="signupPassword" class="block text-sm font-semibold text-slate-900 dark:text-white">Password</label>
                                <div class="mt-1 relative">
                                    <input id="signupPassword" type="password" required minlength="6" class="w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 pr-12" placeholder="Create a password" />
                                    <button type="button" onclick="togglePasswordVisibility('signupPassword', 'signupPasswordToggleIcon')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">
                                        <span id="signupPasswordToggleIcon" class="material-symbols-outlined">visibility_off</span>
                                    </button>
                                </div>
                                <p class="mt-1 text-xs text-slate-500">Must be at least 6 characters long</p>
                            </div>
                            
                            <div>
                                <label for="confirmPassword" class="block text-sm font-semibold text-slate-900 dark:text-white">Confirm Password</label>
                                <div class="mt-1 relative">
                                    <input id="confirmPassword" type="password" required minlength="6" class="w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 pr-12" placeholder="Confirm your password" />
                                    <button type="button" onclick="togglePasswordVisibility('confirmPassword', 'confirmPasswordToggleIcon')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">
                                        <span id="confirmPasswordToggleIcon" class="material-symbols-outlined">visibility_off</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex items-center">
                                <input id="termsAgreement" type="checkbox" required class="rounded border-slate-300 dark:border-slate-600 text-primary focus:ring-primary/50" />
                                <label for="termsAgreement" class="ml-2 text-sm text-slate-700 dark:text-slate-300">
                                    I agree to the <a href__="#" class="text-primary hover:text-primary-hover">Terms of Service</a> and <a href__="#" class="text-primary hover:text-primary-hover">Privacy Policy</a>
                                </label>
                            </div>
                            
                            <button type="submit" class="w-full rounded-xl bg-primary px-4 py-3 text-sm font-semibold text-white hover:bg-primary-hover focus:outline-none focus:ring-2 focus:ring-primary/50">
                                Create Account
                            </button>
                        </form>
                    </div>

                    <div id="adminError" class="mt-3 mx-5 mb-5 hidden rounded-xl border border-red-200 dark:border-red-900 bg-red-50 dark:bg-red-900/20 p-3 text-sm text-red-800 dark:text-red-300"></div>
                    <div id="adminSuccess" class="mt-3 mx-5 mb-5 hidden rounded-xl border border-emerald-200 dark:border-emerald-900 bg-emerald-50 dark:bg-emerald-900/20 p-3 text-sm text-emerald-800 dark:text-emerald-300"></div>
                </div>

                <!-- Security Notice -->
                <div class="mt-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-4">
                    <div class="flex items-start gap-3">
                        <span class="material-symbols-outlined text-primary">security</span>
                        <div>
                            <h3 class="text-sm font-semibold text-slate-900 dark:text-white">Security Notice</h3>
                            <p class="mt-1 text-xs text-slate-600 dark:text-slate-400">
                                Admin access is restricted to authorized personnel only. All login attempts are logged and monitored.
                                Unauthorized access attempts may result in disciplinary action.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Admin Dashboard Screen (Hidden by default) -->
        <div id="admin-dashboard" class="hidden">
            <!-- Header -->
            <div class="flex items-center px-4 py-4 justify-between sticky top-0 z-10 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-sm">
                <button onclick="adminLogout()" class="text-slate-900 dark:text-white flex size-10 shrink-0 items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors">
                    <span class="material-symbols-outlined" style="font-size: 24px;">logout</span>
                </button>
                <h2 class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">Admin Dashboard</h2>
                <div class="size-10"></div>
            </div>
            
            <!-- Main Content -->
            <div class="flex-1 flex flex-col px-4 pb-8">
                <!-- Welcome Message -->
                <div class="mt-4 rounded-2xl bg-primary/5 p-4">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">Welcome, <span id="adminWelcomeName">Admin</span>!</h3>
                    <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">You have full access to the system configuration.</p>
                </div>
                
                <!-- Admin Stats -->
                <div class="mt-4 grid grid-cols-2 gap-3">
                    <div class="rounded-xl bg-white dark:bg-slate-800 p-4 ring-1 ring-slate-200 dark:ring-slate-700">
                        <p class="text-2xl font-bold text-primary" id="totalAdmins">1</p>
                        <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">Total Admins</p>
                    </div>
                    <div class="rounded-xl bg-white dark:bg-slate-800 p-4 ring-1 ring-slate-200 dark:ring-slate-700">
                        <p class="text-2xl font-bold text-emerald-600" id="totalRecords">0</p>
                        <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">Attendance Records</p>
                    </div>
                    <div class="rounded-xl bg-white dark:bg-slate-800 p-4 ring-1 ring-slate-200 dark:ring-slate-700">
                        <p class="text-2xl font-bold text-warning" id="totalPins">0</p>
                        <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">Active PINs</p>
                    </div>
                    <div class="rounded-xl bg-white dark:bg-slate-800 p-4 ring-1 ring-slate-200 dark:ring-slate-700">
                        <p class="text-2xl font-bold text-blue-600" id="pinUsage">0</p>
                        <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">PIN Usage Today</p>
                    </div>
                </div>
                
                <!-- Generate PIN Section -->
                <div class="mt-4 rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-slate-200 dark:ring-slate-700 shadow-sm">
                    <div class="border-b border-slate-200 dark:border-slate-700 px-5 py-4">
                        <h2 class="text-lg font-semibold">Generate Lecturer PIN</h2>
                        <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">Create PINs for lecturer access to the dashboard.</p>
                    </div>
                    <div class="px-5 py-5">
                        <div class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-4">
                            <div class="space-y-4">
                                <div>
                                    <label for="lecturerName" class="block text-sm font-semibold text-slate-900 dark:text-white">Lecturer Name</label>
                                    <input id="lecturerName" type="text" class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="e.g., Dr. Abdullahi Suleiman" />
                                </div>
                                
                                <div>
                                    <label for="lecturerEmail" class="block text-sm font-semibold text-slate-900 dark:text-white">Email (Optional)</label>
                                    <input id="lecturerEmail" type="email" class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="lecturer@nsuk.edu.ng" />
                                </div>
                                
                                <div>
                                    <label for="pinExpiry" class="block text-sm font-semibold text-slate-900 dark:text-white">PIN Expiry</label>
                                    <select id="pinExpiry" class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                                        <option value="1">24 Hours</option>
                                        <option value="7" selected>7 Days</option>
                                        <option value="30">30 Days</option>
                                        <option value="90">90 Days</option>
                                        <option value="365">1 Year</option>
                                    </select>
                                </div>
                                
                                <div class="flex items-center">
                                    <input id="autoGenerate" type="checkbox" checked class="rounded border-slate-300 dark:border-slate-600 text-primary focus:ring-primary/50" />
                                    <label for="autoGenerate" class="ml-2 text-sm text-slate-700 dark:text-slate-300">
                                        Auto-generate 6-digit PIN
                                    </label>
                                </div>
                                
                                <div id="customPinSection" class="hidden">
                                    <label for="customPin" class="block text-sm font-semibold text-slate-900 dark:text-white">Custom PIN</label>
                                    <input id="customPin" type="text" maxlength="6" class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-center text-xl font-bold tracking-widest focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="000000" />
                                    <p class="mt-1 text-xs text-slate-500">Enter a custom 6-digit PIN</p>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 grid grid-cols-2 gap-3">
                            <button onclick="generateLecturerPin()" class="rounded-xl bg-primary px-4 py-3 text-sm font-semibold text-white hover:bg-primary-hover focus:outline-none focus:ring-2 focus:ring-primary/50">
                                Generate PIN
                            </button>
                            <button onclick="viewAllPins()" class="rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm font-semibold text-slate-900 dark:text-white hover:bg-slate-50 dark:hover:bg-slate-700">
                                View All PINs
                            </button>
                        </div>

                        <div id="pinGenerationError" class="mt-3 hidden rounded-xl border border-red-200 dark:border-red-900 bg-red-50 dark:bg-red-900/20 p-3 text-sm text-red-800 dark:text-red-300"></div>
                        <div id="pinGenerationSuccess" class="mt-3 hidden rounded-xl border border-emerald-200 dark:border-emerald-900 bg-emerald-50 dark:bg-emerald-900/20 p-3 text-sm text-emerald-800 dark:text-emerald-300"></div>
                    </div>
                </div>
                
                <!-- Admin Actions -->
                <div class="mt-4 rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-slate-200 dark:ring-slate-700 shadow-sm">
                    <div class="border-b border-slate-200 dark:border-slate-700 px-5 py-4">
                        <h2 class="text-lg font-semibold">System Management</h2>
                    </div>
                    <div class="px-5 py-5 space-y-3">
                        <button onclick="viewAllAdmins()" class="flex w-full items-center justify-between rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-4 hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary/10 text-primary">
                                    <span class="material-symbols-outlined">group</span>
                                </div>
                                <div class="text-left">
                                    <h3 class="text-sm font-semibold text-slate-900 dark:text-white">View All Admins</h3>
                                    <p class="text-xs text-slate-600 dark:text-slate-400">Manage admin accounts</p>
                                </div>
                            </div>
                            <span class="material-symbols-outlined text-slate-400">chevron_right</span>
                        </button>
                        
                        <button onclick="viewAllAttendance()" class="flex w-full items-center justify-between rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-4 hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary/10 text-primary">
                                    <span class="material-symbols-outlined">fact_check</span>
                                </div>
                                <div class="text-left">
                                    <h3 class="text-sm font-semibold text-slate-900 dark:text-white">All Attendance Records</h3>
                                    <p class="text-xs text-slate-600 dark:text-slate-400">View and export records</p>
                                </div>
                            </div>
                            <span class="material-symbols-outlined text-slate-400">chevron_right</span>
                        </button>
                        
                        <button onclick="systemSettings()" class="flex w-full items-center justify-between rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-4 hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary/10 text-primary">
                                    <span class="material-symbols-outlined">settings</span>
                                </div>
                                <div class="text-left">
                                    <h3 class="text-sm font-semibold text-slate-900 dark:text-white">System Settings</h3>
                                    <p class="text-xs text-slate-600 dark:text-slate-400">Configure system preferences</p>
                                </div>
                            </div>
                            <span class="material-symbols-outlined text-slate-400">chevron_right</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PIN Generation Modal -->
        <div id="pinModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
            <div class="w-full max-w-sm rounded-2xl bg-white dark:bg-slate-800 p-6 shadow-xl">
                <div class="flex flex-col items-center text-center">
                    <div class="flex h-16 w-16 items-center justify-center rounded-full bg-primary/10 mb-4">
                        <span class="material-symbols-outlined text-primary text-3xl">lock</span>
                    </div>
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white">Lecturer PIN Generated</h3>
                    <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">
                        Share this PIN with the lecturer for dashboard access.
                    </p>
                    
                    <div class="mt-4 w-full">
                        <div class="rounded-xl bg-primary/5 p-4">
                            <div class="text-center">
                                <p class="text-xs text-slate-600 dark:text-slate-400 mb-2">Lecturer PIN</p>
                                <p id="generatedPin" class="text-4xl font-bold tracking-widest text-primary mb-2">000000</p>
                                <p id="pinLecturerName" class="text-sm font-semibold text-slate-900 dark:text-white"></p>
                                <p id="pinExpiryInfo" class="text-xs text-slate-600 dark:text-slate-400 mt-1"></p>
                            </div>
                        </div>
                        
                        <div class="mt-4 grid grid-cols-2 gap-2">
                            <button onclick="copyPinToClipboard()" class="rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-2 text-sm font-semibold text-slate-900 dark:text-white hover:bg-slate-50 dark:hover:bg-slate-700">
                                Copy PIN
                            </button>
                            <button onclick="closePinModal()" class="rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary-hover">
                                Done
                            </button>
                        </div>
                        
                        <div class="mt-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-3">
                            <p class="text-xs font-semibold text-slate-700 dark:text-slate-300">Security Note</p>
                            <p class="mt-1 text-xs text-slate-600 dark:text-slate-400">
                                This PIN should be shared securely with the lecturer. It will expire on the specified date.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Success Modal (Hidden) -->
        <div id="successModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
            <div class="w-full max-w-sm rounded-2xl bg-white dark:bg-slate-800 p-6 shadow-xl">
                <div class="flex flex-col items-center text-center">
                    <div class="flex h-16 w-16 items-center justify-center rounded-full bg-emerald-100 dark:bg-emerald-900/30 mb-4">
                        <span class="material-symbols-outlined text-emerald-600 dark:text-emerald-400 text-3xl">check_circle</span>
                    </div>
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white">Attendance Submitted!</h3>
                    <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">
                        Your attendance has been successfully recorded and saved locally on this device.
                    </p>
                    <div class="mt-6 flex w-full gap-3">
                        <button onclick="closeSuccessModal()" class="flex-1 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-2 text-sm font-semibold text-slate-900 dark:text-white hover:bg-slate-50 dark:hover:bg-slate-700">
                            Close
                        </button>
                        <button onclick="viewAttendanceRecord()" class="flex-1 rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary-hover">
                            View Record
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Help Modal (Hidden) -->
        <div id="helpModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
            <div class="w-full max-w-md rounded-2xl bg-white dark:bg-slate-800 p-6 shadow-xl max-h-[80vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white">Help & Support</h3>
                    <button onclick="closeHelpModal()" class="text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold text-slate-900 dark:text-white">Student Attendance Guide</h4>
                        <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">
                            1. Login or sign up with your matric number<br>
                            2. Allow location access when prompted<br>
                            3. Start camera and capture your face clearly<br>
                            4. Fill in the required attendance form fields<br>
                            5. Submit your attendance
                        </p>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-slate-900 dark:text-white">Multi-Device Access</h4>
                        <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">
                            Your student account works across all devices. Once created on one device, you can login from any other device using your matric number and password.
                        </p>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-slate-900 dark:text-white">Lecturer Access</h4>
                        <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">
                            Contact the system administrator to receive your access PIN. 
                            Use the PIN to access the lecturer dashboard for managing classes and attendance.
                        </p>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-slate-900 dark:text-white">Admin PIN Generation</h4>
                        <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">
                            Administrators can generate 6-digit PINs for lecturers with customizable expiry periods.
                            PINs can be auto-generated or custom created for specific lecturers.
                        </p>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-slate-900 dark:text-white">Technical Support</h4>
                        <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">
                            For technical issues, contact:<br>
                            Email: support@nsuk-urp.edu.ng<br>
                            Phone: +234 123 456 7890<br>
                            Office Hours: 9AM - 5PM (Weekdays)
                        </p>
                    </div>
                    
                    <div class="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-4">
                        <h4 class="font-semibold text-slate-900 dark:text-white">Privacy Information</h4>
                        <p class="mt-1 text-xs text-slate-600 dark:text-slate-400">
                            This system operates locally on your device. No data is uploaded to external servers. 
                            All attendance records are stored in your browser's local storage and can be cleared 
                            through your browser settings.
                        </p>
                    </div>
                </div>
                
                <button onclick="closeHelpModal()" class="mt-6 w-full rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary-hover">
                    Close Help
                </button>
            </div>
        </div>
        
        <!-- Create Session Modal -->
        <div id="createSessionModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
            <div class="w-full max-w-sm rounded-2xl bg-white dark:bg-slate-800 p-6 shadow-xl">
                <div class="flex flex-col items-center text-center">
                    <div class="flex h-16 w-16 items-center justify-center rounded-full bg-primary/10 mb-4">
                        <span class="material-symbols-outlined text-primary text-3xl">add_circle</span>
                    </div>
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white">Create New Session</h3>
                    <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">
                        Start a new attendance session for your class.
                    </p>
                    
                    <div class="mt-4 w-full">
                        <div class="space-y-4">
                            <div>
                                <label for="sessionCourse" class="block text-sm font-semibold text-slate-900 dark:text-white">Course Code</label>
                                <input id="sessionCourse" type="text" class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="e.g., URP 111" />
                            </div>
                            
                            <div>
                                <label for="sessionTopic" class="block text-sm font-semibold text-slate-900 dark:text-white">Session Topic</label>
                                <input id="sessionTopic" type="text" class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="e.g., Introduction to Urban Planning" />
                            </div>
                            
                            <div>
                                <label for="sessionDuration" class="block text-sm font-semibold text-slate-900 dark:text-white">Duration (minutes)</label>
                                <input id="sessionDuration" type="number" min="15" max="180" value="60" class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" />
                            </div>
                            
                            <div class="flex items-center">
                                <input id="generateSessionCode" type="checkbox" checked class="rounded border-slate-300 dark:border-slate-600 text-primary focus:ring-primary/50" />
                                <label for="generateSessionCode" class="ml-2 text-sm text-slate-700 dark:text-slate-300">
                                    Generate session code for students
                                </label>
                            </div>
                        </div>
                        
                        <div class="mt-6 grid grid-cols-2 gap-2">
                            <button onclick="closeCreateSessionModal()" class="rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-2 text-sm font-semibold text-slate-900 dark:text-white hover:bg-slate-50 dark:hover:bg-slate-700">
                                Cancel
                            </button>
                            <button onclick="startNewSession()" class="rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary-hover">
                                Start Session
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Session Created Modal -->
        <div id="sessionCreatedModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
            <div class="w-full max-w-sm rounded-2xl bg-white dark:bg-slate-800 p-6 shadow-xl">
                <div class="flex flex-col items-center text-center">
                    <div class="flex h-16 w-16 items-center justify-center rounded-full bg-emerald-100 dark:bg-emerald-900/30 mb-4">
                        <span class="material-symbols-outlined text-emerald-600 dark:text-emerald-400 text-3xl">check_circle</span>
                    </div>
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white">Session Created!</h3>
                    <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">
                        Share this code with students to join the attendance session.
                    </p>
                    
                    <div class="mt-4 w-full">
                        <div class="rounded-xl bg-primary/5 p-4">
                            <div class="text-center">
                                <p class="text-xs text-slate-600 dark:text-slate-400 mb-2">Session Code</p>
                                <p id="sessionCode" class="text-4xl font-bold tracking-widest text-primary mb-2">URP123</p>
                                <p id="sessionCourseName" class="text-sm font-semibold text-slate-900 dark:text-white"></p>
                                <p id="sessionTopicName" class="text-xs text-slate-600 dark:text-slate-400 mt-1"></p>
                                <p id="sessionExpiry" class="text-xs text-slate-600 dark:text-slate-400 mt-1">Expires in 60 minutes</p>
                            </div>
                        </div>
                        
                        <div class="mt-4 grid grid-cols-2 gap-2">
                            <button onclick="copySessionCode()" class="rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-2 text-sm font-semibold text-slate-900 dark:text-white hover:bg-slate-50 dark:hover:bg-slate-700">
                                Copy Code
                            </button>
                            <button onclick="closeSessionCreatedModal()" class="rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary-hover">
                                Done
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Past Sessions Modal -->
        <div id="pastSessionsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
            <div class="w-full max-w-md rounded-2xl bg-white dark:bg-slate-800 p-6 shadow-xl max-h-[80vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white">Past Sessions</h3>
                    <button onclick="closePastSessionsModal()" class="text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                
                <div class="space-y-3">
                    <div id="pastSessionsList">
                        <!-- Sessions will be loaded here -->
                    </div>
                    
                    <div class="mt-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-4">
                        <p class="text-xs font-semibold text-slate-700 dark:text-slate-300">Export Options</p>
                        <p class="mt-1 text-xs text-slate-600 dark:text-slate-400">
                            Download attendance records from past sessions in PDF format.
                        </p>
                        <div class="mt-3 grid grid-cols-2 gap-2">
                            <button onclick="downloadAllSessionsPDF()" class="rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary-hover">
                                All Sessions PDF
                            </button>
                            <button onclick="downloadTodaySessionsPDF()" class="rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-2 text-sm font-semibold text-slate-900 dark:text-white hover:bg-slate-50 dark:hover:bg-slate-700">
                                Today's PDF
                            </button>
                        </div>
                    </div>
                </div>
                
                <button onclick="closePastSessionsModal()" class="mt-6 w-full rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary-hover">
                    Close
                </button>
            </div>
        </div>

        <!-- Face Image Modal -->
        <div id="faceImageModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4">
            <div class="w-full max-w-md rounded-2xl bg-white dark:bg-slate-800 p-4 shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white" id="faceModalTitle"></h3>
                    <button onclick="closeFaceImageModal()" class="text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div class="rounded-xl overflow-hidden bg-slate-900/5 dark:bg-slate-900/20 mb-4">
                    <img id="faceModalImage" alt="Captured face" class="w-full h-auto" />
                </div>
                <div class="text-sm text-slate-600 dark:text-slate-400 mb-4">
                    <p id="faceModalDetails"></p>
                    <p class="mt-2 text-xs">Image stored locally in browser storage</p>
                </div>
                <button onclick="closeFaceImageModal()" class="w-full rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary-hover">
                    Close
                </button>
            </div>
        </div>
        
    </div>
    
    <!-- JavaScript -->
    <script>
        // Application State
        let appState = {
            location: null,
            faceImage: null,
            isCameraActive: false,
            stream: null,
            isFormUnlocked: false,
            currentScreen: 'splash-screen',
            demoMode: false,
            currentAdmin: null,
            currentStudent: null,
            isOnline: navigator.onLine,
            generatedPin: null,
            lecturerUnlocked: false,
            sessions: JSON.parse(localStorage.getItem('nsukAttendanceSessions') || '[]')
        };

        // Backend API Simulation (For Multi-device Support)
        const BACKEND_SIMULATION = {
            // Simulated backend endpoints
            API_BASE: 'https://api.nsuk-urp.edu.ng',
            
            // Simulate API call with localStorage as "backend"
            async call(endpoint, method = 'GET', data = null) {
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 300));
                
                try {
                    // For demo purposes, use localStorage as simulated backend
                    switch(endpoint) {
                        case '/auth/login':
                            return this.handleLogin(data);
                        case '/auth/signup':
                            return this.handleSignup(data);
                        case '/auth/validate':
                            return this.validateToken(data);
                        case '/auth/student-login':
                            return this.handleStudentLogin(data);
                        case '/auth/student-signup':
                            return this.handleStudentSignup(data);
                        case '/admins/list':
                            return this.getAdmins();
                        case '/attendance/list':
                            return this.getAttendance();
                        case '/pins/generate':
                            return this.generatePin(data);
                        case '/pins/list':
                            return this.getPins();
                        case '/pins/validate':
                            return this.validatePin(data);
                        default:
                            throw new Error('Endpoint not found');
                    }
                } catch (error) {
                    return {
                        success: false,
                        error: error.message
                    };
                }
            },
            
            // ========== ADMIN FUNCTIONS ==========
            handleLogin(credentials) {
                const admins = JSON.parse(localStorage.getItem('nsukAdminAccounts') || '[]');
                const admin = admins.find(a => 
                    a.username === credentials.username && 
                    a.password === credentials.password
                );
                
                if (admin) {
                    // Generate simulated token
                    const token = btoa(JSON.stringify({
                        id: admin.id,
                        username: admin.username,
                        exp: Date.now() + 86400000 // 24 hours
                    }));
                    
                    // Store in session storage (simulated)
                    sessionStorage.setItem('nsukAdminToken', token);
                    
                    return {
                        success: true,
                        token: token,
                        admin: {
                            id: admin.id,
                            name: admin.name,
                            email: admin.email,
                            username: admin.username
                        }
                    };
                } else {
                    return {
                        success: false,
                        error: 'Invalid credentials'
                    };
                }
            },
            
            handleSignup(data) {
                const admins = JSON.parse(localStorage.getItem('nsukAdminAccounts') || '[]');
                
                // Check if username or email exists
                if (admins.some(a => a.username === data.username)) {
                    return {
                        success: false,
                        error: 'Username already exists'
                    };
                }
                
                if (admins.some(a => a.email === data.email)) {
                    return {
                        success: false,
                        error: 'Email already registered'
                    };
                }
                
                // Create new admin
                const newAdmin = {
                    id: Date.now(),
                    name: data.name,
                    email: data.email,
                    username: data.username,
                    password: data.password, // In production, this would be hashed
                    createdAt: new Date().toISOString(),
                    isActive: true,
                    permissions: ['view', 'edit', 'delete']
                };
                
                admins.push(newAdmin);
                localStorage.setItem('nsukAdminAccounts', JSON.stringify(admins));
                
                // Sync across devices (simulated)
                this.syncToCloud(admins, 'nsukAdminAccounts');
                
                // Generate token
                const token = btoa(JSON.stringify({
                    id: newAdmin.id,
                    username: newAdmin.username,
                    exp: Date.now() + 86400000
                }));
                
                sessionStorage.setItem('nsukAdminToken', token);
                
                return {
                    success: true,
                    token: token,
                    admin: {
                        id: newAdmin.id,
                        name: newAdmin.name,
                        email: newAdmin.email,
                        username: newAdmin.username
                    }
                };
            },
            
            // ========== STUDENT FUNCTIONS ==========
            handleStudentLogin(credentials) {
                const students = JSON.parse(localStorage.getItem('nsukStudentAccounts') || '[]');
                const student = students.find(s => 
                    s.matric === credentials.matric && 
                    s.password === credentials.password
                );
                
                if (student) {
                    // Generate simulated token
                    const token = btoa(JSON.stringify({
                        id: student.id,
                        matric: student.matric,
                        exp: Date.now() + 86400000 // 24 hours
                    }));
                    
                    // Store in session storage
                    sessionStorage.setItem('nsukStudentToken', token);
                    
                    return {
                        success: true,
                        token: token,
                        student: {
                            id: student.id,
                            name: student.name,
                            matric: student.matric,
                            email: student.email
                        }
                    };
                } else {
                    return {
                        success: false,
                        error: 'Invalid matric number or password'
                    };
                }
            },
            
            handleStudentSignup(data) {
                const students = JSON.parse(localStorage.getItem('nsukStudentAccounts') || '[]');
                
                // Check if matric number already exists
                if (students.some(s => s.matric === data.matric)) {
                    return {
                        success: false,
                        error: 'Matric number already registered'
                    };
                }
                
                // Check if email already exists
                if (students.some(s => s.email === data.email)) {
                    return {
                        success: false,
                        error: 'Email already registered'
                    };
                }
                
                // Create new student
                const newStudent = {
                    id: Date.now(),
                    name: data.name,
                    matric: data.matric,
                    email: data.email,
                    password: data.password, // In production, this would be hashed
                    createdAt: new Date().toISOString(),
                    isActive: true,
                    department: 'Urban and Regional Planning'
                };
                
                students.push(newStudent);
                localStorage.setItem('nsukStudentAccounts', JSON.stringify(students));
                
                // Sync across devices (simulated)
                this.syncToCloud(students, 'nsukStudentAccounts');
                
                // Generate token
                const token = btoa(JSON.stringify({
                    id: newStudent.id,
                    matric: newStudent.matric,
                    exp: Date.now() + 86400000
                }));
                
                sessionStorage.setItem('nsukStudentToken', token);
                
                return {
                    success: true,
                    token: token,
                    student: {
                        id: newStudent.id,
                        name: newStudent.name,
                        matric: newStudent.matric,
                        email: newStudent.email
                    }
                };
            },
            
            validateToken(token) {
                try {
                    const payload = JSON.parse(atob(token));
                    if (payload.exp > Date.now()) {
                        // Check if it's a student or admin token
                        if (payload.matric) {
                            const students = JSON.parse(localStorage.getItem('nsukStudentAccounts') || '[]');
                            const student = students.find(s => s.id === payload.id);
                            
                            if (student) {
                                return {
                                    success: true,
                                    type: 'student',
                                    data: {
                                        id: student.id,
                                        name: student.name,
                                        matric: student.matric,
                                        email: student.email
                                    }
                                };
                            }
                        } else {
                            const admins = JSON.parse(localStorage.getItem('nsukAdminAccounts') || '[]');
                            const admin = admins.find(a => a.id === payload.id);
                            
                            if (admin) {
                                return {
                                    success: true,
                                    type: 'admin',
                                    data: {
                                        id: admin.id,
                                        name: admin.name,
                                        email: admin.email,
                                        username: admin.username
                                    }
                                };
                            }
                        }
                    }
                } catch (e) {
                    // Invalid token
                }
                
                return {
                    success: false,
                    error: 'Invalid or expired token'
                };
            },
            
            getAdmins() {
                const admins = JSON.parse(localStorage.getItem('nsukAdminAccounts') || '[]');
                return {
                    success: true,
                    data: admins.map(a => ({
                        id: a.id,
                        name: a.name,
                        email: a.email,
                        username: a.username,
                        createdAt: a.createdAt,
                        isActive: a.isActive
                    }))
                };
            },
            
            getAttendance() {
                const records = JSON.parse(localStorage.getItem('nsukAttendanceRecords') || '[]');
                return {
                    success: true,
                    data: records
                };
            },
            
            generatePin(data) {
                try {
                    const pins = JSON.parse(localStorage.getItem('nsukLecturerPins') || '[]');
                    
                    // Generate 6-digit PIN
                    let pin;
                    if (data.autoGenerate) {
                        // Auto-generate unique PIN
                        do {
                            pin = Math.floor(100000 + Math.random() * 900000).toString();
                        } while (pins.some(p => p.pin === pin && new Date(p.expiry) > new Date()));
                    } else {
                        pin = data.customPin;
                        // Check if PIN already exists and is still valid
                        const existingPin = pins.find(p => p.pin === pin && new Date(p.expiry) > new Date());
                        if (existingPin) {
                            return {
                                success: false,
                                error: 'This PIN is already in use. Please choose a different PIN.'
                            };
                        }
                    }
                    
                    // Calculate expiry date
                    const expiryDays = parseInt(data.expiry) || 7;
                    const expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + expiryDays);
                    
                    const newPin = {
                        id: Date.now(),
                        pin: pin,
                        lecturerName: data.lecturerName || 'Unnamed Lecturer',
                        lecturerEmail: data.lecturerEmail || '',
                        generatedBy: appState.currentAdmin?.name || 'System Admin',
                        generatedAt: new Date().toISOString(),
                        expiry: expiryDate.toISOString(),
                        isActive: true,
                        usageCount: 0,
                        lastUsed: null
                    };
                    
                    pins.push(newPin);
                    localStorage.setItem('nsukLecturerPins', JSON.stringify(pins));
                    
                    return {
                        success: true,
                        pin: newPin
                    };
                } catch (error) {
                    return {
                        success: false,
                        error: error.message
                    };
                }
            },
            
            getPins() {
                const pins = JSON.parse(localStorage.getItem('nsukLecturerPins') || '[]');
                return {
                    success: true,
                    data: pins
                };
            },
            
            validatePin(pin) {
                const pins = JSON.parse(localStorage.getItem('nsukLecturerPins') || '[]');
                const pinRecord = pins.find(p => p.pin === pin);
                
                if (!pinRecord) {
                    return {
                        success: false,
                        error: 'Invalid PIN'
                    };
                }
                
                if (!pinRecord.isActive) {
                    return {
                        success: false,
                        error: 'PIN is deactivated'
                    };
                }
                
                const now = new Date();
                const expiry = new Date(pinRecord.expiry);
                
                if (now > expiry) {
                    return {
                        success: false,
                        error: 'PIN has expired'
                    };
                }
                
                // Update usage count
                pinRecord.usageCount = (pinRecord.usageCount || 0) + 1;
                pinRecord.lastUsed = now.toISOString();
                localStorage.setItem('nsukLecturerPins', JSON.stringify(pins));
                
                return {
                    success: true,
                    pin: pinRecord
                };
            },
            
            // Simulate cloud sync for multi-device support
            syncToCloud(data, key) {
                // In a real app, this would sync to a backend
                console.log(`Syncing ${key} to cloud...`, data.length, 'records');
                // Store in multiple localStorage keys to simulate cloud persistence
                localStorage.setItem(key + '_cloud', JSON.stringify(data));
                localStorage.setItem(key + '_lastSync', new Date().toISOString());
            },
            
            // Check for cloud sync
            checkCloudSync() {
                // Sync admin accounts
                const adminCloudData = localStorage.getItem('nsukAdminAccounts_cloud');
                const adminLocalData = localStorage.getItem('nsukAdminAccounts');
                
                if (adminCloudData && adminLocalData) {
                    const cloud = JSON.parse(adminCloudData);
                    const local = JSON.parse(adminLocalData);
                    
                    // Merge data (simple implementation - cloud wins)
                    if (cloud.length > local.length) {
                        localStorage.setItem('nsukAdminAccounts', JSON.stringify(cloud));
                        console.log('Admin data synced from cloud');
                    }
                }
                
                // Sync student accounts
                const studentCloudData = localStorage.getItem('nsukStudentAccounts_cloud');
                const studentLocalData = localStorage.getItem('nsukStudentAccounts');
                
                if (studentCloudData && studentLocalData) {
                    const cloud = JSON.parse(studentCloudData);
                    const local = JSON.parse(studentLocalData);
                    
                    // Merge data (simple implementation - cloud wins)
                    if (cloud.length > local.length) {
                        localStorage.setItem('nsukStudentAccounts', JSON.stringify(cloud));
                        console.log('Student data synced from cloud');
                    }
                }
            }
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            // Set current year in footer
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // Initialize multi-device admin system
            initializeMultiDeviceAdminSystem();
            
            // Initialize student accounts system
            initializeStudentAccountsSystem();
            
            // Initialize PIN system
            initializePinSystem();
            
            // Initialize sessions
            initializeSessions();
            
            // Check cloud sync
            BACKEND_SIMULATION.checkCloudSync();
            
            // Simulate loading process
            simulateLoading();
            
            // Initialize date/time display
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Check for saved theme preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
            }
            
            // Initialize form validation
            initializeFormValidation();
            
            // Check if we're in HTTPS (required for geolocation/camera)
            checkSecurityEnvironment();
            
            // Check for remembered logins
            checkRememberedLogins();
            
            // Initialize PIN auto-generation toggle
            document.getElementById('autoGenerate')?.addEventListener('change', function() {
                const customPinSection = document.getElementById('customPinSection');
                if (!this.checked) {
                    customPinSection.classList.remove('hidden');
                } else {
                    customPinSection.classList.add('hidden');
                }
            });
            
            // Initialize search functionality
            document.getElementById('searchInput')?.addEventListener('input', function() {
                renderAttendanceTable();
            });
            
            // Listen for online/offline status
            window.addEventListener('online', () => {
                appState.isOnline = true;
                console.log('App is online');
                // Sync data when coming online
                BACKEND_SIMULATION.checkCloudSync();
            });
            
            window.addEventListener('offline', () => {
                appState.isOnline = false;
                console.log('App is offline - working in local mode');
            });
        });

        // Initialize multi-device admin system
        function initializeMultiDeviceAdminSystem() {
            // Check if admin accounts exist in localStorage
            let admins = JSON.parse(localStorage.getItem('nsukAdminAccounts') || '[]');
            
            if (admins.length === 0) {
                // Create SINGLE default admin account that works on any device
                const defaultAdmin = {
                    id: 1001,
                    name: 'System Administrator',
                    email: 'admin@nsuk-urp.edu.ng',
                    username: 'admin',
                    password: 'Admin@123', // Stronger default password
                    createdAt: new Date().toISOString(),
                    isActive: true,
                    permissions: ['view', 'edit', 'delete', 'manage_users', 'generate_pins'],
                    role: 'super_admin',
                    isSingleUser: true // Mark as single user
                };
                
                admins.push(defaultAdmin);
                localStorage.setItem('nsukAdminAccounts', JSON.stringify(admins));
                
                console.log('Single admin account system initialized');
            }
            
            // Check for existing admin session
            const token = sessionStorage.getItem('nsukAdminToken');
            if (token) {
                const result = BACKEND_SIMULATION.validateToken(token);
                if (result.success && result.type === 'admin') {
                    appState.currentAdmin = result.data;
                    // Auto-login if token is valid
                    setTimeout(() => {
                        if (window.location.hash !== '#logout') {
                            showScreen('admin-dashboard');
                            document.getElementById('adminWelcomeName').textContent = result.data.name;
                        }
                    }, 500);
                }
            }
        }

        // Initialize student accounts system
        function initializeStudentAccountsSystem() {
            // Check if student accounts exist in localStorage
            let students = JSON.parse(localStorage.getItem('nsukStudentAccounts') || '[]');
            
            if (students.length === 0) {
                // Create sample student accounts for demonstration
                const sampleStudents = [
                    {
                        id: 2001,
                        name: 'Abdullahi Suleiman',
                        matric: 'URP/2023/001',
                        email: 'abdullahi.suleiman@student.nsuk.edu.ng',
                        password: 'Student@123',
                        createdAt: new Date().toISOString(),
                        isActive: true,
                        department: 'Urban and Regional Planning'
                    },
                    {
                        id: 2002,
                        name: 'Fatima Ahmed',
                        matric: 'URP/2023/002',
                        email: 'fatima.ahmed@student.nsuk.edu.ng',
                        password: 'Student@123',
                        createdAt: new Date().toISOString(),
                        isActive: true,
                        department: 'Urban and Regional Planning'
                    }
                ];
                
                localStorage.setItem('nsukStudentAccounts', JSON.stringify(sampleStudents));
                console.log('Student accounts system initialized with sample data');
            }
            
            // Check for existing student session
            const token = sessionStorage.getItem('nsukStudentToken');
            if (token) {
                const result = BACKEND_SIMULATION.validateToken(token);
                if (result.success && result.type === 'student') {
                    appState.currentStudent = result.data;
                    // Auto-login if token is valid
                    setTimeout(() => {
                        showScreen('student-attendance');
                        updateStudentAttendanceForm();
                        document.getElementById('studentNameBadge').textContent = result.data.name;
                    }, 500);
                }
            }
        }

        // Initialize PIN system
        function initializePinSystem() {
            // Create default PINs if none exist
            const pins = JSON.parse(localStorage.getItem('nsukLecturerPins') || '[]');
            
            if (pins.length === 0) {
                // Create sample PINs for demonstration
                const samplePins = [
                    {
                        id: 1,
                        pin: '123456',
                        lecturerName: 'Dr. John Smith',
                        lecturerEmail: 'john.smith@nsuk.edu.ng',
                        generatedBy: 'System Admin',
                        generatedAt: new Date().toISOString(),
                        expiry: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                        isActive: true,
                        usageCount: 5,
                        lastUsed: new Date().toISOString()
                    },
                    {
                        id: 2,
                        pin: '654321',
                        lecturerName: 'Prof. Jane Doe',
                        lecturerEmail: 'jane.doe@nsuk.edu.ng',
                        generatedBy: 'System Admin',
                        generatedAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                        expiry: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000).toISOString(),
                        isActive: true,
                        usageCount: 2,
                        lastUsed: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()
                    }
                ];
                
                localStorage.setItem('nsukLecturerPins', JSON.stringify(samplePins));
                console.log('PIN system initialized with sample PINs');
            }
        }

        // Initialize sessions
        function initializeSessions() {
            if (!localStorage.getItem('nsukAttendanceSessions')) {
                const sampleSessions = [
                    {
                        id: 'sess_001',
                        course: 'URP 111',
                        topic: 'Introduction to Urban Planning',
                        code: 'URP001',
                        date: new Date().toISOString(),
                        duration: 60,
                        attendanceCount: 25,
                        totalStudents: 30
                    },
                    {
                        id: 'sess_002',
                        course: 'URP 211',
                        topic: 'Urban Design Principles',
                        code: 'URP002',
                        date: new Date(Date.now() - 86400000).toISOString(),
                        duration: 90,
                        attendanceCount: 28,
                        totalStudents: 32
                    }
                ];
                localStorage.setItem('nsukAttendanceSessions', JSON.stringify(sampleSessions));
                appState.sessions = sampleSessions;
            }
        }

        // Check for remembered logins
        function checkRememberedLogins() {
            // Check for remembered admin
            const rememberedAdmin = localStorage.getItem('nsukAdminRemember');
            if (rememberedAdmin) {
                document.getElementById('adminUsername').value = rememberedAdmin;
                document.getElementById('rememberMe').checked = true;
            }
            
            // Check for remembered student
            const rememberedStudent = localStorage.getItem('nsukStudentRemember');
            if (rememberedStudent) {
                document.getElementById('studentLoginMatric').value = rememberedStudent;
                document.getElementById('studentRememberMe').checked = true;
            }
        }

        function checkSecurityEnvironment() {
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const isHttps = window.location.protocol === 'https:';
            
            if (!isHttps && !isLocalhost) {
                console.warn('Geolocation and Camera API require HTTPS or localhost for full functionality');
                appState.demoMode = false;
            }
        }

        // Loading simulation
        function simulateLoading() {
            let progress = 0;
            const loadingBar = document.getElementById('loading-bar');
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('splash-screen').style.opacity = '0';
                        setTimeout(() => {
                            document.getElementById('splash-screen').classList.add('hidden');
                            showScreen('role-selection-screen');
                        }, 500);
                    }, 300);
                }
                loadingBar.style.width = progress + '%';
            }, 150);
        }

        // Screen navigation
        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('[id$="screen"], [id^="student-"], [id^="lecturer-"], [id^="admin-"]').forEach(el => {
                if (el.id !== 'splash-screen') {
                    el.classList.add('hidden');
                }
            });
            
            // Show selected screen
            const screen = document.getElementById(screenId);
            if (screen) {
                screen.classList.remove('hidden');
                appState.currentScreen = screenId;
                
                // Reset form if going back to student attendance
                if (screenId === 'student-attendance') {
                    resetStudentForm();
                }
                
                // Stop camera if leaving student attendance
                if (screenId !== 'student-attendance' && appState.isCameraActive) {
                    stopCamera();
                }
                
                // Update admin dashboard stats if showing
                if (screenId === 'admin-dashboard') {
                    updateAdminDashboard();
                }
                
                // Update lecturer dashboard if showing
                if (screenId === 'lecturer-dashboard' && appState.lecturerUnlocked) {
                    updateLecturerDashboard();
                }
            }
        }

        // ========== STUDENT AUTHENTICATION FUNCTIONS ==========
        function toggleStudentPasswordVisibility(inputId, iconId) {
            const passwordInput = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.textContent = 'visibility';
            } else {
                passwordInput.type = 'password';
                icon.textContent = 'visibility_off';
            }
        }

        function showStudentTab(tab) {
            const loginTab = document.getElementById('studentLoginTab');
            const signupTab = document.getElementById('studentSignupTab');
            const loginForm = document.getElementById('studentLoginForm');
            const signupForm = document.getElementById('studentSignupForm');
            const errorDiv = document.getElementById('studentAuthError');
            const successDiv = document.getElementById('studentAuthSuccess');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            if (tab === 'login') {
                loginTab.classList.add('text-primary', 'border-primary');
                loginTab.classList.remove('text-slate-600', 'border-transparent');
                signupTab.classList.remove('text-primary', 'border-primary');
                signupTab.classList.add('text-slate-600', 'border-transparent');
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
            } else {
                signupTab.classList.add('text-primary', 'border-primary');
                signupTab.classList.remove('text-slate-600', 'border-transparent');
                loginTab.classList.remove('text-primary', 'border-primary');
                loginTab.classList.add('text-slate-600', 'border-transparent');
                signupForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }

        async function studentLogin(event) {
            event.preventDefault();
            
            const matric = document.getElementById('studentLoginMatric').value.trim();
            const password = document.getElementById('studentLoginPassword').value;
            const errorDiv = document.getElementById('studentAuthError');
            const successDiv = document.getElementById('studentAuthSuccess');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            if (!matric || !password) {
                errorDiv.textContent = 'Please enter both matric number and password.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Signing in...';
            submitBtn.disabled = true;
            
            try {
                // Use simulated backend API
                const result = await BACKEND_SIMULATION.call('/auth/student-login', 'POST', {
                    matric: matric,
                    password: password
                });
                
                if (result.success) {
                    successDiv.textContent = 'Login successful! Redirecting to attendance...';
                    successDiv.classList.remove('hidden');
                    
                    // Store current student session
                    appState.currentStudent = result.student;
                    
                    // Remember me functionality
                    const rememberMe = document.getElementById('studentRememberMe').checked;
                    if (rememberMe) {
                        localStorage.setItem('nsukStudentRemember', matric);
                    } else {
                        localStorage.removeItem('nsukStudentRemember');
                    }
                    
                    // Update student attendance form with student info
                    setTimeout(() => {
                        showScreen('student-attendance');
                        updateStudentAttendanceForm();
                        document.getElementById('studentNameBadge').textContent = result.student.name;
                    }, 1000);
                } else {
                    errorDiv.textContent = result.error || 'Invalid matric number or password.';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Network error. Please check your connection and try again.';
                errorDiv.classList.remove('hidden');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        async function studentSignup(event) {
            event.preventDefault();
            
            const name = document.getElementById('studentSignupName').value.trim();
            const matric = document.getElementById('studentSignupMatric').value.trim();
            const email = document.getElementById('studentSignupEmail').value.trim();
            const password = document.getElementById('studentSignupPassword').value;
            const confirmPassword = document.getElementById('studentConfirmPassword').value;
            const termsAgreed = document.getElementById('studentTermsAgreement').checked;
            
            const errorDiv = document.getElementById('studentAuthError');
            const successDiv = document.getElementById('studentAuthSuccess');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Validation
            if (!name || !matric || !email || !password || !confirmPassword) {
                errorDiv.textContent = 'Please fill in all fields.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (password.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters long.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (password !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (!termsAgreed) {
                errorDiv.textContent = 'Please agree to the Terms of Service.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Creating account...';
            submitBtn.disabled = true;
            
            try {
                // Use simulated backend API
                const result = await BACKEND_SIMULATION.call('/auth/student-signup', 'POST', {
                    name: name,
                    matric: matric,
                    email: email,
                    password: password
                });
                
                if (result.success) {
                    successDiv.textContent = 'Account created successfully! Redirecting to attendance...';
                    successDiv.classList.remove('hidden');
                    
                    // Store current student session
                    appState.currentStudent = result.student;
                    
                    // Clear form
                    document.getElementById('studentSignupFormElement').reset();
                    
                    // Update student attendance form with student info
                    setTimeout(() => {
                        showScreen('student-attendance');
                        updateStudentAttendanceForm();
                        document.getElementById('studentNameBadge').textContent = result.student.name;
                    }, 1500);
                } else {
                    errorDiv.textContent = result.error || 'Account creation failed. Please try again.';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Network error. Please check your connection and try again.';
                errorDiv.classList.remove('hidden');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        function studentForgotPassword() {
            alert('Student Password Reset\n\nPlease contact your department administrator or system admin to reset your password.\n\nYou can also create a new account with a different email if needed.');
        }

        function updateStudentAttendanceForm() {
            if (appState.currentStudent) {
                // Auto-fill the form with student information
                document.getElementById('studentName').value = appState.currentStudent.name;
                document.getElementById('matricNo').value = appState.currentStudent.matric;
                
                // Make fields read-only since they come from the logged-in student account
                document.getElementById('studentName').readOnly = true;
                document.getElementById('matricNo').readOnly = true;
                
                // Add visual indication
                document.getElementById('studentName').classList.add('bg-slate-50', 'dark:bg-slate-800');
                document.getElementById('matricNo').classList.add('bg-slate-50', 'dark:bg-slate-800');
            }
        }

        function studentLogout() {
            // Clear student session
            appState.currentStudent = null;
            sessionStorage.removeItem('nsukStudentToken');
            localStorage.removeItem('nsukStudentRemember');
            
            // Reset student form
            document.getElementById('studentName').readOnly = false;
            document.getElementById('matricNo').readOnly = false;
            document.getElementById('studentName').classList.remove('bg-slate-50', 'dark:bg-slate-800');
            document.getElementById('matricNo').classList.remove('bg-slate-50', 'dark:bg-slate-800');
            
            showScreen('student-auth');
            
            // Show logout message
            setTimeout(() => {
                alert('Logged out successfully. You can login from any device using your matric number and password.');
            }, 500);
        }

        // Update date and time display
        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
            const timeStr = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
            
            document.getElementById('dateText').textContent = dateStr;
            document.getElementById('timeText').textContent = timeStr;
        }

        // Location capture - REAL GEOLOCATION
        function captureLocation() {
            if (!navigator.geolocation) {
                showLocationError('Geolocation is not supported by your browser. Please try a different browser.');
                return;
            }
            
            document.getElementById('locStatus').textContent = 'Capturing...';
            document.getElementById('locStatus').classList.add('text-warning');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    handleLocationSuccess(position);
                },
                (error) => {
                    handleLocationError(error);
                },
                { 
                    enableHighAccuracy: true, 
                    timeout: 15000, 
                    maximumAge: 0 
                }
            );
        }

        function handleLocationSuccess(position) {
            appState.location = {
                lat: position.coords.latitude,
                lon: position.coords.longitude,
                accuracy: position.coords.accuracy,
                timestamp: new Date(position.timestamp).toLocaleString(),
                isReal: true
            };
            
            document.getElementById('locStatus').textContent = 'Captured ✓';
            document.getElementById('locStatus').classList.remove('text-warning');
            document.getElementById('locStatus').classList.add('text-success');
            document.getElementById('latText').textContent = appState.location.lat.toFixed(6) + '°';
            document.getElementById('lonText').textContent = appState.location.lon.toFixed(6) + '°';
            document.getElementById('locError').classList.add('hidden');
            
            // Update checklist
            document.getElementById('checkLoc').textContent = '✓';
            document.getElementById('checkLoc').classList.remove('bg-slate-100', 'text-slate-700');
            document.getElementById('checkLoc').classList.add('bg-emerald-100', 'text-emerald-600');
            
            checkFormReady();
        }

        function handleLocationError(error) {
            let errorMessage = 'Unable to capture location. ';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += 'Location permission was denied. Please enable location access in your browser settings.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += 'Location information is unavailable. Please check your GPS/WiFi connection.';
                    break;
                case error.TIMEOUT:
                    errorMessage += 'Location request timed out. Please try again.';
                    break;
                default:
                    errorMessage += 'An unknown error occurred.';
            }
            
            showLocationError(errorMessage);
        }

        function showLocationError(message) {
            document.getElementById('locStatus').textContent = 'Failed';
            document.getElementById('locStatus').classList.add('text-danger');
            document.getElementById('locError').innerHTML = message;
            document.getElementById('locError').classList.remove('hidden');
        }

        // Camera functions - REAL CAMERA
        async function startCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                document.getElementById('camError').textContent = 'Camera API is not supported in this browser. Try Chrome, Firefox, or Edge.';
                document.getElementById('camError').classList.remove('hidden');
                return;
            }
            
            try {
                const constraints = {
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    },
                    audio: false
                };
                
                appState.stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('video');
                video.srcObject = appState.stream;
                appState.isCameraActive = true;
                
                video.onloadedmetadata = () => {
                    video.play();
                    document.getElementById('btnCaptureFace').disabled = false;
                    document.getElementById('camError').classList.add('hidden');
                    document.getElementById('camHint').textContent = 'Camera active. Position your face in the frame and click Capture.';
                };
                
            } catch (err) {
                console.error('Camera error:', err);
                let errorMessage = 'Camera error: ';
                
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    errorMessage += 'Camera permission was denied. Please allow camera access in your browser settings.';
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                    errorMessage += 'No camera found on this device.';
                } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                    errorMessage += 'Camera is already in use by another application.';
                } else {
                    errorMessage += err.message;
                }
                
                document.getElementById('camError').innerHTML = errorMessage;
                document.getElementById('camError').classList.remove('hidden');
                document.getElementById('camHint').textContent = 'Unable to access camera.';
            }
        }

        function stopCamera() {
            if (appState.stream) {
                appState.stream.getTracks().forEach(track => {
                    track.stop();
                });
                appState.stream = null;
                appState.isCameraActive = false;
                
                const video = document.getElementById('video');
                video.srcObject = null;
                document.getElementById('btnCaptureFace').disabled = true;
                document.getElementById('camHint').textContent = 'Camera stopped. Click "Start Camera" to begin.';
            }
        }

        function captureFace() {
            if (!appState.isCameraActive || !appState.stream) {
                alert('Please start the camera first.');
                return;
            }
            
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            appState.faceImage = canvas.toDataURL('image/jpeg', 0.85);
            
            const preview = document.getElementById('facePreview');
            preview.src = appState.faceImage;
            preview.classList.remove('hidden');
            document.getElementById('faceEmpty').classList.add('hidden');
            
            document.getElementById('faceStatus').textContent = 'Captured ✓';
            document.getElementById('faceStatus').classList.add('text-success');
            
            const imageSizeKB = Math.round(appState.faceImage.length * 0.75 / 1024);
            const qualityText = imageSizeKB > 100 ? 'Good' : (imageSizeKB > 50 ? 'Fair' : 'Low');
            document.getElementById('faceQuality').textContent = `${qualityText} (${imageSizeKB} KB)`;
            document.getElementById('faceQuality').classList.add('text-success');
            
            document.getElementById('btnRetake').disabled = false;
            
            document.getElementById('checkFace').textContent = '✓';
            document.getElementById('checkFace').classList.remove('bg-slate-100', 'text-slate-700');
            document.getElementById('checkFace').classList.add('bg-emerald-100', 'text-emerald-600');
            
            unlockForm();
            
            stopCamera();
            document.getElementById('camHint').textContent = 'Face captured successfully! Click "Start Camera" to retake.';
        }

        function retakeFace() {
            appState.faceImage = null;
            document.getElementById('facePreview').classList.add('hidden');
            document.getElementById('faceEmpty').classList.remove('hidden');
            document.getElementById('faceStatus').textContent = 'Not captured';
            document.getElementById('faceStatus').classList.remove('text-success');
            document.getElementById('faceQuality').textContent = '—';
            document.getElementById('faceQuality').classList.remove('text-success');
            document.getElementById('btnRetake').disabled = true;
            document.getElementById('checkFace').textContent = '—';
            document.getElementById('checkFace').classList.remove('bg-emerald-100', 'text-emerald-600');
            document.getElementById('checkFace').classList.add('bg-slate-100', 'text-slate-700');
            
            lockForm();
            
            startCamera();
        }

        // Form functions
        function unlockForm() {
            appState.isFormUnlocked = true;
            document.getElementById('formFieldset').disabled = false;
            document.getElementById('formFieldset').classList.remove('opacity-60');
            document.getElementById('formLockedNote').classList.add('hidden');
            document.getElementById('verifyText').textContent = 'Ready ✓';
            document.getElementById('verifyText').classList.add('text-success');
            
            setTimeout(() => {
                document.getElementById('courseCode').focus();
            }, 100);
        }

        function lockForm() {
            appState.isFormUnlocked = false;
            document.getElementById('formFieldset').disabled = true;
            document.getElementById('formFieldset').classList.add('opacity-60');
            document.getElementById('formLockedNote').classList.remove('hidden');
            document.getElementById('verifyText').textContent = 'Pending';
            document.getElementById('verifyText').classList.remove('text-success');
            document.getElementById('btnSubmit').disabled = true;
        }

        function checkFormReady() {
            const form = document.getElementById('attendanceForm');
            const isFormValid = form.checkValidity();
            const hasLocation = appState.location !== null;
            const hasFace = appState.faceImage !== null;
            
            document.getElementById('checkFields').textContent = isFormValid ? '✓' : '—';
            if (isFormValid) {
                document.getElementById('checkFields').classList.remove('bg-slate-100', 'text-slate-700');
                document.getElementById('checkFields').classList.add('bg-emerald-100', 'text-emerald-600');
            } else {
                document.getElementById('checkFields').classList.remove('bg-emerald-100', 'text-emerald-600');
                document.getElementById('checkFields').classList.add('bg-slate-100', 'text-slate-700');
            }
            
            if (appState.isFormUnlocked && isFormValid && hasLocation && hasFace) {
                document.getElementById('btnSubmit').disabled = false;
            } else {
                document.getElementById('btnSubmit').disabled = true;
            }
        }

        function initializeFormValidation() {
            const form = document.getElementById('attendanceForm');
            const inputs = form.querySelectorAll('input[required]');
            
            inputs.forEach(input => {
                input.addEventListener('input', checkFormReady);
                input.addEventListener('change', checkFormReady);
                
                input.addEventListener('blur', function() {
                    if (this.value.trim() === '') {
                        this.classList.add('border-red-300', 'dark:border-red-700');
                    } else {
                        this.classList.remove('border-red-300', 'dark:border-red-700');
                    }
                });
            });
            
            // Add matric number validation - only check if field is not empty
            const matricInput = document.getElementById('matricNo');
            matricInput.addEventListener('input', function() {
                // Remove any previous validation classes
                this.classList.remove('border-red-300', 'dark:border-red-700', 'border-green-300', 'dark:border-green-700');
                
                // Only validate if there's content
                if (this.value.trim() !== '') {
                    // Accept any format - no validation needed
                    this.classList.add('border-green-300', 'dark:border-green-700');
                }
            });
        }

        // Form submission
        document.getElementById('attendanceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!appState.isFormUnlocked || !appState.location || !appState.faceImage) {
                alert('Please complete all steps before submitting.');
                return;
            }
            
            if (!this.checkValidity()) {
                alert('Please fill in all required fields correctly.');
                return;
            }
            
            // Get matric value without any format restrictions
            const matricValue = document.getElementById('matricNo').value.trim();
            
            const attendanceData = {
                name: document.getElementById('studentName').value.trim(),
                matric: matricValue, // Accept any format
                course: document.getElementById('courseCode').value.trim().toUpperCase(),
                date: document.getElementById('dateText').textContent,
                time: document.getElementById('timeText').textContent,
                location: appState.location,
                faceImage: appState.faceImage,
                timestamp: new Date().toISOString(),
                deviceInfo: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language
                },
                studentId: appState.currentStudent?.id || null
            };
            
            saveAttendanceToLocal(attendanceData);
            
            document.getElementById('successModal').classList.remove('hidden');
            
            console.log('Attendance submitted:', {
                name: attendanceData.name,
                matric: attendanceData.matric, // Any format accepted
                course: attendanceData.course,
                location: attendanceData.location,
                imageSize: Math.round(attendanceData.faceImage.length * 0.75 / 1024) + ' KB'
            });
            
            resetStudentForm();
        });

        function saveAttendanceToLocal(data) {
            try {
                const records = JSON.parse(localStorage.getItem('nsukAttendanceRecords') || '[]');
                
                data.id = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                records.push(data);
                
                const limitedRecords = records.slice(-100);
                localStorage.setItem('nsukAttendanceRecords', JSON.stringify(limitedRecords));
                
                sessionStorage.setItem('lastAttendance', JSON.stringify(data));
                
                updateAttendanceCount();
                
            } catch (error) {
                console.error('Error saving attendance:', error);
                alert('Error saving attendance. Please try again.');
            }
        }

        function updateAttendanceCount() {
            try {
                const records = JSON.parse(localStorage.getItem('nsukAttendanceRecords') || '[]');
                const today = new Date().toDateString();
                const todayRecords = records.filter(record => {
                    const recordDate = new Date(record.timestamp).toDateString();
                    return recordDate === today;
                });
                
                const todayElement = document.querySelector('#dashboardContent .text-emerald-600');
                if (todayElement) {
                    todayElement.textContent = todayRecords.length;
                }
                
                // Update lecturer dashboard if unlocked
                if (appState.lecturerUnlocked) {
                    updateLecturerDashboard();
                }
            } catch (error) {
                console.error('Error updating attendance count:', error);
            }
        }

        function resetStudentForm() {
            document.getElementById('attendanceForm').reset();
            
            // Restore student info if logged in
            if (appState.currentStudent) {
                document.getElementById('studentName').value = appState.currentStudent.name;
                document.getElementById('matricNo').value = appState.currentStudent.matric;
            }
            
            appState.location = null;
            document.getElementById('locStatus').textContent = 'Not captured';
            document.getElementById('locStatus').classList.remove('text-warning', 'text-success', 'text-danger');
            document.getElementById('latText').textContent = '—';
            document.getElementById('lonText').textContent = '—';
            document.getElementById('locError').classList.add('hidden');
            
            retakeFace();
            stopCamera();
            document.getElementById('video').srcObject = null;
            document.getElementById('camHint').textContent = 'Tip: Ensure your face is well-lit and centered.';
            document.getElementById('camError').classList.add('hidden');
            document.getElementById('btnCaptureFace').disabled = true;
            
            ['checkLoc', 'checkFace', 'checkFields'].forEach(id => {
                document.getElementById(id).textContent = '—';
                document.getElementById(id).classList.remove('bg-emerald-100', 'text-emerald-600');
                document.getElementById(id).classList.add('bg-slate-100', 'text-slate-700');
            });
            
            lockForm();
            
            updateDateTime();
        }

        // Lecturer dashboard functions
        function togglePinVisibility() {
            const pinInput = document.getElementById('pinInput');
            const icon = document.getElementById('pinToggleIcon');
            
            if (pinInput.type === 'password') {
                pinInput.type = 'text';
                icon.textContent = 'visibility';
            } else {
                pinInput.type = 'password';
                icon.textContent = 'visibility_off';
            }
        }

        function verifyLecturerPin() {
            const pin = document.getElementById('pinInput').value;
            const errorDiv = document.getElementById('pinError');
            const successDiv = document.getElementById('pinSuccess');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            if (pin.length !== 6) {
                errorDiv.textContent = 'PIN must be 6 digits';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Use the PIN validation system
            const result = BACKEND_SIMULATION.validatePin(pin);
            
            if (result.success) {
                successDiv.textContent = 'Access granted! Loading dashboard...';
                successDiv.classList.remove('hidden');
                
                // Store lecturer session
                appState.lecturerUnlocked = true;
                sessionStorage.setItem('nsukLecturerSession', 'true');
                
                setTimeout(() => {
                    unlockLecturerDashboard();
                    updateLecturerDashboard();
                }, 1000);
            } else {
                errorDiv.textContent = result.error || 'Invalid PIN. Please try again.';
                errorDiv.classList.remove('hidden');
            }
        }

        function unlockLecturerDashboard() {
            document.getElementById('dashboardContent').classList.remove('hidden');
            document.getElementById('attendanceDashboard').classList.remove('hidden');
            document.getElementById('classManagement').classList.remove('hidden');
            document.getElementById('quickActions').classList.remove('hidden');
        }

        function lockLecturerDashboard() {
            appState.lecturerUnlocked = false;
            sessionStorage.removeItem('nsukLecturerSession');
            document.getElementById('pinInput').value = '';
            document.getElementById('dashboardContent').classList.add('hidden');
            document.getElementById('attendanceDashboard').classList.add('hidden');
            document.getElementById('classManagement').classList.add('hidden');
            document.getElementById('quickActions').classList.add('hidden');
            document.getElementById('pinSuccess').classList.add('hidden');
            document.getElementById('pinError').classList.add('hidden');
            showToast('Dashboard locked', 'PIN required for access.');
        }

        function updateLecturerDashboard() {
            const records = JSON.parse(localStorage.getItem('nsukAttendanceRecords') || '[]');
            const today = new Date().toDateString();
            const todayRecords = records.filter(record => {
                const recordDate = new Date(record.timestamp).toDateString();
                return recordDate === today;
            });
            
            // Update statistics
            document.getElementById('totalStudents').textContent = '30'; // Sample data
            document.getElementById('presentStudents').textContent = todayRecords.length;
            document.getElementById('absentStudents').textContent = Math.max(0, 30 - todayRecords.length);
            
            // Update attendance dashboard
            document.getElementById('statTotal').textContent = records.length;
            if (records.length > 0) {
                const recent = records[0];
                document.getElementById('statRecent').textContent = `${recent.date} ${recent.time}`;
            } else {
                document.getElementById('statRecent').textContent = '—';
            }
            
            // Render attendance table
            renderAttendanceTable();
        }

        function renderAttendanceTable() {
            const tbody = document.getElementById('recordsTbody');
            const empty = document.getElementById('emptyAdmin');
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            
            const records = JSON.parse(localStorage.getItem('nsukAttendanceRecords') || '[]');
            const filtered = searchTerm ? records.filter(r => 
                r.name.toLowerCase().includes(searchTerm) ||
                r.matric.toLowerCase().includes(searchTerm) ||
                r.course.toLowerCase().includes(searchTerm)
            ) : records;
            
            tbody.innerHTML = '';
            
            if (filtered.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            filtered.forEach(record => {
                const tr = document.createElement('tr');
                tr.className = 'align-top';
                
                tr.innerHTML = `
                    <td class="px-4 py-3 font-semibold text-slate-900 dark:text-white">${escapeHtml(record.name)}</td>
                    <td class="px-4 py-3 text-slate-700 dark:text-slate-300">${escapeHtml(record.matric)}</td>
                    <td class="px-4 py-3 text-slate-700 dark:text-slate-300">${escapeHtml(record.course)}</td>
                    <td class="px-4 py-3 text-slate-700 dark:text-slate-300 whitespace-nowrap">${escapeHtml(record.date)} ${escapeHtml(record.time)}</td>
                    <td class="px-4 py-3 text-slate-700 dark:text-slate-300 tabular-nums whitespace-nowrap">${record.location?.lat?.toFixed(6) || '—'}</td>
                    <td class="px-4 py-3 text-slate-700 dark:text-slate-300 tabular-nums whitespace-nowrap">${record.location?.lon?.toFixed(6) || '—'}</td>
                    <td class="px-4 py-3">
                        <button onclick="viewFaceImage('${record.id}')" class="rounded-lg bg-white dark:bg-slate-700 px-3 py-1.5 text-xs font-semibold text-slate-800 dark:text-white ring-1 ring-slate-200 dark:ring-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600">
                            View
                        </button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        function viewFaceImage(recordId) {
            const records = JSON.parse(localStorage.getItem('nsukAttendanceRecords') || '[]');
            const record = records.find(r => r.id === recordId);
            
            if (record && record.faceImage) {
                document.getElementById('faceModalTitle').textContent = `${record.name} (${record.matric})`;
                document.getElementById('faceModalImage').src = record.faceImage;
                document.getElementById('faceModalDetails').textContent = `Course: ${record.course} | Date: ${record.date} ${record.time}`;
                document.getElementById('faceImageModal').classList.remove('hidden');
            }
        }

        function closeFaceImageModal() {
            document.getElementById('faceImageModal').classList.add('hidden');
        }

        function downloadAttendancePDF() {
            const records = JSON.parse(localStorage.getItem('nsukAttendanceRecords') || '[]');
            
            if (records.length === 0) {
                showToast('No records', 'There are no attendance records to export.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 40;
            
            // Header
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text('Department of Urban and Regional Planning', margin, 50);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            doc.text('Nasarawa State University, Keffi (NSUK)', margin, 68);
            
            doc.setFontSize(10);
            const generated = `${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`;
            doc.text(`Attendance Report • Generated: ${generated}`, margin, 86);
            
            // Table data
            const head = [['Name', 'Matric No.', 'Course Code', 'Date', 'Time', 'Latitude', 'Longitude']];
            const body = records.map(r => [
                String(r.name || ''),
                String(r.matric || ''),
                String(r.course || ''),
                String(r.date || ''),
                String(r.time || ''),
                (typeof r.location?.lat === 'number') ? r.location.lat.toFixed(6) : '',
                (typeof r.location?.lon === 'number') ? r.location.lon.toFixed(6) : '',
            ]);
            
            doc.autoTable({
                head,
                body,
                startY: 110,
                styles: { font: 'helvetica', fontSize: 9, cellPadding: 4, overflow: 'linebreak' },
                headStyles: { fillColor: [15, 27, 61], textColor: [255, 255, 255] },
                alternateRowStyles: { fillColor: [245, 247, 250] },
                margin: { left: margin, right: margin },
                tableWidth: pageWidth - margin * 2,
            });
            
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text('Note: Face images are stored locally and not included in PDF export.', margin, doc.lastAutoTable.finalY + 18);
            
            const fileName = `NSUK_URP_Attendance_${new Date().toISOString().slice(0,10)}.pdf`;
            doc.save(fileName);
            showToast('PDF downloaded', fileName);
        }

        function clearAttendanceRecords() {
            const records = JSON.parse(localStorage.getItem('nsukAttendanceRecords') || '[]');
            if (records.length === 0) {
                showToast('Nothing to clear', 'No records found.');
                return;
            }
            
            const ok = confirm(`This will permanently remove ${records.length} attendance record(s) from this browser. Continue?`);
            if (!ok) return;
            
            localStorage.removeItem('nsukAttendanceRecords');
            updateLecturerDashboard();
            showToast('Records cleared', 'Local storage attendance data removed.');
        }

        function generateNewLecturerPin() {
            alert('PIN request submitted. An administrator will review your request and provide a new PIN.');
        }

        // Class Management Functions
        function createNewSession() {
            document.getElementById('createSessionModal').classList.remove('hidden');
        }

        function closeCreateSessionModal() {
            document.getElementById('createSessionModal').classList.add('hidden');
        }

        function startNewSession() {
            const course = document.getElementById('sessionCourse').value.trim();
            const topic = document.getElementById('sessionTopic').value.trim();
            const duration = document.getElementById('sessionDuration').value;
            
            if (!course) {
                alert('Please enter a course code.');
                return;
            }
            
            // Generate session code
            const sessionCode = course.replace(/\s+/g, '').toUpperCase().substring(0, 3) + 
                              Math.floor(100 + Math.random() * 900);
            
            const session = {
                id: 'sess_' + Date.now(),
                course: course,
                topic: topic || 'General Lecture',
                code: sessionCode,
                date: new Date().toISOString(),
                duration: parseInt(duration) || 60,
                attendanceCount: 0,
                totalStudents: 30 // Sample data
            };
            
            // Save session
            appState.sessions.unshift(session);
            localStorage.setItem('nsukAttendanceSessions', JSON.stringify(appState.sessions));
            
            // Update UI
            document.getElementById('sessionCode').textContent = sessionCode;
            document.getElementById('sessionCourseName').textContent = course;
            document.getElementById('sessionTopicName').textContent = topic || 'General Lecture';
            
            // Show success modal
            document.getElementById('createSessionModal').classList.add('hidden');
            document.getElementById('sessionCreatedModal').classList.remove('hidden');
            
            showToast('Session created', `Session code: ${sessionCode}`);
        }

        function copySessionCode() {
            const sessionCode = document.getElementById('sessionCode').textContent;
            navigator.clipboard.writeText(sessionCode).then(() => {
                showToast('Code copied', 'Session code copied to clipboard!');
            }).catch(err => {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = sessionCode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Code copied', 'Session code copied to clipboard!');
            });
        }

        function closeSessionCreatedModal() {
            document.getElementById('sessionCreatedModal').classList.add('hidden');
        }

        function viewPastSessions() {
            loadPastSessions();
            document.getElementById('pastSessionsModal').classList.remove('hidden');
        }

        function loadPastSessions() {
            const sessionsList = document.getElementById('pastSessionsList');
            sessionsList.innerHTML = '';
            
            if (appState.sessions.length === 0) {
                sessionsList.innerHTML = `
                    <div class="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-4 text-center">
                        <p class="text-sm text-slate-600 dark:text-slate-400">No past sessions found.</p>
                    </div>
                `;
                return;
            }
            
            appState.sessions.forEach(session => {
                const sessionDate = new Date(session.date);
                const dateStr = sessionDate.toLocaleDateString('en-US', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                const timeStr = sessionDate.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 p-4';
                sessionDiv.innerHTML = `
                    <div class="flex items-start justify-between gap-3">
                        <div>
                            <h4 class="text-sm font-semibold text-slate-900 dark:text-white">${escapeHtml(session.course)}</h4>
                            <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">${escapeHtml(session.topic)}</p>
                            <div class="mt-2 flex items-center gap-4 text-xs text-slate-500 dark:text-slate-400">
                                <span>${dateStr} ${timeStr}</span>
                                <span>•</span>
                                <span>Code: ${escapeHtml(session.code)}</span>
                                <span>•</span>
                                <span>${session.attendanceCount}/${session.totalStudents} students</span>
                            </div>
                        </div>
                        <button onclick="downloadSessionPDF('${session.id}')" class="rounded-lg bg-primary px-3 py-1.5 text-xs font-semibold text-white hover:bg-primary-hover">
                            PDF
                        </button>
                    </div>
                `;
                
                sessionsList.appendChild(sessionDiv);
            });
        }

        function closePastSessionsModal() {
            document.getElementById('pastSessionsModal').classList.add('hidden');
        }

        function downloadSessionPDF(sessionId) {
            const session = appState.sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 40;
            
            // Header
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text('Department of Urban and Regional Planning', margin, 50);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            doc.text('Nasarawa State University, Keffi (NSUK)', margin, 68);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(`Attendance Session: ${session.course}`, margin, 90);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Topic: ${session.topic}`, margin, 110);
            doc.text(`Session Code: ${session.code}`, margin, 125);
            doc.text(`Date: ${new Date(session.date).toLocaleDateString()}`, margin, 140);
            doc.text(`Duration: ${session.duration} minutes`, margin, 155);
            doc.text(`Attendance: ${session.attendanceCount}/${session.totalStudents} students`, margin, 170);
            
            // Add a simple table for attendance (sample data)
            const head = [['Name', 'Matric No.', 'Time']];
            const body = [
                ['Sample Student 1', 'NSUK/URP/2023/001', '09:00 AM'],
                ['Sample Student 2', 'NSUK/URP/2023/002', '09:05 AM'],
                ['Sample Student 3', 'NSUK/URP/2023/003', '09:10 AM']
            ];
            
            doc.autoTable({
                head,
                body,
                startY: 190,
                styles: { font: 'helvetica', fontSize: 9, cellPadding: 4 },
                headStyles: { fillColor: [15, 27, 61], textColor: [255, 255, 255] },
                margin: { left: margin, right: margin },
                tableWidth: pageWidth - margin * 2,
            });
            
            const fileName = `NSUK_URP_Session_${session.code}_${new Date(session.date).toISOString().slice(0,10)}.pdf`;
            doc.save(fileName);
            showToast('PDF downloaded', fileName);
        }

        function downloadAllSessionsPDF() {
            if (appState.sessions.length === 0) {
                showToast('No sessions', 'There are no sessions to export.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 40;
            
            // Header
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text('Department of Urban and Regional Planning', margin, 50);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            doc.text('Nasarawa State University, Keffi (NSUK)', margin, 68);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('All Attendance Sessions Report', margin, 90);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, margin, 110);
            doc.text(`Total Sessions: ${appState.sessions.length}`, margin, 125);
            
            // Sessions table
            const head = [['Course', 'Topic', 'Session Code', 'Date', 'Attendance']];
            const body = appState.sessions.map(s => [
                s.course,
                s.topic,
                s.code,
                new Date(s.date).toLocaleDateString(),
                `${s.attendanceCount}/${s.totalStudents}`
            ]);
            
            doc.autoTable({
                head,
                body,
                startY: 140,
                styles: { font: 'helvetica', fontSize: 9, cellPadding: 4 },
                headStyles: { fillColor: [15, 27, 61], textColor: [255, 255, 255] },
                alternateRowStyles: { fillColor: [245, 247, 250] },
                margin: { left: margin, right: margin },
                tableWidth: pageWidth - margin * 2,
            });
            
            const fileName = `NSUK_URP_All_Sessions_${new Date().toISOString().slice(0,10)}.pdf`;
            doc.save(fileName);
            showToast('PDF downloaded', fileName);
        }

        function downloadTodaySessionsPDF() {
            const today = new Date().toDateString();
            const todaySessions = appState.sessions.filter(s => 
                new Date(s.date).toDateString() === today
            );
            
            if (todaySessions.length === 0) {
                showToast('No sessions today', 'There are no sessions for today.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 40;
            
            // Header
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text('Department of Urban and Regional Planning', margin, 50);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            doc.text('Nasarawa State University, Keffi (NSUK)', margin, 68);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(`Today's Attendance Sessions (${today})`, margin, 90);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Generated: ${new Date().toLocaleTimeString()}`, margin, 110);
            doc.text(`Total Sessions Today: ${todaySessions.length}`, margin, 125);
            
            // Sessions table
            const head = [['Course', 'Topic', 'Session Code', 'Time', 'Attendance']];
            const body = todaySessions.map(s => [
                s.course,
                s.topic,
                s.code,
                new Date(s.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                `${s.attendanceCount}/${s.totalStudents}`
            ]);
            
            doc.autoTable({
                head,
                body,
                startY: 140,
                styles: { font: 'helvetica', fontSize: 9, cellPadding: 4 },
                headStyles: { fillColor: [15, 27, 61], textColor: [255, 255, 255] },
                alternateRowStyles: { fillColor: [245, 247, 250] },
                margin: { left: margin, right: margin },
                tableWidth: pageWidth - margin * 2,
            });
            
            const fileName = `NSUK_URP_Today_Sessions_${new Date().toISOString().slice(0,10)}.pdf`;
            doc.save(fileName);
            showToast('PDF downloaded', fileName);
        }

        function manageStudents() {
            const students = JSON.parse(localStorage.getItem('nsukStudentAccounts') || '[]');
            if (students.length === 0) {
                alert('No student accounts found.');
                return;
            }
            
            let message = 'Student Accounts:\n\n';
            students.forEach((student, index) => {
                message += `${index + 1}. ${student.name}\n`;
                message += `   Matric: ${student.matric}\n`;
                message += `   Email: ${student.email}\n`;
                message += `   Created: ${new Date(student.createdAt).toLocaleDateString()}\n\n`;
            });
            
            message += `Total Students: ${students.length}`;
            alert(message);
        }

        function exportAttendanceCSV() {
            const records = JSON.parse(localStorage.getItem('nsukAttendanceRecords') || '[]');
            if (records.length === 0) {
                showToast('No data to export', 'No attendance records found.');
                return;
            }
            
            let csv = 'Name,Matric Number,Course Code,Date,Time,Latitude,Longitude\n';
            records.forEach(record => {
                csv += `"${record.name}","${record.matric}","${record.course}","${record.date}","${record.time}",${record.location?.lat || ''},${record.location?.lon || ''}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast('CSV exported', `${records.length} records downloaded.`);
        }

        function generateAttendanceReport() {
            const records = JSON.parse(localStorage.getItem('nsukAttendanceRecords') || '[]');
            if (records.length === 0) {
                showToast('No data', 'No attendance data for report.');
                return;
            }
            
            const courses = {};
            records.forEach(record => {
                if (!courses[record.course]) {
                    courses[record.course] = [];
                }
                courses[record.course].push(record);
            });
            
            let report = `Attendance Report - ${new Date().toLocaleDateString()}\n\n`;
            report += `Total Records: ${records.length}\n\n`;
            
            for (const [course, courseRecords] of Object.entries(courses)) {
                report += `${course}: ${courseRecords.length} students\n`;
            }
            
            alert(report);
        }

        // Helper function
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(title, sub = '') {
            // Simple toast implementation
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50 rounded-2xl bg-slate-900 text-white px-4 py-3 shadow-lg ring-1 ring-white/10';
            toast.innerHTML = `
                <p class="text-sm font-semibold">${title}</p>
                <p class="text-xs text-white/80 mt-0.5">${sub}</p>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Admin functions - UPDATED FOR SINGLE USER & MULTI-DEVICE SUPPORT
        function togglePasswordVisibility(inputId, iconId) {
            const passwordInput = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.textContent = 'visibility';
            } else {
                passwordInput.type = 'password';
                icon.textContent = 'visibility_off';
            }
        }

        // Admin login - Single user, multi-device support
        async function adminLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('adminError');
            const successDiv = document.getElementById('adminSuccess');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            if (!username || !password) {
                errorDiv.textContent = 'Please enter both username and password.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Signing in...';
            submitBtn.disabled = true;
            
            try {
                // Use simulated backend API
                const result = await BACKEND_SIMULATION.call('/auth/login', 'POST', {
                    username: username,
                    password: password
                });
                
                if (result.success) {
                    successDiv.textContent = 'Login successful! Redirecting to dashboard...';
                    successDiv.classList.remove('hidden');
                    
                    // Store current admin session
                    appState.currentAdmin = result.admin;
                    
                    // Remember me functionality
                    const rememberMe = document.getElementById('rememberMe').checked;
                    if (rememberMe) {
                        localStorage.setItem('nsukAdminRemember', username);
                    } else {
                        localStorage.removeItem('nsukAdminRemember');
                    }
                    
                    // Redirect to admin dashboard
                    setTimeout(() => {
                        showScreen('admin-dashboard');
                        document.getElementById('adminWelcomeName').textContent = result.admin.name;
                        updateAdminDashboard();
                    }, 1000);
                } else {
                    errorDiv.textContent = result.error || 'Invalid username or password.';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Network error. Please check your connection and try again.';
                errorDiv.classList.remove('hidden');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // Admin signup - Multi-device support (but only one admin can be created)
        async function adminSignup(event) {
            event.preventDefault();
            
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const username = document.getElementById('signupUsername').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const termsAgreed = document.getElementById('termsAgreement').checked;
            
            const errorDiv = document.getElementById('adminError');
            const successDiv = document.getElementById('adminSuccess');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Validation
            if (!name || !email || !username || !password || !confirmPassword) {
                errorDiv.textContent = 'Please fill in all fields.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (password.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters long.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (password !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (!termsAgreed) {
                errorDiv.textContent = 'Please agree to the Terms of Service and Privacy Policy.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Check if there's already an admin account (single user restriction)
            const existingAdmins = JSON.parse(localStorage.getItem('nsukAdminAccounts') || '[]');
            if (existingAdmins.length > 0) {
                errorDiv.textContent = 'Only one administrator account is allowed. Please login with the existing admin credentials.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Creating account...';
            submitBtn.disabled = true;
            
            try {
                // Use simulated backend API
                const result = await BACKEND_SIMULATION.call('/auth/signup', 'POST', {
                    name: name,
                    email: email,
                    username: username,
                    password: password
                });
                
                if (result.success) {
                    successDiv.textContent = 'Admin account created successfully! This is the only admin account allowed. Redirecting to dashboard...';
                    successDiv.classList.remove('hidden');
                    
                    // Store current admin session
                    appState.currentAdmin = result.admin;
                    
                    // Clear form
                    document.getElementById('adminSignupForm').reset();
                    
                    // Redirect to admin dashboard
                    setTimeout(() => {
                        showScreen('admin-dashboard');
                        document.getElementById('adminWelcomeName').textContent = result.admin.name;
                        updateAdminDashboard();
                    }, 1500);
                } else {
                    errorDiv.textContent = result.error || 'Account creation failed. Please try again.';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Network error. Please check your connection and try again.';
                errorDiv.classList.remove('hidden');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        function showAdminTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const signupTab = document.getElementById('signupTab');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const errorDiv = document.getElementById('adminError');
            const successDiv = document.getElementById('adminSuccess');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Check if admin already exists
            const existingAdmins = JSON.parse(localStorage.getItem('nsukAdminAccounts') || '[]');
            
            if (tab === 'login') {
                loginTab.classList.add('text-primary', 'border-primary');
                loginTab.classList.remove('text-slate-600', 'border-transparent');
                signupTab.classList.remove('text-primary', 'border-primary');
                signupTab.classList.add('text-slate-600', 'border-transparent');
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
            } else {
                // If admin already exists, show message and switch to login
                if (existingAdmins.length > 0) {
                    errorDiv.textContent = 'Only one administrator account is allowed. Please login with the existing admin credentials.';
                    errorDiv.classList.remove('hidden');
                    showAdminTab('login');
                    return;
                }
                
                signupTab.classList.add('text-primary', 'border-primary');
                signupTab.classList.remove('text-slate-600', 'border-transparent');
                loginTab.classList.remove('text-primary', 'border-primary');
                loginTab.classList.add('text-slate-600', 'border-transparent');
                signupForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }

        function forgotPassword() {
            const admins = JSON.parse(localStorage.getItem('nsukAdminAccounts') || '[]');
            if (admins.length > 0) {
                const admin = admins[0]; // Get the single admin
                let message = 'Single Admin System\n\n';
                message += 'Only one administrator account exists for this system.\n\n';
                message += 'Admin Details:\n';
                message += `Name: ${admin.name}\n`;
                message += `Username: ${admin.username}\n`;
                message += `Email: ${admin.email}\n\n`;
                message += 'If you forgot your password:\n';
                message += '1. Use the same credentials on any device\n';
                message += '2. The account works across all devices\n';
                message += '3. Contact technical support if needed\n\n';
                message += 'Default credentials (if not changed):\n';
                message += 'Username: admin\n';
                message += 'Password: Admin@123';
                alert(message);
            } else {
                alert('No admin account found. Please create a new account.');
            }
        }

        // Admin dashboard functions
        function updateAdminDashboard() {
            const admins = JSON.parse(localStorage.getItem('nsukAdminAccounts') || '[]');
            const records = JSON.parse(localStorage.getItem('nsukAttendanceRecords') || '[]');
            const pins = JSON.parse(localStorage.getItem('nsukLecturerPins') || '[]');
            const students = JSON.parse(localStorage.getItem('nsukStudentAccounts') || '[]');
            
            // Count active PINs
            const now = new Date();
            const activePins = pins.filter(pin => {
                return pin.isActive && new Date(pin.expiry) > now;
            });
            
            // Count PIN usage today
            const today = new Date().toDateString();
            const pinUsageToday = pins.reduce((count, pin) => {
                if (pin.lastUsed) {
                    const lastUsedDate = new Date(pin.lastUsed).toDateString();
                    if (lastUsedDate === today) {
                        return count + (pin.usageCount || 0);
                    }
                }
                return count;
            }, 0);
            
            document.getElementById('totalAdmins').textContent = admins.length;
            document.getElementById('totalRecords').textContent = records.length;
            document.getElementById('totalPins').textContent = activePins.length;
            document.getElementById('pinUsage').textContent = pinUsageToday;
        }

        // Generate lecturer PIN
        async function generateLecturerPin() {
            const lecturerName = document.getElementById('lecturerName').value.trim();
            const lecturerEmail = document.getElementById('lecturerEmail').value.trim();
            const expiry = document.getElementById('pinExpiry').value;
            const autoGenerate = document.getElementById('autoGenerate').checked;
            const customPin = document.getElementById('customPin').value;
            
            const errorDiv = document.getElementById('pinGenerationError');
            const successDiv = document.getElementById('pinGenerationSuccess');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            if (!lecturerName) {
                errorDiv.textContent = 'Please enter lecturer name.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (!autoGenerate && (!customPin || customPin.length !== 6 || !/^\d+$/.test(customPin))) {
                errorDiv.textContent = 'Please enter a valid 6-digit custom PIN.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            try {
                const result = await BACKEND_SIMULATION.call('/pins/generate', 'POST', {
                    lecturerName: lecturerName,
                    lecturerEmail: lecturerEmail,
                    expiry: expiry,
                    autoGenerate: autoGenerate,
                    customPin: customPin
                });
                
                if (result.success) {
                    // Show success message
                    successDiv.textContent = 'PIN generated successfully!';
                    successDiv.classList.remove('hidden');
                    
                    // Show PIN modal
                    appState.generatedPin = result.pin;
                    showPinModal(result.pin);
                    
                    // Clear form
                    document.getElementById('lecturerName').value = '';
                    document.getElementById('lecturerEmail').value = '';
                    document.getElementById('customPin').value = '';
                    
                    // Update dashboard stats
                    updateAdminDashboard();
                } else {
                    errorDiv.textContent = result.error || 'Failed to generate PIN.';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Error generating PIN. Please try again.';
                errorDiv.classList.remove('hidden');
            }
        }

        // Show PIN modal
        function showPinModal(pinData) {
            document.getElementById('generatedPin').textContent = pinData.pin;
            document.getElementById('pinLecturerName').textContent = pinData.lecturerName;
            
            const expiryDate = new Date(pinData.expiry).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('pinExpiryInfo').textContent = `Expires: ${expiryDate}`;
            
            document.getElementById('pinModal').classList.remove('hidden');
        }

        // Close PIN modal
        function closePinModal() {
            document.getElementById('pinModal').classList.add('hidden');
        }

        // Copy PIN to clipboard
        function copyPinToClipboard() {
            if (appState.generatedPin) {
                const pin = appState.generatedPin.pin;
                navigator.clipboard.writeText(pin).then(() => {
                    alert(`PIN ${pin} copied to clipboard!`);
                }).catch(err => {
                    // Fallback for browsers that don't support clipboard API
                    const textArea = document.createElement('textarea');
                    textArea.value = pin;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert(`PIN ${pin} copied to clipboard!`);
                });
            }
        }

        // View all PINs
        function viewAllPins() {
            const pins = JSON.parse(localStorage.getItem('nsukLecturerPins') || '[]');
            
            if (pins.length === 0) {
                alert('No PINs have been generated yet.');
                return;
            }
            
            let message = 'Lecturer PINs:\n\n';
            pins.forEach((pin, index) => {
                const expiry = new Date(pin.expiry);
                const isExpired = expiry < new Date();
                const status = !pin.isActive ? 'Deactivated' : (isExpired ? 'Expired' : 'Active');
                const expiryStr = expiry.toLocaleDateString();
                
                message += `${index + 1}. ${pin.lecturerName}\n`;
                message += `   PIN: ${pin.pin}\n`;
                message += `   Status: ${status}\n`;
                message += `   Generated: ${new Date(pin.generatedAt).toLocaleDateString()}\n`;
                message += `   Expiry: ${expiryStr}\n`;
                message += `   Usage: ${pin.usageCount || 0} times\n`;
                if (pin.lastUsed) {
                    message += `   Last Used: ${new Date(pin.lastUsed).toLocaleDateString()}\n`;
                }
                message += `   Generated By: ${pin.generatedBy}\n\n`;
            });
            
            message += `Total PINs: ${pins.length}`;
            alert(message);
        }

        function adminLogout() {
            // Clear session
            appState.currentAdmin = null;
            sessionStorage.removeItem('nsukAdminToken');
            localStorage.removeItem('nsukAdminRemember');
            
            // Add logout parameter to prevent auto-login
            window.location.hash = 'logout';
            
            showScreen('role-selection-screen');
            
            // Show logout message
            setTimeout(() => {
                alert('Logged out successfully. You can now login from any device using your admin credentials.');
            }, 500);
        }

        async function viewAllAdmins() {
            try {
                const result = await BACKEND_SIMULATION.call('/admins/list');
                
                if (result.success) {
                    let message = 'Single Admin Account:\n\n';
                    message += `Note: Only one administrator account is allowed for this system.\n\n`;
                    
                    result.data.forEach((admin, index) => {
                        const date = new Date(admin.createdAt).toLocaleDateString();
                        const status = admin.isActive ? 'Active' : 'Inactive';
                        message += `${index + 1}. ${admin.name}\n`;
                        message += `   Username: ${admin.username}\n`;
                        message += `   Email: ${admin.email}\n`;
                        message += `   Status: ${status}\n`;
                        message += `   Created: ${date}\n\n`;
                    });
                    
                    message += '\nNote: This account works across all devices.';
                    alert(message);
                } else {
                    alert('Error loading admin list.');
                }
            } catch (error) {
                alert('Network error. Please check your connection.');
            }
        }

        async function viewAllAttendance() {
            try {
                const result = await BACKEND_SIMULATION.call('/attendance/list');
                
                if (result.success) {
                    const records = result.data;
                    if (records.length === 0) {
                        alert('No attendance records found.');
                        return;
                    }
                    
                    let message = `Attendance Records: ${records.length}\n\n`;
                    message += 'Last 5 Records:\n\n';
                    
                    records.slice(-5).reverse().forEach((record, index) => {
                        message += `${index + 1}. ${record.name} (${record.matric})\n`;
                        message += `   Course: ${record.course}\n`;
                        message += `   Date: ${record.date} ${record.time}\n`;
                        message += `   Device: ${record.deviceInfo?.platform || 'Unknown'}\n\n`;
                    });
                    
                    alert(message);
                } else {
                    alert('Error loading attendance records.');
                }
            } catch (error) {
                alert('Network error. Please check your connection.');
            }
        }

        function systemSettings() {
            let message = 'System Settings\n\n';
            message += '1. Account Management:\n';
            message += '   - Single admin account (works on all devices)\n';
            message += '   - Student accounts work across all devices\n';
            message += '   - Data syncs automatically when online\n\n';
            message += '2. PIN Generation:\n';
            message += '   - Generate 6-digit PINs for lecturers\n';
            message += '   - Customizable expiry periods\n';
            message += '   - Track PIN usage statistics\n\n';
            message += '3. Multi-Device Support:\n';
            message += '   - Works on mobile and desktop\n';
            message += '   - Syncs across different browsers/devices\n';
            message += '   - Offline mode supported\n\n';
            message += '4. Security Features:\n';
            message += '   - Single admin user restriction\n';
            message += '   - Encrypted session tokens\n';
            message += '   - Automatic logout after 24h';
            
            alert(message);
        }

        // Modal functions
        function openHelpModal() {
            document.getElementById('helpModal').classList.remove('hidden');
        }

        function closeHelpModal() {
            document.getElementById('helpModal').classList.add('hidden');
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
        }

        function viewAttendanceRecord() {
            closeSuccessModal();
            try {
                const records = JSON.parse(localStorage.getItem('nsukAttendanceRecords') || '[]');
                if (records.length > 0) {
                    const lastRecord = records[records.length - 1];
                    alert(`Last Attendance Record:\n\nName: ${lastRecord.name}\nMatric: ${lastRecord.matric}\nCourse: ${lastRecord.course}\nDate: ${lastRecord.date}\nTime: ${lastRecord.time}\nLocation: ${lastRecord.location.lat.toFixed(6)}°, ${lastRecord.location.lon.toFixed(6)}°\n\nTotal records: ${records.length}`);
                } else {
                    alert('No attendance records found.');
                }
            } catch (error) {
                alert('Error reading attendance records.');
            }
        }
    </script>
</body>
</html>
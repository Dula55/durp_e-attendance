<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f1b3d" />
  <title>NSUK URP — E-Attendance</title>

  <!-- Tailwind CSS (required) -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <!-- PDF (client-side) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* Small, accessible baseline enhancements (kept minimal; Tailwind does most styling) */
    :root { color-scheme: light; }
    html { scroll-behavior: smooth; }

    /* Subtle animated accent */
    .shimmer {
      background: linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.18), rgba(255,255,255,0.05));
      background-size: 200% 100%;
      animation: shimmer 2.2s ease-in-out infinite;
    }
    @keyframes shimmer { 0% { background-position: 0% 0; } 100% { background-position: 200% 0; } }

    /* Hide number input spinners (PIN can be numeric) */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    /* Print-friendly */
    @media print {
      .no-print { display: none !important; }
      body { background: #fff !important; }
    }
  </style>
</head>

<body class="min-h-screen bg-slate-50 text-slate-900">
  <!-- Top Banner -->
  <header class="no-print">
    <div class="bg-[#0f1b3d] text-white">
      <div class="mx-auto max-w-6xl px-4 py-5 sm:py-6">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div class="flex items-start gap-3">
            <!-- Simple academic crest-style mark (inline SVG) -->
            <div class="shimmer mt-0.5 h-10 w-10 rounded-xl bg-white/10 ring-1 ring-white/15 flex items-center justify-center" aria-hidden="true">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2l9 4.5-9 4.5L3 6.5 12 2Z" stroke="rgba(255,255,255,0.95)" stroke-width="1.6" stroke-linejoin="round"/>
                <path d="M6.5 9.2V14c0 2.2 2.5 4 5.5 4s5.5-1.8 5.5-4V9.2" stroke="rgba(255,255,255,0.95)" stroke-width="1.6" stroke-linecap="round"/>
                <path d="M21 6.5v6" stroke="rgba(255,255,255,0.95)" stroke-width="1.6" stroke-linecap="round"/>
                <circle cx="21" cy="13.5" r="1" fill="rgba(255,255,255,0.95)"/>
              </svg>
            </div>

            <div>
              <h1 class="text-base sm:text-lg font-semibold tracking-tight">Department of Urban and Regional Planning</h1>
              <p class="text-sm text-white/80">Nasarawa State University, Keffi (NSUK) — E-Attendance</p>
            </div>
          </div>

          <div class="flex flex-wrap items-center gap-2 sm:gap-3">
            <div class="rounded-xl bg-white/10 ring-1 ring-white/15 px-3 py-2">
              <p class="text-xs text-white/70">Status</p>
              <p id="statusSummary" class="text-sm font-medium">Ready</p>
            </div>
            <button id="btnOpenHelp" class="rounded-xl bg-white text-[#0f1b3d] px-3 py-2 text-sm font-semibold hover:bg-white/95 focus:outline-none focus:ring-2 focus:ring-white/70">
              Instructions
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <nav class="border-b border-slate-200 bg-white">
      <div class="mx-auto max-w-6xl px-4">
        <div class="flex gap-2 py-3" role="tablist" aria-label="Sections">
          <button id="tabStudent" class="rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-slate-900 text-white focus:outline-none focus:ring-2 focus:ring-slate-400" role="tab" aria-selected="true" aria-controls="panelStudent">
            Student Attendance
          </button>
          <button id="tabAdmin" class="rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-white text-slate-800 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-400" role="tab" aria-selected="false" aria-controls="panelAdmin">
            Admin / Lecturer
          </button>
          <div class="ml-auto hidden sm:flex items-center gap-2 text-xs text-slate-600">
            <span class="inline-flex items-center gap-2 rounded-full bg-slate-50 ring-1 ring-slate-200 px-3 py-2">
              <span class="h-2 w-2 rounded-full bg-emerald-500" aria-hidden="true"></span>
              <span>Works offline after first load: <span class="font-semibold">limited</span> (no service worker)</span>
            </span>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-6 sm:py-8">
    <!-- Student Panel -->
    <section id="panelStudent" role="tabpanel" aria-labelledby="tabStudent">
      <div class="grid gap-4 lg:grid-cols-12">
        <!-- Left: Steps -->
        <div class="lg:col-span-8">
          <div class="rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm">
            <div class="border-b border-slate-200 px-5 py-4 sm:px-6">
              <h2 class="text-lg font-semibold">Student Attendance</h2>
              <p class="mt-1 text-sm text-slate-600">
                To submit attendance, you must <span class="font-semibold">capture your location</span> and <span class="font-semibold">capture your face</span> using your device camera.
              </p>
             
            </div>

            <div class="px-5 py-5 sm:px-6">
              <!-- Step 1: Location -->
              <div class="rounded-2xl border border-slate-200 bg-slate-50/70 p-4">
                <div class="flex items-start justify-between gap-3">
                  <div class="min-w-0">
                    <div class="flex items-center gap-2">
                      <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-[#0f1b3d] text-white text-sm font-bold">1</span>
                      <h3 class="text-base font-semibold">Enable Location</h3>
                    </div>
                    <p class="mt-1 text-sm text-slate-600">We capture your latitude and longitude for attendance verification.</p>
                  </div>
                  <button id="btnGetLocation" class="shrink-0 rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-400">
                    Capture Location
                  </button>
                </div>

                <div class="mt-3 grid gap-2 sm:grid-cols-3">
                  <div class="rounded-xl bg-white p-3 ring-1 ring-slate-200">
                    <p class="text-xs text-slate-500">Location Status</p>
                    <p id="locStatus" class="mt-1 text-sm font-semibold text-slate-800">Not captured</p>
                  </div>
                  <div class="rounded-xl bg-white p-3 ring-1 ring-slate-200">
                    <p class="text-xs text-slate-500">Latitude</p>
                    <p id="latText" class="mt-1 text-sm font-semibold tabular-nums">—</p>
                  </div>
                  <div class="rounded-xl bg-white p-3 ring-1 ring-slate-200">
                    <p class="text-xs text-slate-500">Longitude</p>
                    <p id="lonText" class="mt-1 text-sm font-semibold tabular-nums">—</p>
                  </div>
                </div>

                <div id="locError" class="mt-3 hidden rounded-xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-800"></div>
              </div>

              <!-- Step 2: Face Capture -->
              <div class="mt-4 rounded-2xl border border-slate-200 bg-slate-50/70 p-4">
                <div class="flex items-start justify-between gap-3">
                  <div class="min-w-0">
                    <div class="flex items-center gap-2">
                      <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-[#0f1b3d] text-white text-sm font-bold">2</span>
                      <h3 class="text-base font-semibold">Capture Face</h3>
                    </div>
                    <p class="mt-1 text-sm text-slate-600">Use your front camera and capture a clear image.</p>
                  </div>
                  <div class="flex gap-2">
                    <button id="btnStartCamera" class="rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-400">
                      Start Camera
                    </button>
                    <button id="btnCaptureFace" class="rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-slate-400" disabled>
                      Capture
                    </button>
                  </div>
                </div>

                <div class="mt-4 grid gap-3 sm:grid-cols-2">
                  <div class="rounded-2xl bg-white ring-1 ring-slate-200 overflow-hidden">
                    <div class="border-b border-slate-200 px-3 py-2">
                      <p class="text-xs font-semibold text-slate-600">Live Camera</p>
                    </div>
                    <div class="p-3">
                      <video id="video" class="w-full rounded-xl bg-slate-900/5" autoplay muted playsinline></video>
                      <p id="camHint" class="mt-2 text-xs text-slate-500">Tip: Ensure your face is well-lit and centered.</p>
                      <div id="camError" class="mt-2 hidden rounded-xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-800"></div>
                    </div>
                  </div>

                  <div class="rounded-2xl bg-white ring-1 ring-slate-200 overflow-hidden">
                    <div class="border-b border-slate-200 px-3 py-2 flex items-center justify-between">
                      <p class="text-xs font-semibold text-slate-600">Captured Image</p>
                      <button id="btnRetake" class="text-xs font-semibold text-slate-700 hover:text-slate-900 disabled:opacity-50" disabled>Retake</button>
                    </div>
                    <div class="p-3">
                      <div class="aspect-video w-full rounded-xl bg-slate-900/5 flex items-center justify-center overflow-hidden">
                        <img id="facePreview" alt="Captured face preview" class="hidden h-full w-full object-cover" />
                        <div id="faceEmpty" class="text-sm text-slate-500">No image captured yet</div>
                      </div>
                      <div class="mt-2 grid gap-2 sm:grid-cols-2">
                        <div class="rounded-xl bg-slate-50 ring-1 ring-slate-200 p-3">
                          <p class="text-xs text-slate-500">Face Status</p>
                          <p id="faceStatus" class="mt-1 text-sm font-semibold">Not captured</p>
                        </div>
                        <div class="rounded-xl bg-slate-50 ring-1 ring-slate-200 p-3">
                          <p class="text-xs text-slate-500">Image Quality</p>
                          <p id="faceQuality" class="mt-1 text-sm font-semibold">—</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 3: Attendance Form -->
              <div class="mt-4 rounded-2xl border border-slate-200 bg-slate-50/70 p-4">
                <div class="flex items-start gap-3">
                  <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-[#0f1b3d] text-white text-sm font-bold">3</span>
                  <div>
                    <h3 class="text-base font-semibold">Attendance Form</h3>
                    <p class="mt-1 text-sm text-slate-600">
                      The form is unlocked after successful face capture. Submission requires location + face + required fields.
                    </p>
                  </div>
                </div>

                <form id="attendanceForm" class="mt-4" autocomplete="on" novalidate>
                  <fieldset id="formFieldset" disabled class="opacity-60">
                    <div class="grid gap-3 sm:grid-cols-2">
                      <div>
                        <label for="studentName" class="block text-sm font-semibold text-slate-800">Name <span class="text-rose-600">*</span></label>
                        <input id="studentName" name="name" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400" placeholder="e.g., Abdullahi Suleiman" />
                      </div>
                      <div>
                        <label for="matricNo" class="block text-sm font-semibold text-slate-800">Matric Number <span class="text-rose-600">*</span></label>
                        <input id="matricNo" name="matric" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400" placeholder="e.g., FT26URP1234" />
                      </div>
                      <div class="sm:col-span-2">
                        <label for="courseCode" class="block text-sm font-semibold text-slate-800">Course Code <span class="text-rose-600">*</span></label>
                        <input id="courseCode" name="course" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400" placeholder="e.g., URP 111" />
                      </div>
                    </div>

                    <div class="mt-4 grid gap-2 sm:grid-cols-3">
                      <div class="rounded-xl bg-white p-3 ring-1 ring-slate-200">
                        <p class="text-xs text-slate-500">Date</p>
                        <p id="dateText" class="mt-1 text-sm font-semibold">—</p>
                      </div>
                      <div class="rounded-xl bg-white p-3 ring-1 ring-slate-200">
                        <p class="text-xs text-slate-500">Time</p>
                        <p id="timeText" class="mt-1 text-sm font-semibold">—</p>
                      </div>
                      <div class="rounded-xl bg-white p-3 ring-1 ring-slate-200">
                        <p class="text-xs text-slate-500">Verification</p>
                        <p id="verifyText" class="mt-1 text-sm font-semibold">Pending</p>
                      </div>
                    </div>

                    <div class="mt-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                      <div class="text-xs text-slate-600">
                        <span class="font-semibold">Auto-captured:</span> Date/Time, Latitude/Longitude, Face image.
                      </div>
                      <button id="btnSubmit" type="submit" class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-emerald-300" disabled>
                        Submit Attendance
                      </button>
                    </div>
                  </fieldset>

                  <div id="formLockedNote" class="mt-3 rounded-xl border border-slate-200 bg-white p-3 text-sm text-slate-700">
                    <span class="font-semibold">Locked:</span> Start the camera and capture your face to unlock the attendance form.
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Quick Info -->
        <aside class="lg:col-span-4">
          <div class="rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm">
            <div class="border-b border-slate-200 px-5 py-4 sm:px-6">
              <h3 class="text-base font-semibold">Quick Checklist</h3>
              <p class="mt-1 text-sm text-slate-600">Ensure all items are completed before submitting.</p>
            </div>
            <div class="px-5 py-5 sm:px-6">
              <ul class="space-y-3">
                <li class="flex items-start gap-3">
                  <span id="checkLoc" class="mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg bg-slate-100 text-slate-700 ring-1 ring-slate-200" aria-hidden="true">—</span>
                  <div>
                    <p class="text-sm font-semibold">Location captured</p>
                    <p class="text-xs text-slate-600">Allow location access when prompted.</p>
                  </div>
                </li>
                <li class="flex items-start gap-3">
                  <span id="checkFace" class="mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg bg-slate-100 text-slate-700 ring-1 ring-slate-200" aria-hidden="true">—</span>
                  <div>
                    <p class="text-sm font-semibold">Face captured</p>
                    <p class="text-xs text-slate-600">Use the front camera; ensure clarity.</p>
                  </div>
                </li>
                <li class="flex items-start gap-3">
                  <span id="checkFields" class="mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg bg-slate-100 text-slate-700 ring-1 ring-slate-200" aria-hidden="true">—</span>
                  <div>
                    <p class="text-sm font-semibold">Required fields filled</p>
                    <p class="text-xs text-slate-600">Name, matric number, course code.</p>
                  </div>
                </li>
              </ul>

              <div class="mt-5 rounded-2xl border border-slate-200 bg-slate-50 p-4">
                <p class="text-xs font-semibold text-slate-700">Privacy (Local Device Only)</p>
                <p class="mt-1 text-xs text-slate-600">
                  Attendance records (including the captured image) are stored in your browser’s local storage on this device.
                  No data is uploaded to any server.
                </p>
              </div>

              <div class="mt-4 rounded-2xl border border-slate-200 bg-white p-4">
                <p class="text-xs font-semibold text-slate-700">Support</p>
                <p class="mt-1 text-xs text-slate-600">
                  If location/camera fails, confirm you are using HTTPS and that permissions are allowed in your browser settings.
                </p>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <!-- Admin Panel -->
    <section id="panelAdmin" role="tabpanel" aria-labelledby="tabAdmin" class="hidden">
      <div class="grid gap-4 lg:grid-cols-12">
        <div class="lg:col-span-4">
          <div class="rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm">
            <div class="border-b border-slate-200 px-5 py-4 sm:px-6">
              <h2 class="text-lg font-semibold">Admin / Lecturer Access</h2>
              <p class="mt-1 text-sm text-slate-600">Enter the system-generated PIN to access the dashboard.</p>
            </div>

            <div class="px-5 py-5 sm:px-6">
              <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
                <label for="pinInput" class="block text-sm font-semibold text-slate-800">Admin PIN</label>
                <input id="pinInput" inputmode="numeric" autocomplete="one-time-code" class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm tracking-widest focus:outline-none focus:ring-2 focus:ring-slate-400" placeholder="Enter PIN" />
                <button id="btnUnlock" class="mt-3 w-full rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-400">Unlock Dashboard</button>
                <p id="pinMsg" class="mt-2 text-xs text-slate-600"></p>
              </div>

              <details class="mt-4 rounded-2xl border border-slate-200 bg-white p-4" open>
                <summary class="cursor-pointer text-sm font-semibold text-slate-800">Lecturer tools (Reveal / Reset PIN)</summary>
                <div class="mt-3 space-y-3">
                  <div class="rounded-xl border border-amber-200 bg-amber-50 p-3 text-xs text-amber-900">
                    <strong>Note:</strong> This is a client-only application. The PIN is stored on this device. The Admin should generate the PIN here, copy it, and share it with Lecturers for them to input on their devices.
                  </div>
                  <div class="flex flex-col gap-2 sm:flex-row">
                    <button id="btnCopyPin" class="rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-400">Copy PIN</button>
                    <button id="btnResetPin" class="rounded-xl bg-rose-600 px-4 py-2 text-sm font-semibold text-white hover:bg-rose-700 focus:outline-none focus:ring-2 focus:ring-rose-300">Reset PIN</button>
                  </div>
                  <div class="rounded-xl bg-slate-50 ring-1 ring-slate-200 p-3">
                    <p class="text-xs text-slate-500">System PIN (Auto-Revealed)</p>
                    <p id="pinDisplay" class="mt-1 text-xl font-bold tracking-widest text-slate-900">••••••</p>
                  </div>
                </div>
              </details>

              <div class="mt-4 rounded-2xl border border-slate-200 bg-white p-4">
                <p class="text-xs font-semibold text-slate-700">Data Source</p>
                <p class="mt-1 text-xs text-slate-600">Dashboard reads attendance from this browser’s local storage.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="lg:col-span-8">
          <div id="adminLocked" class="rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm">
            <div class="px-5 py-10 sm:px-6 text-center">
              <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-2xl bg-slate-50 ring-1 ring-slate-200" aria-hidden="true">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M7 10V8a5 5 0 0 1 10 0v2" stroke="#0f172a" stroke-width="1.6" stroke-linecap="round"/>
                  <path d="M6.5 10h11a2 2 0 0 1 2 2v6.5a2 2 0 0 1-2 2h-11a2 2 0 0 1-2-2V12a2 2 0 0 1 2-2Z" stroke="#0f172a" stroke-width="1.6"/>
                </svg>
              </div>
              <h3 class="mt-4 text-base font-semibold">Dashboard Locked</h3>
              <p class="mt-1 text-sm text-slate-600">Enter the correct PIN to view attendance records.</p>
            </div>
          </div>

          <div id="adminDashboard" class="hidden rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm">
            <div class="border-b border-slate-200 px-5 py-4 sm:px-6">
              <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                <div>
                  <h2 class="text-lg font-semibold">Attendance Dashboard</h2>
                  <p class="mt-1 text-sm text-slate-600">View, download PDF, or clear records.</p>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                  <button id="btnDownloadPdf" class="rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-400">Download PDF</button>
                  <button id="btnClear" class="rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-400">Clear Records</button>
                  <button id="btnLock" class="rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-400">Lock</button>
                </div>
              </div>

              <div class="mt-4 grid gap-3 sm:grid-cols-3">
                <div class="rounded-xl bg-slate-50 ring-1 ring-slate-200 p-3">
                  <p class="text-xs text-slate-500">Total Records</p>
                  <p id="statTotal" class="mt-1 text-lg font-bold tabular-nums">0</p>
                </div>
                <div class="rounded-xl bg-slate-50 ring-1 ring-slate-200 p-3">
                  <p class="text-xs text-slate-500">Most Recent</p>
                  <p id="statRecent" class="mt-1 text-sm font-semibold">—</p>
                </div>
                <div class="rounded-xl bg-slate-50 ring-1 ring-slate-200 p-3">
                  <label for="searchInput" class="text-xs text-slate-500">Search (name/matric/course)</label>
                  <input id="searchInput" class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400" placeholder="Type to filter…" />
                </div>
              </div>
            </div>

            <div class="px-5 py-5 sm:px-6">
              <div class="overflow-x-auto rounded-2xl ring-1 ring-slate-200">
                <table class="min-w-full bg-white">
                  <thead class="bg-slate-50">
                    <tr class="text-left text-xs font-semibold text-slate-600">
                      <th class="px-4 py-3">Name</th>
                      <th class="px-4 py-3">Matric</th>
                      <th class="px-4 py-3">Course</th>
                      <th class="px-4 py-3">Date &amp; Time</th>
                      <th class="px-4 py-3">Latitude</th>
                      <th class="px-4 py-3">Longitude</th>
                      <th class="px-4 py-3">Face</th>
                    </tr>
                  </thead>
                  <tbody id="recordsTbody" class="divide-y divide-slate-100 text-sm">
                    <!-- Filled by JS -->
                  </tbody>
                </table>
              </div>

              <p id="emptyAdmin" class="mt-3 hidden text-sm text-slate-600">No records found.</p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="no-print border-t border-slate-200 bg-white">
    <div class="mx-auto max-w-6xl px-4 py-6">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <p class="text-xs text-slate-600">© <span id="year"></span> NSUK — Department of Urban and Regional Planning.</p>
        <p class="text-xs text-slate-500">Developed by A. Suleiman and Powered by Ramsulone Innovation & Services Ltd.</p>
      </div>
    </div>
  </footer>

  <!-- Modal: Help -->
  <div id="helpModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-slate-900/50"></div>
    <div class="relative mx-auto max-w-2xl p-4 sm:p-6">
      <div class="rounded-2xl bg-white shadow-xl ring-1 ring-slate-200">
        <div class="border-b border-slate-200 px-5 py-4 sm:px-6 flex items-start justify-between gap-3">
          <div>
            <h3 class="text-base font-semibold">How to Mark Attendance</h3>
            <p class="mt-1 text-sm text-slate-600">Follow these steps carefully on your smartphone.</p>
          </div>
          <button id="btnCloseHelp" class="rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-400">Close</button>
        </div>
        <div class="px-5 py-5 sm:px-6">
          <ol class="list-decimal pl-5 space-y-2 text-sm text-slate-700">
            <li>Tap <span class="font-semibold">Capture Location</span> and allow location permission.</li>
            <li>Tap <span class="font-semibold">Start Camera</span> and allow camera permission.</li>
            <li>Tap <span class="font-semibold">Capture</span> to take a still image of your face.</li>
            <li>Fill <span class="font-semibold">Name</span>, <span class="font-semibold">Matric Number</span>, and <span class="font-semibold">Course Code</span>.</li>
            <li>Tap <span class="font-semibold">Submit Attendance</span> and wait for confirmation.</li>
          </ol>
          <div class="mt-4 rounded-xl border border-amber-200 bg-amber-50 p-3 text-xs text-amber-900">
            If permissions are denied, enable them in your browser settings and reload the page.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Face Viewer -->
  <div id="faceModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-slate-900/55"></div>
    <div class="relative mx-auto max-w-3xl p-4 sm:p-6">
      <div class="rounded-2xl bg-white shadow-xl ring-1 ring-slate-200 overflow-hidden">
        <div class="border-b border-slate-200 px-5 py-4 sm:px-6 flex items-start justify-between gap-3">
          <div class="min-w-0">
            <h3 class="text-base font-semibold">Captured Face</h3>
            <p id="faceModalMeta" class="mt-1 text-sm text-slate-600 truncate">—</p>
          </div>
          <button id="btnCloseFace" class="rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-400">Close</button>
        </div>
        <div class="p-4 sm:p-6">
          <img id="faceModalImg" alt="Face image" class="w-full rounded-2xl ring-1 ring-slate-200" />
          <div class="mt-4 flex flex-wrap gap-2">
            <a id="mapLink" href="#" target="_blank" rel="noopener" class="rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">Open Location on Map</a>
          </div>
          <p class="mt-3 text-xs text-slate-500">Image and coordinates are stored locally in the browser.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="pointer-events-none fixed bottom-4 left-1/2 -translate-x-1/2 z-50 hidden">
    <div class="rounded-2xl bg-slate-900 text-white px-4 py-3 shadow-lg ring-1 ring-white/10">
      <p id="toastText" class="text-sm font-semibold">—</p>
      <p id="toastSub" class="text-xs text-white/80 mt-0.5">—</p>
    </div>
  </div>

  <!-- Hidden canvas for capture -->
  <canvas id="captureCanvas" class="hidden"></canvas>

  <script>
    /*********************
     * NSUK URP E-Attendance (Single-file, client-only)
     * - Student: Geolocation + Camera capture gates attendance submission
     * - Admin: PIN-gated dashboard, localStorage records, PDF export
     *********************/

    // ---------- DOM helpers ----------
    const $ = (id) => document.getElementById(id);
    const escapeHtml = (s) => String(s).replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

    // ---------- Storage keys ----------
    const STORAGE_KEY_RECORDS = 'nsuk_urp_attendance_records_v1';
    const STORAGE_KEY_PIN = 'nsuk_urp_admin_pin_v1';

    // ---------- State ----------
    const state = {
      location: { ok: false, lat: null, lon: null, accuracy: null, denied: false },
      face: { ok: false, dataUrl: null, w: null, h: null },
      camera: { stream: null, started: false },
      admin: { unlocked: false },
    };

    // ---------- Utilities ----------
    function now() {
      return new Date();
    }

    function pad2(n) { return String(n).padStart(2, '0'); }

    function formatDate(d) {
      // e.g., 06 Jan 2026
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      return `${pad2(d.getDate())} ${months[d.getMonth()]} ${d.getFullYear()}`;
    }

    function formatTime(d) {
      // 24-hour time: HH:MM:SS
      return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    }

    function makeId() {
      return `att_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    }

    function showToast(title, sub = '') {
      $('toastText').textContent = title;
      $('toastSub').textContent = sub;
      $('toast').classList.remove('hidden');
      window.clearTimeout(showToast._t);
      showToast._t = window.setTimeout(() => $('toast').classList.add('hidden'), 3200);
    }

    function setStatusSummary() {
      const pieces = [];
      pieces.push(state.location.ok ? 'Location ✓' : (state.location.denied ? 'Location denied' : 'Location …'));
      pieces.push(state.face.ok ? 'Face ✓' : 'Face …');
      $('statusSummary').textContent = pieces.join(' • ');
    }

    function setChecklist() {
      const mark = (ok) => ok ? '✓' : '—';
      const cls = (ok) => ok ? 'bg-emerald-50 text-emerald-700 ring-emerald-200' : 'bg-slate-100 text-slate-700 ring-slate-200';

      $('checkLoc').textContent = mark(state.location.ok);
      $('checkLoc').className = `mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg ring-1 ${cls(state.location.ok)}`;

      $('checkFace').textContent = mark(state.face.ok);
      $('checkFace').className = `mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg ring-1 ${cls(state.face.ok)}`;

      const fieldsOk = requiredFieldsFilled();
      $('checkFields').textContent = mark(fieldsOk);
      $('checkFields').className = `mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-lg ring-1 ${cls(fieldsOk)}`;

      // Verification text inside the form
      const ver = (state.location.ok && state.face.ok && fieldsOk) ? 'Ready to submit' : 'Pending';
      $('verifyText').textContent = ver;

      setStatusSummary();
    }

    function requiredFieldsFilled() {
      const name = $('studentName').value.trim();
      const matric = $('matricNo').value.trim();
      const course = $('courseCode').value.trim();
      return Boolean(name && matric && course);
    }

    function updateDateTimePreview() {
      const d = now();
      $('dateText').textContent = formatDate(d);
      $('timeText').textContent = formatTime(d);
    }

    function updateSubmitState() {
      // Form unlocking rule: remains disabled until face capture is successful.
      const unlocked = state.face.ok;
      $('formFieldset').disabled = !unlocked;
      $('formFieldset').classList.toggle('opacity-60', !unlocked);
      $('formLockedNote').classList.toggle('hidden', unlocked);

      const canSubmit = state.location.ok && state.face.ok && requiredFieldsFilled();
      $('btnSubmit').disabled = !canSubmit;

      setChecklist();
    }

    // ---------- Records ----------
    function loadRecords() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_RECORDS);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function saveRecords(records) {
      localStorage.setItem(STORAGE_KEY_RECORDS, JSON.stringify(records));
    }

    // ---------- PIN ----------
    function generatePin() {
      // 6-digit PIN
      return String(Math.floor(100000 + Math.random() * 900000));
    }

    function ensurePin() {
      let pin = localStorage.getItem(STORAGE_KEY_PIN);
      if (!pin) {
        pin = generatePin();
        localStorage.setItem(STORAGE_KEY_PIN, pin);
      }
      return pin;
    }

    function getPin() {
      return localStorage.getItem(STORAGE_KEY_PIN) || ensurePin();
    }

    function maskPin(pin) {
      if (!pin) return '••••••';
      return '•'.repeat(Math.max(4, pin.length));
    }

    // ---------- Location ----------
    async function captureLocation() {
      $('locError').classList.add('hidden');
      $('locError').textContent = '';

      if (!('geolocation' in navigator)) {
        state.location.ok = false;
        state.location.denied = true;
        $('locStatus').textContent = 'Geolocation not supported';
        $('locError').textContent = 'Your browser does not support the Geolocation API.';
        $('locError').classList.remove('hidden');
        updateSubmitState();
        return;
      }

      $('locStatus').textContent = 'Requesting permission…';

      const opts = { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 };
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          state.location.ok = true;
          state.location.denied = false;
          state.location.lat = latitude;
          state.location.lon = longitude;
          state.location.accuracy = accuracy;

          $('locStatus').textContent = `Captured (±${Math.round(accuracy)}m)`;
          $('latText').textContent = latitude.toFixed(6);
          $('lonText').textContent = longitude.toFixed(6);

          showToast('Location captured', `Accuracy ±${Math.round(accuracy)}m`);
          updateSubmitState();
        },
        (err) => {
          state.location.ok = false;
          state.location.lat = null;
          state.location.lon = null;
          state.location.accuracy = null;

          // Most common: permission denied
          state.location.denied = (err.code === 1);
          $('locStatus').textContent = state.location.denied ? 'Permission denied' : 'Location error';

          let msg = err.message || 'Unable to capture location.';
          if (err.code === 1) {
            msg = 'Location permission was denied. Enable location permission in your browser settings and try again.';
          } else if (err.code === 2) {
            msg = 'Location unavailable. Try moving to an open area or enabling GPS.';
          } else if (err.code === 3) {
            msg = 'Location request timed out. Try again.';
          }
          $('locError').textContent = msg;
          $('locError').classList.remove('hidden');
          showToast('Location not captured', msg);
          updateSubmitState();
        },
        opts
      );
    }

    // ---------- Camera / Face capture ----------
    async function startCamera() {
      $('camError').classList.add('hidden');
      $('camError').textContent = '';

      if (!navigator.mediaDevices?.getUserMedia) {
        $('camError').textContent = 'Camera not supported in this browser.';
        $('camError').classList.remove('hidden');
        return;
      }

      try {
        // Prefer front camera if available
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: false,
        });

        state.camera.stream = stream;
        state.camera.started = true;
        $('video').srcObject = stream;
        $('btnCaptureFace').disabled = false;

        showToast('Camera started', 'Position your face and tap Capture.');
      } catch (err) {
        state.camera.stream = null;
        state.camera.started = false;
        $('btnCaptureFace').disabled = true;

        const msg = (err && err.name === 'NotAllowedError')
          ? 'Camera permission was denied. Enable camera permission in your browser settings and try again.'
          : (err?.message || 'Unable to access camera.');

        $('camError').textContent = msg;
        $('camError').classList.remove('hidden');
        showToast('Camera error', msg);
      }
    }

    function stopCamera() {
      if (state.camera.stream) {
        state.camera.stream.getTracks().forEach(t => t.stop());
      }
      state.camera.stream = null;
      state.camera.started = false;
      $('video').srcObject = null;
      $('btnCaptureFace').disabled = true;
    }

    function estimateQuality(w, h) {
      // Simple heuristic: larger captured size => better
      const pixels = w * h;
      if (pixels >= 500_000) return 'High';
      if (pixels >= 250_000) return 'Medium';
      return 'Low';
    }

    function captureFace() {
      $('camError').classList.add('hidden');
      $('camError').textContent = '';

      const video = $('video');
      if (!video || !state.camera.started) {
        $('camError').textContent = 'Camera is not started. Tap “Start Camera” first.';
        $('camError').classList.remove('hidden');
        return;
      }

      const canvas = $('captureCanvas');
      const vw = video.videoWidth || 0;
      const vh = video.videoHeight || 0;
      if (!vw || !vh) {
        $('camError').textContent = 'Unable to read camera frame. Please try again.';
        $('camError').classList.remove('hidden');
        return;
      }

      // Scale down to reduce storage size (important for localStorage)
      const MAX_W = 720;
      const scale = Math.min(1, MAX_W / vw);
      const w = Math.round(vw * scale);
      const h = Math.round(vh * scale);

      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d', { willReadFrequently: false });
      ctx.drawImage(video, 0, 0, w, h);

      // JPEG for compactness
      const dataUrl = canvas.toDataURL('image/jpeg', 0.78);

      state.face.ok = true;
      state.face.dataUrl = dataUrl;
      state.face.w = w;
      state.face.h = h;

      // Update UI
      $('facePreview').src = dataUrl;
      $('facePreview').classList.remove('hidden');
      $('faceEmpty').classList.add('hidden');
      $('faceStatus').textContent = 'Captured';
      $('faceStatus').className = 'mt-1 text-sm font-semibold text-emerald-700';
      $('faceQuality').textContent = `${estimateQuality(w,h)} (${w}×${h})`;
      $('btnRetake').disabled = false;

      // After capture, stop camera for privacy and battery saving
      stopCamera();

      showToast('Face captured', 'Form unlocked. Complete the fields and submit.');
      updateSubmitState();
    }

    function retakeFace() {
      state.face.ok = false;
      state.face.dataUrl = null;
      state.face.w = null;
      state.face.h = null;

      $('facePreview').src = '';
      $('facePreview').classList.add('hidden');
      $('faceEmpty').classList.remove('hidden');
      $('faceStatus').textContent = 'Not captured';
      $('faceStatus').className = 'mt-1 text-sm font-semibold text-slate-800';
      $('faceQuality').textContent = '—';
      $('btnRetake').disabled = true;

      updateSubmitState();
    }

    // ---------- Student submit ----------
    function submitAttendance(e) {
      e.preventDefault();

      // Defensive checks
      if (!state.face.ok) {
        showToast('Face required', 'Capture your face before submitting.');
        return;
      }
      if (!state.location.ok) {
        showToast('Location required', 'Capture your location before submitting.');
        return;
      }
      if (!requiredFieldsFilled()) {
        showToast('Complete required fields', 'Name, Matric Number, and Course Code are required.');
        return;
      }

      const d = now();
      const record = {
        id: makeId(),
        name: $('studentName').value.trim(),
        matric: $('matricNo').value.trim(),
        course: $('courseCode').value.trim(),
        date: formatDate(d),
        time: formatTime(d),
        iso: d.toISOString(),
        lat: Number(state.location.lat),
        lon: Number(state.location.lon),
        accuracy: state.location.accuracy != null ? Number(state.location.accuracy) : null,
        faceDataUrl: state.face.dataUrl,
        faceW: state.face.w,
        faceH: state.face.h,
        userAgent: navigator.userAgent,
      };

      // Save locally
      const records = loadRecords();
      records.unshift(record); // newest first
      try {
        saveRecords(records);
      } catch (err) {
        // localStorage can fail when too large (images). Give a clear message.
        showToast('Storage limit reached', 'Unable to save. Try retaking a smaller image or clear old records in Admin.');
        return;
      }

      // Confirmation & reset
      showToast('Attendance submitted successfully', `${record.name} • ${record.course} • ${record.date} ${record.time}`);

      // Keep location (optional), reset face to enforce fresh capture next time.
      retakeFace();
      $('attendanceForm').reset();
      updateDateTimePreview();
      updateSubmitState();

      // If admin is unlocked, refresh table immediately
      if (state.admin.unlocked) renderAdmin();
    }

    // ---------- Tabs ----------
    function showPanel(which) {
      const isStudent = which === 'student';

      $('panelStudent').classList.toggle('hidden', !isStudent);
      $('panelAdmin').classList.toggle('hidden', isStudent);

      $('tabStudent').setAttribute('aria-selected', String(isStudent));
      $('tabAdmin').setAttribute('aria-selected', String(!isStudent));

      $('tabStudent').className = isStudent
        ? 'rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-slate-900 text-white focus:outline-none focus:ring-2 focus:ring-slate-400'
        : 'rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-white text-slate-800 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-400';

      $('tabAdmin').className = !isStudent
        ? 'rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-slate-900 text-white focus:outline-none focus:ring-2 focus:ring-slate-400'
        : 'rounded-xl px-4 py-2 text-sm font-semibold ring-1 ring-slate-200 bg-white text-slate-800 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-400';

      // Stop camera if switching away
      if (!isStudent) stopCamera();

      // Auto-reveal PIN when switching to Admin
      if (!isStudent) {
        revealPin();
      }

      // Update admin view if switching to admin
      if (!isStudent && state.admin.unlocked) renderAdmin();
    }

    // ---------- Admin ----------
    function unlockAdmin() {
      const pin = $('pinInput').value.trim();
      const real = getPin();
      if (!pin) {
        $('pinMsg').textContent = 'Enter the PIN.';
        $('pinMsg').className = 'mt-2 text-xs text-slate-600';
        return;
      }
      if (pin !== real) {
        $('pinMsg').textContent = 'Incorrect PIN. Access denied.';
        $('pinMsg').className = 'mt-2 text-xs text-rose-700 font-semibold';
        showToast('Access denied', 'Incorrect PIN');
        return;
      }

      state.admin.unlocked = true;
      $('pinMsg').textContent = 'Access granted. Dashboard unlocked.';
      $('pinMsg').className = 'mt-2 text-xs text-emerald-700 font-semibold';

      $('adminLocked').classList.add('hidden');
      $('adminDashboard').classList.remove('hidden');
      renderAdmin();
      showToast('Dashboard unlocked', 'You can now view and export records.');
    }

    function lockAdmin() {
      state.admin.unlocked = false;
      $('pinInput').value = '';
      $('pinMsg').textContent = '';
      $('adminLocked').classList.remove('hidden');
      $('adminDashboard').classList.add('hidden');
      showToast('Dashboard locked', 'PIN required for access.');
    }

    function renderAdmin() {
      const tbody = $('recordsTbody');
      const empty = $('emptyAdmin');

      const q = $('searchInput').value.trim().toLowerCase();
      const records = loadRecords();
      const filtered = q
        ? records.filter(r =>
            String(r.name).toLowerCase().includes(q) ||
            String(r.matric).toLowerCase().includes(q) ||
            String(r.course).toLowerCase().includes(q)
          )
        : records;

      $('statTotal').textContent = String(records.length);
      $('statRecent').textContent = records[0] ? `${records[0].date} ${records[0].time}` : '—';

      tbody.innerHTML = '';

      if (!filtered.length) {
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');

      for (const r of filtered) {
        const tr = document.createElement('tr');
        tr.className = 'align-top';

        const dt = `${escapeHtml(r.date)} ${escapeHtml(r.time)}`;
        const lat = (typeof r.lat === 'number') ? r.lat.toFixed(6) : '—';
        const lon = (typeof r.lon === 'number') ? r.lon.toFixed(6) : '—';

        tr.innerHTML = `
          <td class="px-4 py-3 font-semibold text-slate-900">${escapeHtml(r.name)}</td>
          <td class="px-4 py-3 text-slate-700">${escapeHtml(r.matric)}</td>
          <td class="px-4 py-3 text-slate-700">${escapeHtml(r.course)}</td>
          <td class="px-4 py-3 text-slate-700 whitespace-nowrap">${dt}</td>
          <td class="px-4 py-3 text-slate-700 tabular-nums whitespace-nowrap">${lat}</td>
          <td class="px-4 py-3 text-slate-700 tabular-nums whitespace-nowrap">${lon}</td>
          <td class="px-4 py-3">
            <button data-view-face="${escapeHtml(r.id)}" class="rounded-lg bg-white px-3 py-1.5 text-xs font-semibold text-slate-800 ring-1 ring-slate-200 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-400">
              View
            </button>
          </td>
        `;

        tbody.appendChild(tr);
      }

      // Wire up view buttons (event delegation is fine, but small table so direct binding is ok)
      tbody.querySelectorAll('[data-view-face]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-view-face');
          const rec = loadRecords().find(x => x.id === id);
          if (!rec) return;
          openFaceModal(rec);
        });
      });
    }

    function clearRecords() {
      const count = loadRecords().length;
      if (!count) {
        showToast('Nothing to clear', 'No records found.');
        return;
      }
      const ok = confirm(`This will permanently remove ${count} attendance record(s) from this browser. Continue?`);
      if (!ok) return;
      saveRecords([]);
      renderAdmin();
      showToast('Records cleared', 'Local storage attendance data removed.');
    }

    function downloadPdf() {
      const records = loadRecords();
      if (!records.length) {
        showToast('No records', 'There are no attendance records to export.');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

      const pageWidth = doc.internal.pageSize.getWidth();
      const margin = 40;

      doc.setFont('helvetica', 'bold');
      doc.setFontSize(14);
      doc.text('Department of Urban and Regional Planning', margin, 50);

      doc.setFont('helvetica', 'normal');
      doc.setFontSize(11);
      doc.text('Nasarawa State University, Keffi (NSUK)', margin, 68);

      doc.setFontSize(10);
      const generated = `${formatDate(now())} ${formatTime(now())}`;
      doc.text(`Attendance Export • Generated: ${generated}`, margin, 86);

      // Table data
      const head = [['Name', 'Matric No.', 'Course Code', 'Date', 'Time', 'Latitude', 'Longitude']];
      const body = records.map(r => [
        String(r.name || ''),
        String(r.matric || ''),
        String(r.course || ''),
        String(r.date || ''),
        String(r.time || ''),
        (typeof r.lat === 'number') ? r.lat.toFixed(6) : '',
        (typeof r.lon === 'number') ? r.lon.toFixed(6) : '',
      ]);

      doc.autoTable({
        head,
        body,
        startY: 110,
        styles: { font: 'helvetica', fontSize: 9, cellPadding: 4, overflow: 'linebreak' },
        headStyles: { fillColor: [15, 27, 61], textColor: [255, 255, 255] },
        alternateRowStyles: { fillColor: [245, 247, 250] },
        margin: { left: margin, right: margin },
        tableWidth: pageWidth - margin * 2,
      });

      doc.setFontSize(9);
      doc.setTextColor(100);
      doc.text('Note: Face images are not included in the PDF export.', margin, doc.lastAutoTable.finalY + 18);

      const fileName = `NSUK_URP_Attendance_${now().toISOString().slice(0,10)}.pdf`;
      doc.save(fileName);
      showToast('PDF downloaded', fileName);
    }

    // ---------- Modals ----------
    function openHelp() {
      $('helpModal').classList.remove('hidden');
    }
    function closeHelp() {
      $('helpModal').classList.add('hidden');
    }

    function openFaceModal(rec) {
      $('faceModalImg').src = rec.faceDataUrl || '';
      $('faceModalMeta').textContent = `${rec.name} • ${rec.matric} • ${rec.course} • ${rec.date} ${rec.time}`;
      const lat = (typeof rec.lat === 'number') ? rec.lat : null;
      const lon = (typeof rec.lon === 'number') ? rec.lon : null;
      const href = (lat != null && lon != null)
        ? `https://www.google.com/maps?q=${encodeURIComponent(lat + ',' + lon)}`
        : '#';
      $('mapLink').href = href;
      $('mapLink').classList.toggle('pointer-events-none', href === '#');
      $('mapLink').classList.toggle('opacity-50', href === '#');
      $('faceModal').classList.remove('hidden');
    }
    function closeFaceModal() {
      $('faceModal').classList.add('hidden');
      $('faceModalImg').src = '';
    }

    // ---------- Lecturer tools ----------
    function revealPin() {
      const pin = getPin();
      $('pinDisplay').textContent = pin;
      $('btnCopyPin').disabled = false;
      // Removed toast to avoid annoyance on auto-reveal
    }

    async function copyPin() {
      try {
        const pin = getPin();
        await navigator.clipboard.writeText(pin);
        showToast('PIN copied', 'Copied to clipboard.');
      } catch {
        showToast('Copy failed', 'Your browser blocked clipboard access.');
      }
    }

    function resetPin() {
      const ok = confirm('Reset admin PIN? This will lock the dashboard and generate a new PIN on this device.');
      if (!ok) return;
      localStorage.removeItem(STORAGE_KEY_PIN);
      ensurePin();
      $('pinDisplay').textContent = getPin(); // Show the new PIN immediately
      $('btnCopyPin').disabled = false;
      lockAdmin();
      showToast('PIN reset', 'New system PIN generated and revealed.');
    }

    // ---------- Init ----------
    function init() {
      // Year
      $('year').textContent = String(new Date().getFullYear());

      // Ensure PIN exists (generated by system)
      ensurePin();
      // Do NOT auto-reveal on load to keep initial UI clean, but ensure display is ready
      $('pinDisplay').textContent = maskPin(getPin());

      // Default date/time preview
      updateDateTimePreview();
      setInterval(updateDateTimePreview, 1000);

      // Wire student
      $('btnGetLocation').addEventListener('click', captureLocation);
      $('btnStartCamera').addEventListener('click', startCamera);
      $('btnCaptureFace').addEventListener('click', captureFace);
      $('btnRetake').addEventListener('click', () => {
        retakeFace();
        // Optionally start camera again for convenience
        startCamera();
      });
      $('attendanceForm').addEventListener('submit', submitAttendance);

      // Validate required fields live
      ['studentName', 'matricNo', 'courseCode'].forEach(id => {
        $(id).addEventListener('input', updateSubmitState);
        $(id).addEventListener('blur', updateSubmitState);
      });

      // Wire tabs
      $('tabStudent').addEventListener('click', () => showPanel('student'));
      $('tabAdmin').addEventListener('click', () => showPanel('admin'));

      // Wire admin gate
      $('btnUnlock').addEventListener('click', unlockAdmin);
      $('pinInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') unlockAdmin();
      });

      // Admin actions
      $('btnLock').addEventListener('click', lockAdmin);
      $('btnClear').addEventListener('click', clearRecords);
      $('btnDownloadPdf').addEventListener('click', downloadPdf);
      $('searchInput').addEventListener('input', () => state.admin.unlocked && renderAdmin());

      // Lecturer tools
      // Note: Reveal button removed, auto-reveal happens in showPanel('admin')
      $('btnCopyPin').addEventListener('click', copyPin);
      $('btnResetPin').addEventListener('click', resetPin);

      // Modals
      $('btnOpenHelp').addEventListener('click', openHelp);
      $('btnCloseHelp').addEventListener('click', closeHelp);
      $('helpModal').addEventListener('click', (e) => {
        if (e.target === $('helpModal').firstElementChild) closeHelp();
      });

      $('btnCloseFace').addEventListener('click', closeFaceModal);
      $('faceModal').addEventListener('click', (e) => {
        if (e.target === $('faceModal').firstElementChild) closeFaceModal();
      });

      // Initial UI state
      updateSubmitState();

      // Inform if running in insecure context
      if (!window.isSecureContext) {
        showToast('Limited permissions', 'This page is not in a secure context (HTTPS). Location/camera may not work.');
      }

      // Prevent leaving camera running if user navigates away
      window.addEventListener('pagehide', stopCamera);
      window.addEventListener('beforeunload', stopCamera);
    }

    init();
  </script>
</body>
</html>